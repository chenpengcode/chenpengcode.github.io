<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"chenpeng.pages.dev","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="é¢å‘åˆ‡é¢ç¼–ç¨‹ (AOP) é€šè¿‡æä¾›å¦ä¸€ç§æ€è€ƒç¨‹åºç»“æ„çš„æ–¹å¼æ¥è¡¥å……é¢å‘å¯¹è±¡ç¼–ç¨‹ (OOP)ã€‚ OOP ä¸­æ¨¡å—åŒ–çš„å…³é”®å•ä½æ˜¯ç±»ï¼Œè€Œ AOP ä¸­æ¨¡å—åŒ–çš„å•ä½æ˜¯åˆ‡é¢ã€‚åˆ‡é¢æ˜¯èƒ½å¤Ÿå®ç°è·¨è¶Šå¤šç§ç±»å‹å’Œå¯¹è±¡çš„å…³æ³¨ç‚¹ï¼ˆä¾‹å¦‚äº‹åŠ¡ç®¡ç†ï¼‰çš„æ¨¡å—åŒ–ã€‚ ï¼ˆè¿™ç§å…³æ³¨ç‚¹åœ¨ AOP æ–‡çŒ®ä¸­é€šå¸¸è¢«ç§°ä¸ºâ€œæ¨ªåˆ‡â€å…³æ³¨ç‚¹ã€‚ï¼‰">
<meta property="og:type" content="article">
<meta property="og:title" content="spring-aop">
<meta property="og:url" content="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/index.html">
<meta property="og:site_name" content="é™ˆé¹çš„åšå®¢">
<meta property="og:description" content="é¢å‘åˆ‡é¢ç¼–ç¨‹ (AOP) é€šè¿‡æä¾›å¦ä¸€ç§æ€è€ƒç¨‹åºç»“æ„çš„æ–¹å¼æ¥è¡¥å……é¢å‘å¯¹è±¡ç¼–ç¨‹ (OOP)ã€‚ OOP ä¸­æ¨¡å—åŒ–çš„å…³é”®å•ä½æ˜¯ç±»ï¼Œè€Œ AOP ä¸­æ¨¡å—åŒ–çš„å•ä½æ˜¯åˆ‡é¢ã€‚åˆ‡é¢æ˜¯èƒ½å¤Ÿå®ç°è·¨è¶Šå¤šç§ç±»å‹å’Œå¯¹è±¡çš„å…³æ³¨ç‚¹ï¼ˆä¾‹å¦‚äº‹åŠ¡ç®¡ç†ï¼‰çš„æ¨¡å—åŒ–ã€‚ ï¼ˆè¿™ç§å…³æ³¨ç‚¹åœ¨ AOP æ–‡çŒ®ä¸­é€šå¸¸è¢«ç§°ä¸ºâ€œæ¨ªåˆ‡â€å…³æ³¨ç‚¹ã€‚ï¼‰">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/aop-proxy-plain-pojo-call.png">
<meta property="og:image" content="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/aop-proxy-call.png">
<meta property="article:published_time" content="2021-08-22T05:48:33.000Z">
<meta property="article:modified_time" content="2022-04-14T04:23:46.646Z">
<meta property="article:author" content="CHENPENGBLOG">
<meta property="article:tag" content="java">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/aop-proxy-plain-pojo-call.png">

<link rel="canonical" href="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>spring-aop | é™ˆé¹çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">é™ˆé¹çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ğŸ˜‰</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://chenpeng.pages.dev/2021/08/22/Java/spring/Spring-AOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="CHENPENGBLOG">
      <meta itemprop="description" content="å…¨æ ˆæèµ·æ¥ï¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é™ˆé¹çš„åšå®¢">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          spring-aop
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-08-22 13:48:33" itemprop="dateCreated datePublished" datetime="2021-08-22T13:48:33+08:00">2021-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-04-14 12:23:46" itemprop="dateModified" datetime="2022-04-14T12:23:46+08:00">2022-04-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>é¢å‘åˆ‡é¢ç¼–ç¨‹ (AOP) é€šè¿‡æä¾›å¦ä¸€ç§æ€è€ƒç¨‹åºç»“æ„çš„æ–¹å¼æ¥è¡¥å……é¢å‘å¯¹è±¡ç¼–ç¨‹ (OOP)ã€‚ OOP ä¸­æ¨¡å—åŒ–çš„å…³é”®å•ä½æ˜¯ç±»ï¼Œè€Œ AOP ä¸­æ¨¡å—åŒ–çš„å•ä½æ˜¯åˆ‡é¢ã€‚åˆ‡é¢æ˜¯èƒ½å¤Ÿå®ç°è·¨è¶Šå¤šç§ç±»å‹å’Œå¯¹è±¡çš„å…³æ³¨ç‚¹ï¼ˆä¾‹å¦‚äº‹åŠ¡ç®¡ç†ï¼‰çš„æ¨¡å—åŒ–ã€‚ ï¼ˆè¿™ç§å…³æ³¨ç‚¹åœ¨ AOP æ–‡çŒ®ä¸­é€šå¸¸è¢«ç§°ä¸ºâ€œæ¨ªåˆ‡â€å…³æ³¨ç‚¹ã€‚ï¼‰</p>
<span id="more"></span>

<p>Spring é€šè¿‡ä½¿ç”¨<code>schema-based approach</code>æˆ– <code>@AspectJ annotation style</code>, æä¾›ç¼–å†™è‡ªå®šä¹‰åˆ‡é¢çš„ç®€å•è€Œå¼ºå¤§çš„æ–¹æ³•ã€‚</p>
<p>AOP åœ¨ Spring æ¡†æ¶ä¸­ç”¨äºï¼š</p>
<ul>
<li>æä¾›å£°æ˜å¼ä¼ä¸šæœåŠ¡ã€‚æœ€é‡è¦æ˜¯å£°æ˜å¼äº‹åŠ¡ç®¡ç†ã€‚</li>
<li>è®©ç”¨æˆ·å®ç°è‡ªå®šä¹‰åˆ‡é¢ï¼Œç”¨ AOP è¡¥å……ä»–ä»¬å¯¹ OOP çš„ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="AOP-æ¦‚å¿µ"><a href="#AOP-æ¦‚å¿µ" class="headerlink" title="AOP æ¦‚å¿µ"></a>AOP æ¦‚å¿µ</h2><p>AOP æœ¯è¯­ï¼š</p>
<ul>
<li>åˆ‡é¢ <code>aspect</code>ï¼šæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ã€‚äº‹åŠ¡ç®¡ç†æ˜¯ä¼ä¸š Java åº”ç”¨ç¨‹åºä¸­å¸¸è§çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚åœ¨ Spring AOP ä¸­ï¼Œåˆ‡é¢é€šè¿‡ä½¿ç”¨å¸¸è§„ç±»(<code>schema-based approach</code>)æˆ–ä½¿ç”¨<code>@Aspect</code>æ³¨è§£(<code>@AspectJ</code> style)æ³¨è§£ çš„å¸¸è§„ç±»æ¥å®ç°çš„ã€‚</li>
<li>è¿æ¥ç‚¹<code> Join point</code>ï¼šåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ç‚¹ï¼Œä¾‹å¦‚æ–¹æ³•çš„æ‰§è¡Œæˆ–å¼‚å¸¸çš„å¤„ç†ã€‚åœ¨ Spring AOP ä¸­ï¼Œè¿æ¥ç‚¹å§‹ç»ˆä»£è¡¨æ–¹æ³•çš„æ‰§è¡Œã€‚</li>
<li>é€šçŸ¥ <code>Advice</code>ï¼šåˆ‡é¢åœ¨ç‰¹å®šçš„è¿æ¥ç‚¹å¤„é‡‡å–çš„æ“ä½œã€‚é€šçŸ¥çš„ç±»å‹åŒ…æ‹¬â€œaroundâ€ã€â€œbeforeâ€å’Œâ€œafterâ€é€šçŸ¥ã€‚è®¸å¤š AOP æ¡†æ¶ï¼ŒåŒ…æ‹¬ Springï¼Œå°†é€šçŸ¥å»ºæ¨¡ä¸ºæ‹¦æˆªå™¨ï¼Œå¹¶åœ¨è¿æ¥ç‚¹å‘¨å›´ç»´æŠ¤ä¸€ä¸ªæ‹¦æˆªå™¨é“¾ã€‚</li>
<li>åˆ‡å…¥ç‚¹ <code>Pointcut</code>ï¼šåŒ¹é…è¿æ¥ç‚¹çš„è°“è¯ã€‚ <code>Advice </code>ä¸<code>Pointcut</code>è¡¨è¾¾å¼ç›¸å…³è”ï¼Œå¹¶åœ¨ä¸åˆ‡å…¥ç‚¹åŒ¹é…çš„ä»»ä½•è¿æ¥ç‚¹å¤„è¿è¡Œï¼ˆä¾‹å¦‚ï¼Œæ‰§è¡Œå…·æœ‰ç‰¹å®šåç§°çš„æ–¹æ³•ï¼‰ã€‚ç”±åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…çš„è¿æ¥ç‚¹çš„æ¦‚å¿µæ˜¯ AOP çš„æ ¸å¿ƒï¼ŒSpring é»˜è®¤ä½¿ç”¨ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾å¼è¯­è¨€ã€‚</li>
<li>ç®€ä»‹<code>Introduction</code>ï¼šä»£è¡¨ç±»å‹å£°æ˜å…¶ä»–æ–¹æ³•æˆ–å­—æ®µã€‚ Spring AOP å…è®¸æ‚¨å‘ä»»ä½•å»ºè®®çš„å¯¹è±¡å¼•å…¥æ–°çš„æ¥å£(å’Œç›¸åº”çš„å®ç°)ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨<code>Introduction</code>ä½¿ Bean å®ç°<code>IsModified</code>æ¥å£ï¼Œä»¥ç®€åŒ–ç¼“å­˜ã€‚</li>
<li>ç›®æ ‡å¯¹è±¡ <code>Target object</code>ï¼šä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢é€šçŸ¥çš„å¯¹è±¡ï¼Œä¹Ÿç§°ä¸ºâ€œé€šçŸ¥å¯¹è±¡â€ã€‚ç”±äº Spring AOP æ˜¯ä½¿ç”¨è¿è¡Œæ—¶ä»£ç†å®ç°çš„ï¼Œå› æ­¤è¯¥å¯¹è±¡å§‹ç»ˆæ˜¯ä»£ç†å¯¹è±¡ã€‚</li>
<li>AOP ä»£ç† <code>AOP proxy</code>ï¼šç”± AOP æ¡†æ¶ä¸ºå®ç°åˆ‡é¢åå®šæ‰€åˆ›å»ºçš„å¯¹è±¡(é€šçŸ¥æ–¹æ³•æ‰§è¡Œç­‰)ã€‚åœ¨ Spring Framework ä¸­ï¼ŒAOP ä»£ç†æ˜¯ JDK åŠ¨æ€ä»£ç†æˆ– CGLIB ä»£ç†ã€‚</li>
<li>ç¼–ç»‡ <code>Weaving</code>ï¼š linking aspects with other application types or objects to create an advised object. è¿™å¯ä»¥åœ¨ç¼–è¯‘æ—¶(ä¾‹å¦‚ï¼Œä½¿ç”¨ AspectJ ç¼–è¯‘å™¨)ï¼ŒåŠ è½½æ—¶æˆ–åœ¨è¿è¡Œæ—¶å®Œæˆã€‚Spring AOP åœ¨è¿è¡Œæ—¶æ‰§è¡Œç¼–ç»‡ã€‚</li>
</ul>
<p>Spring AOP åŒ…æ‹¬ä»¥ä¸‹ç±»å‹çš„é€šçŸ¥ï¼š</p>
<ul>
<li>Before adviceï¼šåœ¨è¿æ¥ç‚¹ä¹‹å‰è¿è¡Œçš„é€šçŸ¥ï¼Œä½†æ˜¯å®ƒä¸èƒ½é˜»æ­¢æ‰§è¡Œæµç¨‹å‰è¿›åˆ°è¿æ¥ç‚¹(é™¤éå®ƒå¼•å‘å¼‚å¸¸)ã€‚</li>
<li>After returning adviceï¼šåœ¨è¿æ¥ç‚¹æ­£å¸¸å®Œæˆåè¦è¿è¡Œçš„é€šçŸ¥(ä¾‹å¦‚ï¼Œå¦‚æœæ–¹æ³•è¿”å›è€Œæ²¡æœ‰å¼•å‘å¼‚å¸¸)ã€‚</li>
<li>After throwing adviceï¼šå¦‚æœæ–¹æ³•å› æŠ›å‡ºå¼‚å¸¸è€Œé€€å‡ºï¼Œåˆ™æ‰§è¡Œå»ºè®®ã€‚</li>
<li>after (finally) adviceï¼šæ— è®ºè¿æ¥ç‚¹é€€å‡ºçš„æ–¹å¼å¦‚ä½•(æ­£å¸¸æˆ–ç‰¹æ®Šè¿”å›)ï¼Œå‡åº”æ‰§è¡Œå»ºè®®ã€‚</li>
<li>Around adviceï¼šç¯ç»•è¿æ¥ç‚¹çš„é€šçŸ¥ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€‚è¿™æ˜¯æœ€æœ‰åŠ›çš„å»ºè®®ã€‚This is the most powerful kind of advice. Around advice can perform custom behavior before and after the method invocation. It is also responsible for choosing whether to proceed to the join point or to shortcut the advised method execution by returning its own return value or throwing an exception.</li>
</ul>
<p>Around advice is the most general kind of advice. Since Spring AOP, like AspectJ, provides a full range of advice types, we recommend that you use the least powerful advice type that can implement the required behavior. For example, if you need only to update a cache with the return value of a method, you are better off implementing an after returning advice than an around advice, although an around advice can accomplish the same thing. Using the most specific advice type provides a simpler programming model with less potential for errors. For example, you do not need to invoke the <code>proceed()</code> method on the <code>JoinPoint</code> used for around advice, and, hence, you cannot fail to invoke it.</p>
<p><code>pointcut </code>åŒ¹é… <code>joinpoint </code>æ¦‚å¿µæ˜¯ AOP çš„å…³é”®ï¼Œå®ƒåŒºåˆ«äºä»…æä¾›æ‹¦æˆªçš„æ—§æŠ€æœ¯ã€‚åˆ‡å…¥ç‚¹ä½¿é€šçŸ¥èƒ½å¤Ÿç‹¬ç«‹äºé¢å‘å¯¹è±¡çš„å±‚æ¬¡ç»“æ„è€Œæˆä¸ºç›®æ ‡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†æä¾›å£°æ˜å¼äº‹åŠ¡ç®¡ç†çš„ç¯ç»•é€šçŸ¥åº”ç”¨äºä¸€ç»„è·¨è¶Šå¤šä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼ˆä¾‹å¦‚æœåŠ¡å±‚ä¸­çš„æ‰€æœ‰ä¸šåŠ¡æ“ä½œï¼‰ã€‚</p>
<h2 id="SpringAOP-èƒ½åŠ›å’Œç›®æ ‡"><a href="#SpringAOP-èƒ½åŠ›å’Œç›®æ ‡" class="headerlink" title="SpringAOP èƒ½åŠ›å’Œç›®æ ‡"></a>SpringAOP èƒ½åŠ›å’Œç›®æ ‡</h2><p>Spring AOP æ˜¯ç”¨çº¯ Java å®ç°çš„ã€‚ä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘è¿‡ç¨‹ã€‚ Spring AOP ä¸éœ€è¦æ§åˆ¶ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„ï¼Œå› æ­¤é€‚åˆåœ¨ Servlet å®¹å™¨æˆ–åº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¸­ä½¿ç”¨ã€‚</p>
<p>Spring AOP å½“å‰ä»…æ”¯æŒæ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹(å»ºè®®åœ¨ Spring Bean ä¸Šæ‰§è¡Œæ–¹æ³•)ã€‚</p>
<p>Spring AOP çš„ AOP æ–¹æ³•ç›®çš„ä¸æ˜¯æä¾›æœ€å®Œæ•´çš„ AOP å®ç°(å°½ç®¡ Spring AOP ç›¸å½“å¼ºå¤§)ã€‚ç›¸åï¼Œå…¶ç›®çš„æ˜¯åœ¨ AOP å®ç°å’Œ Spring IoC ä¹‹é—´æä¾›ç´§å¯†çš„é›†æˆï¼Œä»¥å¸®åŠ©è§£å†³ä¼ä¸šåº”ç”¨ç¨‹åºä¸­çš„å¸¸è§é—®é¢˜ã€‚</p>
<p>å› æ­¤ï¼Œé€šå¸¸å°† Spring Framework çš„ AOP åŠŸèƒ½ä¸ Spring IoC å®¹å™¨ç»“åˆä½¿ç”¨ã€‚é€šè¿‡ä½¿ç”¨å¸¸è§„ bean å®šä¹‰è¯­æ³•æ¥é…ç½®åˆ‡é¢ã€‚è¿™æ˜¯ä¸å…¶ä»– AOP å®ç°çš„å…³é”®åŒºåˆ«ã€‚</p>
<p>Spring AOP ä»æœªåŠªåŠ›ä¸ AspectJ ç«äº‰ä»¥æä¾›å…¨é¢çš„ AOP è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬è®¤ä¸ºï¼ŒåŸºäºä»£ç†çš„æ¡†æ¶(å¦‚ Spring AOP)å’Œæˆç†Ÿçš„æ¡†æ¶(å¦‚ AspectJ)éƒ½æ˜¯æœ‰ä»·å€¼çš„ï¼Œå®ƒä»¬æ˜¯äº’è¡¥çš„ï¼Œè€Œä¸æ˜¯ç«äº‰ã€‚ Spring å°† AspectsJ æ— ç¼é›†æˆäº† Spring AOP å’Œ IoCï¼Œä»¥åœ¨åŸºäº Spring çš„ä¸€è‡´åº”ç”¨ç¨‹åºæ¶æ„ä¸­æ”¯æŒ AOP çš„æ‰€æœ‰ä½¿ç”¨ã€‚è¿™ç§é›†æˆä¸ä¼šå½±å“ Spring AOP API æˆ– AOP Alliance APIã€‚</p>
<h2 id="AOP-ä»£ç†"><a href="#AOP-ä»£ç†" class="headerlink" title="AOP ä»£ç†"></a>AOP ä»£ç†</h2><p>Spring AOP é»˜è®¤å°†æ ‡å‡† JDK åŠ¨æ€ä»£ç†ç”¨äº AOP ä»£ç†ã€‚è¿™ä½¿å¾—å¯ä»¥ä»£ç†ä»»ä½•æ¥å£(æˆ–ä¸€ç»„æ¥å£)ã€‚</p>
<p>Spring AOP ä¹Ÿå¯ä»¥ä½¿ç”¨ CGLIB ä»£ç†ã€‚è¿™å¯¹äºä»£ç†ç±»è€Œä¸æ˜¯æ¥å£æ˜¯å¿…éœ€çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸šåŠ¡å¯¹è±¡æœªå®ç°æ¥å£ï¼Œåˆ™ä½¿ç”¨ CGLIBã€‚ç”±äºå¯¹æ¥å£è€Œä¸æ˜¯å¯¹ç±»è¿›è¡Œç¼–ç¨‹æ˜¯ä¸€ç§å¥½ä¹ æƒ¯ï¼Œå› æ­¤ä¸šåŠ¡ç±»é€šå¸¸å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡æ¥å£ã€‚åœ¨æŸäº›æƒ…å†µä¸‹(å¯èƒ½æå°‘å‘ç”Ÿ)ï¼Œæ‚¨éœ€è¦é€šçŸ¥æœªåœ¨æ¥å£ä¸Šå£°æ˜çš„æ–¹æ³•ï¼Œæˆ–è€…éœ€è¦å°†ä»£ç†å¯¹è±¡ä½œä¸ºå…·ä½“ç±»å‹ä¼ é€’ç»™æ–¹æ³•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¼ºåˆ¶ä½¿ç”¨ CGLIBã€‚</p>
<h2 id="AspectJ-æ”¯æŒ"><a href="#AspectJ-æ”¯æŒ" class="headerlink" title="@AspectJ æ”¯æŒ"></a>@AspectJ æ”¯æŒ</h2><p><code>@AspectJ</code> æ˜¯ä¸€ç§å°†åˆ‡é¢å£°æ˜ä¸ºå¸¦æœ‰æ³¨è§£çš„å¸¸è§„ Java ç±»çš„æ ·å¼ã€‚  Spring ä½¿ç”¨ AspectJ æä¾›çš„ç”¨äºåˆ‡å…¥ç‚¹è§£æå’ŒåŒ¹é…çš„åº“æ¥è§£é‡Šä¸ AspectJ 5 ç›¸åŒçš„ æ³¨è§£ã€‚ä½†æ˜¯ï¼ŒAOP è¿è¡Œæ—¶ä»ç„¶æ˜¯çº¯ Spring AOPï¼Œå¹¶ä¸”ä¸ä¾èµ–äº AspectJ ç¼–è¯‘å™¨æˆ–ç¼–ç»‡å™¨ã€‚</p>
<h3 id="å¯ç”¨-AspectJ-æ”¯æŒ"><a href="#å¯ç”¨-AspectJ-æ”¯æŒ" class="headerlink" title="å¯ç”¨@AspectJ æ”¯æŒ"></a>å¯ç”¨@AspectJ æ”¯æŒ</h3><p>è¦åœ¨ Spring é…ç½®ä¸­ä½¿ç”¨<code>@AspectJ</code> åˆ‡é¢ï¼Œéœ€è¦å¯ç”¨ Spring æ”¯æŒä»¥åŸºäº<code>@AspectJ</code> åˆ‡é¢é…ç½® Spring AOPï¼Œå¹¶æ ¹æ®è¿™äº›åˆ‡é¢æ˜¯å¦å»ºè®®å¯¹å®ƒä»¬è¿›è¡Œè‡ªåŠ¨ä»£ç†ã€‚é€šè¿‡è‡ªåŠ¨ä»£ç†ï¼Œæˆ‘ä»¬çš„æ„æ€æ˜¯ï¼Œå¦‚æœ Spring ç¡®å®šä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢å»ºè®®ä¸€ä¸ª beanï¼Œå®ƒä¼šè‡ªåŠ¨ä¸ºè¯¥ bean ç”Ÿæˆä¸€ä¸ªä»£ç†æ¥æ‹¦æˆªæ–¹æ³•è°ƒç”¨å¹¶ç¡®ä¿æŒ‰éœ€æ‰§è¡Œå»ºè®®ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ XML æˆ– Java æ ·å¼çš„é…ç½®æ¥å¯ç”¨<code>@AspectJ </code>æ”¯æŒã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œéƒ½éœ€è¦ç¡®ä¿ AspectJ çš„<code>aspectjweaver.jar</code>åº“ä½äºåº”ç”¨ç¨‹åºçš„ <code>Classpath</code>(ç‰ˆæœ¬ 1.8 æˆ–æ›´é«˜ç‰ˆæœ¬)ä¸Šã€‚è¯¥åº“åœ¨ <code>AspectJ </code>å‘è¡Œç‰ˆçš„<code>lib</code>ç›®å½•ä¸­æˆ–ä» Maven Central å­˜å‚¨åº“ä¸­å¯ç”¨ã€‚</p>
<h4 id="é€šè¿‡-Java-é…ç½®å¯ç”¨-AspectJ-æ”¯æŒ"><a href="#é€šè¿‡-Java-é…ç½®å¯ç”¨-AspectJ-æ”¯æŒ" class="headerlink" title="é€šè¿‡ Java é…ç½®å¯ç”¨@AspectJ æ”¯æŒ"></a>é€šè¿‡ Java é…ç½®å¯ç”¨<code>@AspectJ</code> æ”¯æŒ</h4><p>è¦ä½¿ç”¨ Java <code>@Configuration</code>å¯ç”¨@AspectJ æ”¯æŒï¼Œè¯·æ·»åŠ <code>@EnableAspectJAutoProxy</code>æ³¨è§£ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxypublic</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é€šè¿‡-XML-é…ç½®å¯ç”¨-AspectJ-æ”¯æŒ"><a href="#é€šè¿‡-XML-é…ç½®å¯ç”¨-AspectJ-æ”¯æŒ" class="headerlink" title="é€šè¿‡ XML é…ç½®å¯ç”¨@AspectJ æ”¯æŒ"></a>é€šè¿‡ XML é…ç½®å¯ç”¨<code>@AspectJ</code> æ”¯æŒ</h4><p>è¦é€šè¿‡åŸºäº XML çš„é…ç½®å¯ç”¨<code>@AspectJ </code>æ”¯æŒï¼Œè¯·ä½¿ç”¨<code>aop:aspectj-autoproxy</code>å…ƒç´ ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;aop:aspectj-autoproxy/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="å£°æ˜ä¸€ä¸ªåˆ‡é¢"><a href="#å£°æ˜ä¸€ä¸ªåˆ‡é¢" class="headerlink" title="å£°æ˜ä¸€ä¸ªåˆ‡é¢"></a>å£°æ˜ä¸€ä¸ªåˆ‡é¢</h3><p>å¯ç”¨<code>@AspectJ </code>æ”¯æŒåï¼ŒSpring ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨<code>@AspectJ </code>åˆ‡é¢(å…·æœ‰<code>@Aspect</code>æ³¨è§£)çš„ç±»å®šä¹‰çš„ä»»ä½• beanï¼Œå¹¶ç”¨äºé…ç½® Spring AOPã€‚</p>
<p>ç¬¬ä¸€ä¸ªç¤ºä¾‹æ˜¾ç¤ºäº†åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­çš„å¸¸è§„ bean å®šä¹‰ï¼Œè¯¥å®šä¹‰æŒ‡å‘å…·æœ‰<code>@Aspect</code>æ³¨è§£çš„ bean ç±»ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.xyz.NotVeryUsefulAspect&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configure properties of the aspect here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒä¸ªç¤ºä¾‹æ˜¾ç¤ºäº†<code>NotVeryUsefulAspect</code>ç±»å®šä¹‰ï¼Œè¯¥ç±»å®šä¹‰å¸¦æœ‰<code>org.aspectj.lang.annotation.Aspect</code>æ³¨è§£ï¼›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xyz;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotVeryUsefulAspect</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ‡é¢(å¸¦æœ‰<code>@Aspect</code>æ³¨è§£ çš„ç±»)å¯ä»¥å…·æœ‰æ–¹æ³•å’Œå­—æ®µï¼Œä¸ä»»ä½•å…¶ä»–ç±»ç›¸åŒã€‚å®ƒä»¬è¿˜å¯ä»¥åŒ…å«åˆ‡å…¥ç‚¹ï¼Œé€šçŸ¥å’Œå¼•å…¥(ç±»å‹é—´)å£°æ˜ã€‚</p>
<blockquote>
<p>é€šè¿‡æ‰«æè‡ªåŠ¨æ¢æµ‹åˆ‡é¢</p>
<p>å¯ä»¥å°†åˆ‡é¢ç±»æ³¨å†Œä¸º Spring XML é…ç½®ä¸­çš„å¸¸è§„ beanï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Classpath æ‰«ææ¥è‡ªåŠ¨æ£€æµ‹å®ƒä»¬-ä¸å…¶ä»–ä»»ä½• Springç®¡ç† çš„ bean ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œ<code>@Aspect</code>æ³¨è§£ä¸è¶³ä»¥åœ¨ Classpath ä¸­è¿›è¡Œè‡ªåŠ¨æ£€æµ‹ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦æ·»åŠ ä¸€ä¸ªå•ç‹¬çš„<code>@Component</code>æ³¨è§£(æˆ–è€…ï¼ŒæŒ‰ç…§ Spring çš„ç»„ä»¶æ‰«æç¨‹åºçš„è§„åˆ™ï¼Œæœ‰æ¡ä»¶çš„è‡ªå®šä¹‰æ„é€ å‹æ³¨è§£)ã€‚</p>
</blockquote>
<blockquote>
<p>ä½¿ç”¨åˆ‡é¢å¯¹å¦ä¸€ä¸ªåˆ‡é¢è¿›è¡Œé€šçŸ¥?</p>
<p>åœ¨ Spring AOP ä¸­ï¼Œåˆ‡é¢æœ¬èº«ä¸èƒ½æˆä¸ºå…¶ä»–åˆ‡é¢çš„é€šçŸ¥ç›®æ ‡ã€‚ç±»ä¸Šçš„<code>@Aspect</code>æ³¨è§£ å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ªåˆ‡é¢ï¼Œå› æ­¤å°†å…¶ä»è‡ªåŠ¨ä»£ç†ä¸­æ’é™¤ã€‚</p>
</blockquote>
<h3 id="å£°æ˜åˆ‡å…¥ç‚¹"><a href="#å£°æ˜åˆ‡å…¥ç‚¹" class="headerlink" title="å£°æ˜åˆ‡å…¥ç‚¹"></a>å£°æ˜åˆ‡å…¥ç‚¹</h3><p><code>pointcut</code>ç¡®å®šäº†æ„Ÿå…´è¶£çš„<code>join point</code>ï¼Œä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶æ‰§è¡Œé€šçŸ¥çš„æ—¶é—´ã€‚ Spring AOP ä»…æ”¯æŒ Spring Bean çš„æ–¹æ³•æ‰§è¡Œ<code>join point</code>ï¼Œå› æ­¤å¯ä»¥å°†<code>pointcut</code>è§†ä¸ºä¸ Spring Bean ä¸Šçš„æ–¹æ³•æ‰§è¡Œç›¸åŒ¹é…ã€‚<code>pointcut</code>å£°æ˜ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªåŒ…å«åç§°å’Œä»»ä½•å‚æ•°çš„ç­¾åï¼Œä»¥åŠä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¯¥åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç¡®å®šæ–¹æ³•æ‰§è¡Œã€‚åœ¨ AOP çš„@AspectJ æ³¨è§£æ ·å¼ä¸­ï¼Œå¸¸è§„æ–¹æ³•å®šä¹‰æä¾›äº†åˆ‡å…¥ç‚¹ç­¾åã€‚å¹¶é€šè¿‡ä½¿ç”¨<code>@Pointcut</code>æ³¨è§£ æŒ‡ç¤ºåˆ‡å…¥ç‚¹è¡¨è¾¾å¼(ç”¨ä½œåˆ‡å…¥ç‚¹ç­¾åçš„æ–¹æ³•å¿…é¡»å…·æœ‰<code>void</code>è¿”å›ç±»å‹)ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹å®šä¹‰ä¸€ä¸ªåä¸º<code>anyOldTransfer</code>çš„åˆ‡å…¥ç‚¹ï¼Œè¯¥åˆ‡å…¥ç‚¹ä¸ä»»ä½•åä¸º<code>transfer</code>çš„æ–¹æ³•çš„æ‰§è¡Œç›¸åŒ¹é…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* transfer(..))&quot;)</span> <span class="comment">// the pointcut expressionprivate</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">anyOldTransfer</span><span class="params">()</span> </span>&#123;&#125;<span class="comment">// the pointcut signature</span></span><br></pre></td></tr></table></figure>

<p>å½¢æˆ<code>@Pointcut</code>æ³¨è§£çš„å€¼çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¸¸è§„çš„ AspectJ 5 åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚</p>
<h4 id="æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦"><a href="#æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦" class="headerlink" title="æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦"></a>æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦</h4><p>Spring AOP æ”¯æŒä»¥ä¸‹åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„ AspectJ åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦(PCD)ï¼š</p>
<ul>
<li><code>execution</code>ï¼šç”¨äºåŒ¹é…æ–¹æ³•æ‰§è¡Œçš„è¿æ¥ç‚¹ã€‚è¿™æ˜¯ä½¿ç”¨ Spring AOP æ—¶è¦ä½¿ç”¨çš„ä¸»è¦åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦ã€‚</li>
<li><code>within</code>ï¼šå°†åŒ¹é…é™åˆ¶ä¸ºæŸäº›ç±»å‹å†…çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶ï¼Œåœ¨åŒ¹é…ç±»å‹å†…å£°æ˜çš„æ–¹æ³•çš„æ‰§è¡Œ)ã€‚</li>
<li><code>this</code>ï¼šå°†åŒ¹é…é™åˆ¶ä¸ºè¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶æ–¹æ³•çš„æ‰§è¡Œ)ï¼Œå…¶ä¸­ bean å¼•ç”¨(Spring AOP ä»£ç†)æ˜¯ç»™å®šç±»å‹çš„å®ä¾‹ã€‚</li>
<li><code>target</code>ï¼šå°†ç›®æ ‡å¯¹è±¡(æ­£åœ¨ä»£ç†çš„åº”ç”¨ç¨‹åºå¯¹è±¡)æ˜¯ç»™å®šç±»å‹çš„å®ä¾‹çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶ï¼Œæ–¹æ³•çš„æ‰§è¡Œ)é™åˆ¶ä¸ºåŒ¹é…ã€‚</li>
<li><code>args</code>ï¼šå°†å‚æ•°é™åˆ¶ä¸ºç»™å®šç±»å‹çš„å®ä¾‹çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶æ–¹æ³•çš„æ‰§è¡Œ)é™åˆ¶åŒ¹é…ã€‚</li>
<li><code>@target</code>ï¼šå°†æ‰§è¡Œå¯¹è±¡çš„ç±»å…·æœ‰ç»™å®šç±»å‹çš„æ³¨è§£çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶ï¼Œæ–¹æ³•çš„æ‰§è¡Œ)é™åˆ¶ä¸ºåŒ¹é…ã€‚</li>
<li><code>@args</code>ï¼šé™åˆ¶åŒ¹é…çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶æ–¹æ³•çš„æ‰§è¡Œ)ï¼Œå…¶ä¸­ä¼ é€’çš„å®é™…å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹å…·æœ‰ç»™å®šç±»å‹çš„ æ³¨è§£ã€‚</li>
<li><code>@within</code>ï¼šå°†åŒ¹é…é™åˆ¶ä¸ºå…·æœ‰ç»™å®šæ³¨è§£çš„ç±»å‹å†…çš„è¿æ¥ç‚¹(ä½¿ç”¨ Spring AOP æ—¶ï¼Œä½¿ç”¨ç»™å®šæ³¨è§£çš„ç±»å‹ä¸­å£°æ˜çš„æ–¹æ³•çš„æ‰§è¡Œ)ã€‚</li>
<li><code>@annotation</code>ï¼šå°†åŒ¹é…é™åˆ¶ä¸ºè¿æ¥ç‚¹çš„ä¸»é¢˜(åœ¨ Spring AOP ä¸­æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•)å…·æœ‰ç»™å®šæ³¨è§£çš„è¿æ¥ç‚¹ã€‚</li>
</ul>
<h4 id="ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼"><a href="#ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼" class="headerlink" title="ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼"></a>ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼</h4><p>æ‚¨å¯ä»¥ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œå¯ä»¥ä½¿ç”¨<code>&amp;&amp;,</code> <code>||</code>å’Œ<code>!</code>è¿›è¡Œç»„åˆã€‚æ‚¨ä¹Ÿå¯ä»¥æŒ‰åç§°å¼•ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸‰ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(public * *(..))&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">anyPublicOperation</span><span class="params">()</span> </span>&#123;&#125; (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut(&quot;within(com.xyz.someapp.trading..*)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inTrading</span><span class="params">()</span> </span>&#123;&#125; (<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut(&quot;anyPublicOperation() &amp;&amp; inTrading()&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tradingOperation</span><span class="params">()</span> </span>&#123;&#125; (<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>(1)</strong> <code>anyPublicOperation</code>åŒ¹é…æ–¹æ³•æ‰§è¡Œè”æ¥ç‚¹æ˜¯å¦è¡¨ç¤ºä»»ä½•å…¬å…±æ–¹æ³•çš„æ‰§è¡Œã€‚</li>
<li><strong>(2)</strong> <code>inTrading</code>å¦‚æœ Transaction æ¨¡å—ä¸­æœ‰æ–¹æ³•æ‰§è¡Œåˆ™åŒ¹é…ã€‚</li>
<li><strong>(3)</strong> <code>tradingOperation</code>åŒ¹é…ï¼Œå¦‚æœæ–¹æ³•æ‰§è¡Œä»£è¡¨ Transaction æ¨¡å—ä¸­çš„ä»»ä½•å…¬å…±æ–¹æ³•ã€‚</li>
</ul>
<p>æœ€ä½³å®è·µæ˜¯ä»è¾ƒå°çš„å‘½åç»„ä»¶ä¸­æ„å»ºæ›´å¤æ‚çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œå¦‚å…ˆå‰æ‰€ç¤ºã€‚æŒ‰åç§°å¼•ç”¨åˆ‡å…¥ç‚¹æ—¶ï¼Œå°†åº”ç”¨å¸¸è§„çš„ Java å¯è§æ€§è§„åˆ™(æ‚¨å¯ä»¥çœ‹åˆ°ç›¸åŒç±»å‹çš„ç§æœ‰åˆ‡å…¥ç‚¹ï¼Œå±‚æ¬¡ç»“æ„ä¸­å—ä¿æŠ¤çš„åˆ‡å…¥ç‚¹ï¼Œä»»ä½•ä½ç½®çš„å…¬å…±åˆ‡å…¥ç‚¹ï¼Œç­‰ç­‰)ã€‚å¯è§æ€§ä¸å½±å“åˆ‡å…¥ç‚¹åŒ¹é…ã€‚</p>
<h4 id="å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰"><a href="#å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰" class="headerlink" title="å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰"></a>å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰</h4><p>åœ¨ä½¿ç”¨ä¼ä¸šåº”ç”¨ç¨‹åºæ—¶ï¼Œå¼€å‘äººå‘˜é€šå¸¸å¸Œæœ›ä»å¤šä¸ªåˆ‡é¢å¼•ç”¨åº”ç”¨ç¨‹åºçš„æ¨¡å—å’Œç‰¹å®šçš„æ“ä½œé›†ã€‚æˆ‘ä»¬å»ºè®®ä¸ºæ­¤å®šä¹‰ä¸€ä¸ªâ€œ SystemArchitectureâ€åˆ‡é¢ï¼Œä»¥æ•è·å¸¸è§çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚è¿™æ ·çš„åˆ‡é¢é€šå¸¸ç±»ä¼¼äºä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.someapp;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemArchitecture</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A join point is in the web layer if the method is defined</span></span><br><span class="line"><span class="comment">    * in a type in the com.xyz.someapp.web package or any sub-package</span></span><br><span class="line"><span class="comment">    * under that.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.web..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inWebLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A join point is in the service layer if the method is defined</span></span><br><span class="line"><span class="comment">    * in a type in the com.xyz.someapp.service package or any sub-package</span></span><br><span class="line"><span class="comment">    * under that.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.service..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inServiceLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A join point is in the data access layer if the method is defined</span></span><br><span class="line"><span class="comment">    * in a type in the com.xyz.someapp.dao package or any sub-package</span></span><br><span class="line"><span class="comment">    * under that.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.dao..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inDataAccessLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A business service is the execution of any method defined on a service</span></span><br><span class="line"><span class="comment">    * interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">    * &quot;service&quot; package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * If you group service interfaces by functional area (for example,</span></span><br><span class="line"><span class="comment">    * in packages com.xyz.someapp.abc.service and com.xyz.someapp.def.service) then</span></span><br><span class="line"><span class="comment">    * the pointcut expression &quot;execution(* com.xyz.someapp..service.*.*(..))&quot;</span></span><br><span class="line"><span class="comment">    * could be used instead.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Alternatively, you can write the expression using the &#x27;bean&#x27;</span></span><br><span class="line"><span class="comment">    * PCD, like so &quot;bean(*Service)&quot;. (This assumes that you have</span></span><br><span class="line"><span class="comment">    * named your Spring service beans in a consistent fashion.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.xyz.someapp..service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">businessService</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A data access operation is the execution of any method defined on a</span></span><br><span class="line"><span class="comment">    * dao interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">    * &quot;dao&quot; package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.xyz.someapp.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dataAccessOperation</span><span class="params">()</span> </span>&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥åœ¨éœ€è¦åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ä»»ä½•åœ°æ–¹å¼•ç”¨åœ¨è¿™æ ·çš„åˆ‡é¢ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹ã€‚ä¾‹å¦‚ï¼Œè¦ä½¿æœåŠ¡å±‚å…·æœ‰äº‹åŠ¡æ€§ï¼Œæ‚¨å¯ä»¥ç¼–å†™ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span></span></span><br><span class="line"><span class="tag">        <span class="attr">pointcut</span>=<span class="string">&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">advice-ref</span>=<span class="string">&quot;tx-advice&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;tx-advice&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h4><p>Spring AOP ç”¨æˆ·å¯èƒ½æœ€å¸¸ä½¿ç”¨<code>execution</code>åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦ã€‚æ‰§è¡Œè¡¨è¾¾å¼çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern)</span><br><span class="line">                throws-pattern?)</span><br></pre></td></tr></table></figure>

<p>é™¤äº†è¿”å›ç±»å‹æ¨¡å¼(å‰é¢çš„ä»£ç æ®µä¸­ä¸º<code>ret-type-pattern</code>)ï¼Œname-patternå’Œparam-patternä»¥å¤–çš„æ‰€æœ‰å…¶ä»–éƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚è¿”å›ç±»å‹æ¨¡å¼ç¡®å®šè¯¥æ–¹æ³•çš„è¿”å›ç±»å‹å¿…é¡»æ˜¯ä»€ä¹ˆæ‰èƒ½ä½¿è¿æ¥ç‚¹åŒ¹é…ï¼Œ <code>*</code>æœ€å¸¸ç”¨ä½œè¿”å›ç±»å‹æ¨¡å¼ï¼ŒåŒ¹é…ä»»ä½•è¿”å›ç±»å‹ã€‚ä»…å½“æ–¹æ³•è¿”å›ç»™å®šç±»å‹æ—¶ï¼Œå®Œå…¨åˆæ ¼çš„ç±»å‹åç§°æ‰åŒ¹é…ã€‚name-patternä¸æ–¹æ³•åç§°åŒ¹é…ã€‚æ‚¨å¯ä»¥å°†<code>*</code>é€šé…ç¬¦ç”¨ä½œåç§°æ¨¡å¼çš„å…¨éƒ¨æˆ–ä¸€éƒ¨åˆ†ã€‚å¦‚æœæŒ‡å®šäº†å£°æ˜ç±»å‹æ¨¡å¼ï¼Œè¯·åœ¨å…¶æœ«å°¾æ·»åŠ <code>.</code>å¹¶å°†å…¶è¿æ¥åˆ°åç§°æ¨¡å¼ç»„ä»¶ã€‚param-patternç¨å¾®å¤æ‚ä¸€äº›ï¼š<code>()</code>åŒ¹é…ä¸å¸¦å‚æ•°çš„æ–¹æ³•ï¼Œè€Œ<code>(..)</code>åŒ¹é…ä»»æ„æ•°é‡(é›¶ä¸ªæˆ–å¤šä¸ª)çš„å‚æ•°ã€‚ <code>(*)</code>æ¨¡å¼ä¸é‡‡ç”¨ä»»ä½•ç±»å‹çš„ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•åŒ¹é…ã€‚ <code>(*,String)</code>ä¸é‡‡ç”¨ä¸¤ä¸ªå‚æ•°çš„æ–¹æ³•åŒ¹é…ã€‚ç¬¬ä¸€ä¸ªå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œè€Œç¬¬äºŒä¸ªå¿…é¡»æ˜¯<code>String</code>ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€äº›å¸¸ç”¨çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š</p>
<ul>
<li>ä»»ä½•å…¬å…±æ–¹æ³•çš„æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> * *(..))</span><br></pre></td></tr></table></figure>

<ul>
<li>åç§°ä»¥<code>set</code>å¼€å¤´çš„ä»»ä½•æ–¹æ³•çš„æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* set*(..))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AccountService</code>æ¥å£å®šä¹‰çš„ä»»ä½•æ–¹æ³•çš„æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* com.xyz.service.AccountService.*(..))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>è½¯ä»¶åŒ…ä¸­å®šä¹‰çš„ä»»ä½•æ–¹æ³•çš„æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* com.xyz.service.*.*(..))</span><br></pre></td></tr></table></figure>

<ul>
<li>æœåŠ¡åŒ…æˆ–å…¶å­åŒ…ä¹‹ä¸€ä¸­å®šä¹‰çš„ä»»ä½•æ–¹æ³•çš„æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* com.xyz.service..*.*(..))</span><br></pre></td></tr></table></figure>

<ul>
<li>æœåŠ¡åŒ…ä¸­çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">within(com.xyz.service.*)</span><br></pre></td></tr></table></figure>

<ul>
<li>æœåŠ¡åŒ…æˆ–å…¶å­åŒ…ä¹‹ä¸€ä¸­çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">within(com.xyz.service..*)</span><br></pre></td></tr></table></figure>

<ul>
<li>ä»£ç†å®ç°<code>AccountService</code>æ¥å£çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>(com.xyz.service.AccountService)</span><br></pre></td></tr></table></figure>

<ul>
<li>ç›®æ ‡å¯¹è±¡å®ç°<code>AccountService</code>æ¥å£çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target(com.xyz.service.AccountService)</span><br></pre></td></tr></table></figure>

<ul>
<li>ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°ä¸”è¿è¡Œæ—¶ä¼ é€’çš„å‚æ•°ä¸º<code>Serializable</code>çš„è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ˜¯æ–¹æ³•æ‰§è¡Œ)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">args(java.io.Serializable)</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œæ­¤ç¤ºä¾‹ä¸­ç»™å‡ºçš„åˆ‡å…¥ç‚¹ä¸åŒäº<code>execution(* *(java.io.Serializable))</code>ã€‚å¦‚æœåœ¨è¿è¡Œæ—¶ä¼ é€’çš„å‚æ•°ä¸º<code>Serializable</code>ï¼Œåˆ™ args ç‰ˆæœ¬åŒ¹é…ï¼Œå¦‚æœæ–¹æ³•ç­¾åå£°æ˜å•ä¸ªç±»å‹ä¸º<code>Serializable</code>çš„å‚æ•°ï¼Œåˆ™æ‰§è¡Œç‰ˆæœ¬åŒ¹é…ã€‚</p>
<ul>
<li>ç›®æ ‡å¯¹è±¡å¸¦æœ‰<code>@Transactional</code>æ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@target(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ç›®æ ‡å¯¹è±¡çš„å£°æ˜ç±»å‹å…·æœ‰<code>@Transactional</code>æ³¨è§£ çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ˜¯æ–¹æ³•æ‰§è¡Œ)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@within(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œæ–¹æ³•å¸¦æœ‰<code>@Transactional</code>æ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ˜¯æ–¹æ³•æ‰§è¡Œ)ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@annotation(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°ä¸”ä¼ é€’çš„å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹å…·æœ‰<code>@Classified</code>æ³¨è§£ çš„è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ˜¯æ–¹æ³•æ‰§è¡Œ)ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@args(com.xyz.security.Classified)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åä¸º<code>tradeService</code>çš„ Spring bean ä¸Šçš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ‰§è¡Œæ–¹æ³•)ï¼š</li>
</ul>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bean(tradeService)</span><br></pre></td></tr></table></figure>

<ul>
<li>Spring Bean ä¸Šå…·æœ‰ä¸é€šé…ç¬¦è¡¨è¾¾å¼<code>*Service</code>åŒ¹é…çš„åç§°çš„ä»»ä½•è¿æ¥ç‚¹(ä»…åœ¨ Spring AOP ä¸­æ˜¯æ–¹æ³•æ‰§è¡Œ)ï¼š</li>
</ul>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bean(*Service)</span><br></pre></td></tr></table></figure>

<h4 id="ç¼–å†™å¥½çš„åˆ‡å…¥ç‚¹"><a href="#ç¼–å†™å¥½çš„åˆ‡å…¥ç‚¹" class="headerlink" title="ç¼–å†™å¥½çš„åˆ‡å…¥ç‚¹"></a>ç¼–å†™å¥½çš„åˆ‡å…¥ç‚¹</h4><p>åœ¨ç¼–è¯‘æœŸé—´ï¼ŒAspectJ å¤„ç†åˆ‡å…¥ç‚¹ä»¥ä¼˜åŒ–åŒ¹é…æ€§èƒ½ã€‚æ£€æŸ¥ä»£ç å¹¶ç¡®å®šæ¯ä¸ªè¿æ¥ç‚¹æ˜¯å¦(é™æ€æˆ–åŠ¨æ€)åŒ¹é…ç»™å®šçš„åˆ‡å…¥ç‚¹æ˜¯ä¸€ä¸ªæ˜‚è´µçš„è¿‡ç¨‹ã€‚ (åŠ¨æ€åŒ¹é…æ„å‘³ç€æ— æ³•ä»é™æ€åˆ†æä¸­å®Œå…¨ç¡®å®šåŒ¹é…ï¼Œå¹¶ä¸”åœ¨ä»£ç ä¸­è¿›è¡Œæµ‹è¯•ä»¥ç¡®å®šåœ¨è¿è¡Œä»£ç æ—¶æ˜¯å¦å­˜åœ¨å®é™…åŒ¹é…)ã€‚é¦–æ¬¡é‡åˆ°åˆ‡å…¥ç‚¹å£°æ˜æ—¶ï¼ŒAspectJ å°†å…¶é‡å†™ä¸ºåŒ¹é…è¿‡ç¨‹çš„æœ€ä½³å½¢å¼ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸåŸºæœ¬ä¸Šï¼Œåˆ‡å…¥ç‚¹ä»¥ DNF(æå–èŒƒå¼)é‡å†™ï¼Œå¹¶ä¸”å¯¹åˆ‡å…¥ç‚¹çš„ç»„ä»¶è¿›è¡Œæ’åºï¼Œä»¥ä¾¿é¦–å…ˆæ£€æŸ¥é‚£äº›è¾ƒä¾¿å®œçš„ç»„ä»¶ã€‚è¿™æ„å‘³ç€æ‚¨ä¸å¿…æ‹…å¿ƒç†è§£å„ç§åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦çš„æ€§èƒ½ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åˆ‡å…¥ç‚¹å£°æ˜ä¸­ä»¥ä»»ä½• Sequences æä¾›å®ƒä»¬ã€‚</p>
<p>ä½†æ˜¯ï¼ŒAspectJ åªèƒ½ä½¿ç”¨æ‰€å‘Šè¯‰çš„å†…å®¹ã€‚ä¸ºäº†è·å¾—æœ€ä½³çš„åŒ¹é…æ€§èƒ½ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä»–ä»¬è¯•å›¾è¾¾åˆ°çš„ç›®æ ‡ï¼Œå¹¶åœ¨å®šä¹‰ä¸­å°½å¯èƒ½ç¼©å°åŒ¹é…çš„æœç´¢ç©ºé—´ã€‚ç°æœ‰çš„æŒ‡ç¤ºç¬¦è‡ªç„¶åˆ†ä¸ºä¸‰ç±»ä¹‹ä¸€ï¼šåŒç±»ï¼Œä½œç”¨åŸŸå’Œä¸Šä¸‹æ–‡ï¼š</p>
<ul>
<li>äº²åˆ‡çš„æŒ‡ç¤ºè€…é€‰æ‹©ä¸€ç§ç‰¹å®šçš„è¿æ¥ç‚¹ï¼š<code>execution</code>ï¼Œ<code>get</code>ï¼Œ<code>set</code>ï¼Œ<code>call</code>å’Œ<code>handler</code>ã€‚</li>
<li>ä½œç”¨åŸŸæŒ‡å®šè€…é€‰æ‹©ä¸€ç»„æ„Ÿå…´è¶£çš„è¿æ¥ç‚¹(å¯èƒ½æ˜¯å¤šç§)ï¼š<code>within</code>å’Œ<code>withincode</code></li>
<li>ä¸Šä¸‹æ–‡æŒ‡ç¤ºç¬¦æ ¹æ®ä»¥ä¸‹ä¸Šä¸‹æ–‡è¿›è¡ŒåŒ¹é…(å¹¶å¯é€‰åœ°ç»‘å®š)ï¼š<code>this</code>ï¼Œ<code>target</code>å’Œ<code>@annotation</code></li>
</ul>
<p>ç¼–å†™æ­£ç¡®çš„åˆ‡å…¥ç‚¹è‡³å°‘åº”åŒ…æ‹¬å‰ä¸¤ç§ç±»å‹(ç§ç±»å’Œä½œç”¨åŸŸ)ã€‚æ‚¨å¯ä»¥åŒ…æ‹¬ä¸Šä¸‹æ–‡æŒ‡ç¤ºç¬¦ä»¥æ ¹æ®è¿æ¥ç‚¹ä¸Šä¸‹æ–‡è¿›è¡ŒåŒ¹é…ï¼Œä¹Ÿå¯ä»¥ç»‘å®šè¯¥ä¸Šä¸‹æ–‡ä»¥åœ¨å»ºè®®ä¸­ä½¿ç”¨ã€‚ä»…æä¾›åŒç±»çš„æ ‡è¯†ç¬¦æˆ–ä»…æä¾›ä¸Šä¸‹æ–‡çš„æ ‡è¯†ç¬¦æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ç”±äºé¢å¤–çš„å¤„ç†å’Œåˆ†æï¼Œå¯èƒ½ä¼šå½±å“ç¼–ç»‡æ€§èƒ½(ä½¿ç”¨çš„æ—¶é—´å’Œå†…å­˜)ã€‚èŒƒå›´æŒ‡å®šè€…çš„åŒ¹é…éå¸¸å¿«ï¼Œä½¿ç”¨å®ƒä»¬çš„ä½¿ç”¨æ„å‘³ç€ AspectJ å¯ä»¥éå¸¸è¿…é€Ÿåœ°æ¶ˆé™¤ä¸åº”è¿›ä¸€æ­¥å¤„ç†çš„è¿æ¥ç‚¹ç»„ã€‚ä¸€ä¸ªå¥½çš„åˆ‡å…¥ç‚¹åº”è¯¥å§‹ç»ˆåŒ…æ‹¬ä¸€ä¸ªåˆ‡å…¥ç‚¹ã€‚</p>
<h3 id="å£°æ˜é€šçŸ¥"><a href="#å£°æ˜é€šçŸ¥" class="headerlink" title="å£°æ˜é€šçŸ¥"></a>å£°æ˜é€šçŸ¥</h3><p>Advice ä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç›¸å…³è”ï¼Œå¹¶åœ¨ä¸åˆ‡å…¥ç‚¹åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œä¹‹å‰ã€ä¹‹åæˆ–å‘¨å›´è¿è¡Œã€‚åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å¯ä»¥æ˜¯å¯¹å‘½ååˆ‡å…¥ç‚¹çš„ç®€å•å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å°±åœ°å£°æ˜çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚</p>
<h4 id="Before-Advice"><a href="#Before-Advice" class="headerlink" title="Before Advice"></a>Before Advice</h4><p>å¯ä»¥ä½¿ç”¨<code>@Before</code>æ³¨è§£ åœ¨åˆ‡é¢ä¸­åœ¨å»ºè®®ä¹‹å‰å£°æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨å°±åœ°åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œåˆ™å¯ä»¥å°†å‰é¢çš„ç¤ºä¾‹é‡å†™ä¸ºä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="After-Returning-Advice"><a href="#After-Returning-Advice" class="headerlink" title="After Returning Advice"></a>After Returning Advice</h4><p>å½“åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œæ­£å¸¸è¿”å›æ—¶ï¼Œè¿è¡Œ<code>After Returning Advice</code>ã€‚å¯ä»¥ä½¿ç”¨<code>@AfterReturning</code>æ³¨è§£è¿›è¡Œå£°æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰æ—¶éœ€è¦åœ¨é€šçŸ¥æ­£æ–‡ä¸­è®¿é—®è¿”å›çš„å®é™…å€¼ã€‚å¯ä»¥ä½¿ç”¨<code>@AfterReturning</code>çš„å½¢å¼ç»‘å®šè¿”å›å€¼ä»¥è·å–è¯¥è®¿é—®æƒé™ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(</span></span><br><span class="line"><span class="meta">        pointcut=&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;,</span></span><br><span class="line"><span class="meta">        returning=&quot;retVal&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">(Object retVal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>returning</code>å±æ€§ä¸­ä½¿ç”¨çš„åç§°å¿…é¡»ä¸ advice æ–¹æ³•ä¸­çš„å‚æ•°åç§°ç›¸å¯¹åº”ã€‚å½“æ–¹æ³•æ‰§è¡Œè¿”å›æ—¶ï¼Œè¯¥è¿”å›å€¼å°†ä½œä¸ºç›¸åº”çš„å‚æ•°å€¼ä¼ é€’åˆ°é€šçŸ¥æ–¹æ³•ã€‚ <code>returning</code>å­å¥è¿˜å°†åŒ¹é…ä»…é™åˆ¶ä¸ºè¿”å›æŒ‡å®šç±»å‹å€¼(åœ¨è¿™ç§æƒ…å†µä¸‹ä¸º<code>Object</code>ï¼Œè¯¥å€¼ä¸ä»»ä½•è¿”å›å€¼åŒ¹é…)çš„é‚£äº›æ–¹æ³•æ‰§è¡Œã€‚</p>
<h4 id="After-Throwing-Advice"><a href="#After-Throwing-Advice" class="headerlink" title="After Throwing Advice"></a>After Throwing Advice</h4><p>å½“åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œé€šè¿‡æŠ›å‡ºå¼‚å¸¸é€€å‡ºæ—¶ï¼ŒAfter Throwing Adviceè¿è¡Œã€‚å¯ä»¥ä½¿ç”¨<code>@AfterThrowing</code>æ³¨è§£è¿›è¡Œå£°æ˜ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterThrowingExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRecoveryActions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸Œæœ›é€šçŸ¥ä»…åœ¨å¼•å‘ç»™å®šç±»å‹çš„å¼‚å¸¸æ—¶æ‰è¿è¡Œï¼Œå¹¶ä¸”è¿˜éœ€è¦è®¿é—®é€šçŸ¥æ­£æ–‡ä¸­çš„å¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨<code>throwing</code>å±æ€§æ¥é™åˆ¶åŒ¹é…(å¦‚æœéœ€è¦)(å¦åˆ™ï¼Œè¯·ä½¿ç”¨<code>Throwable</code>ä½œä¸ºå¼‚å¸¸ç±»å‹)ï¼Œå¹¶å°†æŠ›å‡ºçš„å¼‚å¸¸ç»‘å®šåˆ° advice å‚æ•°ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.AfterThrowing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterThrowingExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(</span></span><br><span class="line"><span class="meta">        pointcut=<span class="meta-string">&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;</span>,</span></span><br><span class="line"><span class="meta">        throwing=<span class="meta-string">&quot;ex&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> void doRecoveryActions(DataAccessException ex) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>throwing</code>å±æ€§ä¸­ä½¿ç”¨çš„åç§°å¿…é¡»ä¸ advice æ–¹æ³•ä¸­çš„å‚æ•°åç§°ç›¸å¯¹åº”ã€‚å½“é€šè¿‡æŠ›å‡ºå¼‚å¸¸é€€å‡ºæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè¯¥å¼‚å¸¸å°†ä½œä¸ºç›¸åº”çš„å‚æ•°å€¼ä¼ é€’ç»™é€šçŸ¥æ–¹æ³•ã€‚ <code>throwing</code>å­å¥è¿˜å°†åŒ¹é…ä»…é™åˆ¶ä¸ºæŠ›å‡ºæŒ‡å®šç±»å‹(åœ¨æœ¬ä¾‹ä¸­ä¸º<code>DataAccessException</code>)çš„å¼‚å¸¸çš„æ–¹æ³•æ‰§è¡Œã€‚</p>
<h4 id="After-Finally-Advice"><a href="#After-Finally-Advice" class="headerlink" title="After (Finally) Advice"></a>After (Finally) Advice</h4><p>å½“åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œé€€å‡ºæ—¶ï¼ŒAfter (Finally) Adviceè¿è¡Œã€‚é€šè¿‡ä½¿ç”¨<code>@After</code>æ³¨è§£è¿›è¡Œå£°æ˜ã€‚ä¹‹åå¿…é¡»å‡†å¤‡å¤„ç†æ­£å¸¸å’Œå¼‚å¸¸è¿”å›æ¡ä»¶çš„å»ºè®®ã€‚å®ƒé€šå¸¸ç”¨äºé‡Šæ”¾èµ„æºå’Œç±»ä¼¼ç›®çš„ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†æœ€ç»ˆå»ºè®®åçš„ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterFinallyExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doReleaseLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Around-Advice"><a href="#Around-Advice" class="headerlink" title="Around Advice"></a>Around Advice</h4><p>Around Adviceâ€œç¯ç»•â€åŒ¹é…æ–¹æ³•çš„æ‰§è¡Œã€‚å®ƒæœ‰æœºä¼šåœ¨æ–¹æ³•è¿è¡Œä¹‹å‰å’Œä¹‹åè¿›è¡Œå·¥ä½œï¼Œå¹¶ç¡®å®šæ–¹æ³•ä½•æ—¶ã€å¦‚ä½•ã€ç”šè‡³æ˜¯å¦çœŸæ­£å¼€å§‹è¿è¡Œã€‚å¦‚æœæ‚¨éœ€è¦ä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œå¯åŠ¨å’Œåœæ­¢è®¡æ—¶å™¨ï¼‰åœ¨æ–¹æ³•æ‰§è¡Œå‰åå…±äº«çŠ¶æ€ï¼Œåˆ™é€šå¸¸ä½¿ç”¨ç¯ç»•é€šçŸ¥ã€‚å§‹ç»ˆä½¿ç”¨æ»¡è¶³æ‚¨è¦æ±‚çš„æœ€ä¸å¼ºå¤§çš„é€šçŸ¥å½¢å¼ï¼ˆå³ï¼Œå¦‚æœ before é€šçŸ¥å¯ä»¥ï¼Œè¯·ä¸è¦ä½¿ç”¨ around é€šçŸ¥ï¼‰ã€‚ã€‚</p>
<p>å‘¨å›´çš„å»ºè®®é€šè¿‡ä½¿ç”¨<code>@Around</code>æ³¨è§£ æ¥å£°æ˜ã€‚å’¨è¯¢æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º<code>ProceedingJoinPoint</code>ç±»å‹ã€‚åœ¨å»ºè®®çš„æ­£æ–‡ä¸­ï¼Œåœ¨<code>ProceedingJoinPoint</code>ä¸Šè°ƒç”¨<code>proceed()</code>ä¼šä½¿åº•å±‚æ–¹æ³•æ‰§è¡Œã€‚ <code>proceed</code>æ–¹æ³•ä¹Ÿå¯ä»¥ä¼ å…¥<code>Object[]</code>ã€‚æ•°ç»„ä¸­çš„å€¼ç”¨ä½œæ–¹æ³•æ‰§è¡Œæ—¶çš„å‚æ•°ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨å‘¨å›´å»ºè®®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// start stopwatch</span></span><br><span class="line">        Object retVal = pjp.proceed();</span><br><span class="line">        <span class="comment">// stop stopwatch</span></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Around Adviceè¿”å›çš„å€¼æ˜¯è¯¥æ–¹æ³•çš„è°ƒç”¨è€…çœ‹åˆ°çš„è¿”å›å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç®€å•çš„ç¼“å­˜åˆ‡é¢æœ‰ä¸€ä¸ªå€¼ï¼Œåˆ™å¯ä»¥ä»ç¼“å­˜ä¸­è¿”å›ä¸€ä¸ªå€¼ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨<code>proceed()</code>ã€‚è¯·æ³¨æ„ï¼Œ<code>proceed</code>å¯èƒ½åœ¨å‘¨å›´å»ºè®®çš„æ­£æ–‡ä¸­è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¤šæ¬¡æˆ–å®Œå…¨ä¸è¢«è°ƒç”¨ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åˆæ³•çš„ã€‚</p>
<h4 id="Advice-Parameters"><a href="#Advice-Parameters" class="headerlink" title="Advice Parameters"></a>Advice Parameters</h4><p>Spring æä¾›äº†å®Œå…¨ç±»å‹åŒ–çš„å»ºè®®ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨å»ºè®®ç­¾åä¸­å£°æ˜æ‰€éœ€çš„å‚æ•°(å¦‚æˆ‘ä»¬å…ˆå‰åœ¨è¿”å›å’ŒæŠ›å‡ºç¤ºä¾‹ä¸­æ‰€è§)ï¼Œè€Œä¸æ˜¯ä¸€ç›´ä½¿ç”¨<code>Object[]</code>æ•°ç»„ã€‚æˆ‘ä»¬å°†åœ¨æœ¬èŠ‚çš„åé¢éƒ¨åˆ†ä»‹ç»å¦‚ä½•ä½¿å‚æ•°å’Œå…¶ä»–ä¸Šä¸‹æ–‡å€¼å¯ç”¨äºå»ºè®®ä¸»ä½“ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ç¼–å†™é€šç”¨å»ºè®®ï¼Œä»¥äº†è§£è¯¥å»ºè®®å½“å‰å»ºè®®çš„æ–¹æ³•ã€‚</p>
<h5 id="è®¿é—®å½“å‰çš„-JoinPoint"><a href="#è®¿é—®å½“å‰çš„-JoinPoint" class="headerlink" title="è®¿é—®å½“å‰çš„ JoinPoint"></a>è®¿é—®å½“å‰çš„ JoinPoint</h5><p>ä»»ä½•é€šçŸ¥æ–¹æ³•éƒ½å¯ä»¥å°†ç±»å‹<code>org.aspectj.lang.JoinPoint</code>çš„å‚æ•°å£°æ˜ä¸ºç¬¬ä¸€ä¸ªå‚æ•°(è¯·æ³¨æ„ï¼Œåœ¨å‘¨å›´çš„é€šçŸ¥ä¸­å¿…é¡»å£°æ˜ç±»å‹<code>JoinPoint</code>çš„å­ç±»<code>ProceedingJoinPoint</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚<code>JoinPoint</code>æ¥å£æä¾›äº†è®¸å¤šæœ‰ç”¨çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>getArgs()</code>ï¼šè¿”å›æ–¹æ³•å‚æ•°ã€‚</li>
<li><code>getThis()</code>ï¼šè¿”å›ä»£ç†å¯¹è±¡ã€‚</li>
<li><code>getTarget()</code>ï¼šè¿”å›ç›®æ ‡å¯¹è±¡ã€‚</li>
<li><code>getSignature()</code>ï¼šè¿”å›å»ºè®®ä½¿ç”¨çš„æ–¹æ³•çš„æè¿°ã€‚</li>
<li><code>toString()</code>ï¼šæ‰“å°æœ‰å…³æ‰€å»ºè®®æ–¹æ³•çš„æœ‰ç”¨æè¿°ã€‚</li>
</ul>
<h5 id="å°†å‚æ•°ä¼ é€’ç»™Advice"><a href="#å°†å‚æ•°ä¼ é€’ç»™Advice" class="headerlink" title="å°†å‚æ•°ä¼ é€’ç»™Advice"></a>å°†å‚æ•°ä¼ é€’ç»™Advice</h5><p>æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ç»‘å®šè¿”å›çš„å€¼æˆ–å¼‚å¸¸å€¼(åœ¨è¿”å›ä¹‹åå’Œå¼•å‘å»ºè®®ä¹‹åä½¿ç”¨)ã€‚è¦ä½¿å‚æ•°å€¼å¯ç”¨äºå»ºè®®æ­£æ–‡ï¼Œå¯ä»¥ä½¿ç”¨<code>args</code>çš„ç»‘å®šå½¢å¼ã€‚å¦‚æœåœ¨ args è¡¨è¾¾å¼ä¸­ä½¿ç”¨å‚æ•°åç§°ä»£æ›¿ç±»å‹åç§°ï¼Œåˆ™åœ¨è°ƒç”¨å»ºè®®æ—¶ä¼šå°†ç›¸åº”å‚æ•°çš„å€¼ä½œä¸ºå‚æ•°å€¼ä¼ é€’ã€‚ä¸€ä¸ªä¾‹å­åº”è¯¥ä½¿è¿™ä¸€ç‚¹æ›´æ¸…æ¥šã€‚å‡è®¾æ‚¨è¦å»ºè®®æ‰§è¡Œä»¥<code>Account</code>å¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„ DAO æ“ä½œï¼Œå¹¶ä¸”æ‚¨éœ€è¦è®¿é—®å»ºè®®æ­£æ–‡ä¸­çš„å¸æˆ·ã€‚æ‚¨å¯ä»¥ç¼–å†™ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„<code>args(account,..)</code>éƒ¨åˆ†æœ‰ä¸¤ä¸ªä½œç”¨ã€‚é¦–å…ˆï¼Œå®ƒå°†åŒ¹é…é™åˆ¶ä¸ºä»…æ–¹æ³•é‡‡ç”¨è‡³å°‘ä¸€ä¸ªå‚æ•°å¹¶ä¸”ä¼ é€’ç»™è¯¥å‚æ•°çš„å‚æ•°æ˜¯<code>Account</code>çš„å®ä¾‹çš„æ–¹æ³•æ‰§è¡Œã€‚å…¶æ¬¡ï¼Œå®ƒé€šè¿‡<code>account</code>å‚æ•°ä½¿å®é™…çš„<code>Account</code>å¯¹è±¡å¯ç”¨äºå»ºè®®ã€‚</p>
<p>ç¼–å†™æ­¤æ–‡ä»¶çš„å¦ä¸€ç§æ–¹æ³•æ˜¯å£°æ˜ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œå½“åˆ‡å…¥ç‚¹<code>Account</code>å¯¹è±¡å€¼ä¸è¿æ¥ç‚¹åŒ¹é…æ—¶ï¼Œè¯¥åˆ‡å…¥ç‚¹â€œæä¾›â€ï¼Œç„¶åä»å»ºè®®ä¸­å¼•ç”¨å‘½ååˆ‡å…¥ç‚¹ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">accountDataAccessOperation</span><span class="params">(Account account)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before(&quot;accountDataAccessOperation(account)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç†å¯¹è±¡(<code>this</code>)ï¼Œç›®æ ‡å¯¹è±¡(<code>target</code>)å’Œ æ³¨è§£(<code>@within</code>ï¼Œ<code>@target</code>ï¼Œ<code>@annotation</code>å’Œ<code>@args</code>)éƒ½å¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼ç»‘å®šã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•åŒ¹é…ä½¿ç”¨<code>@Auditable</code>æ³¨è§£æ³¨è§£ çš„æ–¹æ³•çš„æ‰§è¡Œå¹¶æå–å®¡æ ¸ä»£ç ï¼š</p>
<p>è¿™ä¸¤ä¸ªç¤ºä¾‹ä¸­çš„ç¬¬ä¸€ä¸ªæ˜¾ç¤ºäº†<code>@Auditable</code>æ³¨è§£çš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Auditable &#123;</span><br><span class="line">    <span class="function">AuditCode <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªç¤ºä¾‹ä¸­çš„ç¬¬äºŒä¸ªç¤ºä¾‹æ˜¾ç¤ºä¸<code>@Auditable</code>æ–¹æ³•çš„æ‰§è¡Œç›¸åŒ¹é…çš„å»ºè®®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(Auditable auditable)</span> </span>&#123;</span><br><span class="line">    AuditCode code = auditable.value();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å»ºè®®å‚æ•°å’Œæ³›å‹"><a href="#å»ºè®®å‚æ•°å’Œæ³›å‹" class="headerlink" title="å»ºè®®å‚æ•°å’Œæ³›å‹"></a>å»ºè®®å‚æ•°å’Œæ³›å‹</h5><p>Spring AOP å¯ä»¥å¤„ç†ç±»å£°æ˜å’Œæ–¹æ³•å‚æ•°ä¸­ä½¿ç”¨çš„æ³›å‹ã€‚å‡è®¾æ‚¨å…·æœ‰å¦‚ä¸‹é€šç”¨ç±»å‹ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Sample</span>&lt;<span class="title">T</span>&gt; &#123;    <span class="function"><span class="keyword">void</span> <span class="title">sampleGenericMethod</span>(<span class="params">T param</span>)</span>;    <span class="function"><span class="keyword">void</span> <span class="title">sampleGenericCollectionMethod</span>(<span class="params">Collection&lt;T&gt; param</span>)</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é€šè¿‡åœ¨è¦æ‹¦æˆªæ–¹æ³•çš„å‚æ•°ç±»å‹ä¸­é”®å…¥ advice å‚æ•°ï¼Œå°†æ–¹æ³•ç±»å‹çš„æ‹¦æˆªé™åˆ¶ä¸ºæŸäº›å‚æ•°ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)&quot;)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeSampleMethod</span><span class="params">(MyType param)</span> </span>&#123;    <span class="comment">// Advice implementation&#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹æ³•ä¸é€‚ç”¨äºé€šç”¨é›†åˆã€‚å› æ­¤ï¼Œæ‚¨ä¸èƒ½æŒ‰ä»¥ä¸‹æ–¹å¼å®šä¹‰åˆ‡å…¥ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)&quot;)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeSampleMethod</span><span class="params">(Collection&lt;MyType&gt; param)</span> </span>&#123;    <span class="comment">// Advice implementation&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†ä½¿è¿™é¡¹å·¥ä½œæœ‰æ•ˆï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ£€æŸ¥é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹Ÿæ— æ³•å†³å®šé€šå¸¸å¦‚ä½•å¤„ç†<code>null</code>å€¼ã€‚è¦å®ç°ç±»ä¼¼ç›®çš„ï¼Œæ‚¨å¿…é¡»å°†å‚æ•°é”®å…¥<code>Collection&lt;?&gt;</code>å¹¶æ‰‹åŠ¨æ£€æŸ¥å…ƒç´ çš„ç±»å‹ã€‚</p>
<h5 id="ç¡®å®šå‚æ•°åç§°"><a href="#ç¡®å®šå‚æ•°åç§°" class="headerlink" title="ç¡®å®šå‚æ•°åç§°"></a>ç¡®å®šå‚æ•°åç§°</h5><p>é€šçŸ¥è°ƒç”¨ä¸­çš„å‚æ•°ç»‘å®šä¾èµ–äºåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„åç§°ä¸é€šçŸ¥å’Œåˆ‡å…¥ç‚¹æ–¹æ³•ç­¾åä¸­å£°æ˜çš„å‚æ•°åç§°çš„åŒ¹é…ã€‚é€šè¿‡ Java åå°„æ— æ³•è·å¾—å‚æ•°åç§°ï¼Œå› æ­¤ Spring AOP ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥æ¥ç¡®å®šå‚æ•°åç§°ï¼š</p>
<ul>
<li>å¦‚æœç”¨æˆ·å·²æ˜ç¡®æŒ‡å®šå‚æ•°åç§°ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šçš„å‚æ•°åç§°ã€‚å»ºè®®å’Œåˆ‡å…¥ç‚¹æ³¨è§£éƒ½å…·æœ‰å¯é€‰çš„<code>argNames</code>å±æ€§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥å±æ€§æ¥æŒ‡å®šå¸¦æ³¨è§£æ–¹æ³•çš„å‚æ•°åç§°ã€‚è¿™äº›å‚æ•°åç§°åœ¨è¿è¡Œæ—¶å¯ç”¨ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨<code>argNames</code>å±æ€§ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(value=&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;,        argNames=&quot;bean,auditable&quot;)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(Object bean, Auditable auditable)</span> </span>&#123;    AuditCode code = auditable.value();    <span class="comment">// ... use code and bean&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>JoinPoint</code>ï¼Œ<code>ProceedingJoinPoint</code>æˆ–<code>JoinPoint.StaticPart</code>ç±»å‹ï¼Œåˆ™å¯ä»¥ä»<code>argNames</code>å±æ€§çš„å€¼ä¸­çœç•¥å‚æ•°çš„åç§°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä¿®æ”¹å‰é¢çš„å»ºè®®ä»¥æ¥æ”¶è¿æ¥ç‚¹å¯¹è±¡ï¼Œåˆ™<code>argNames</code>å±æ€§ä¸éœ€è¦åŒ…æ‹¬å®ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(value=&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;,        argNames=&quot;bean,auditable&quot;)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(JoinPoint jp, Object bean, Auditable auditable)</span> </span>&#123;    AuditCode code = auditable.value();    <span class="comment">// ... use code, bean, and jp&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºä¸æ”¶é›†ä»»ä½•å…¶ä»–è¿æ¥ç‚¹ä¸Šä¸‹æ–‡çš„å»ºè®®å®ä¾‹ï¼Œå¯¹<code>JoinPoint</code>ï¼Œ<code>ProceedingJoinPoint</code>å’Œ<code>JoinPoint.StaticPart</code>ç±»å‹çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œç‰¹æ®Šå¤„ç†ç‰¹åˆ«æ–¹ä¾¿ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥çœç•¥<code>argNames</code>å±æ€§ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å»ºè®®æ— éœ€å£°æ˜<code>argNames</code>å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;com.xyz.lib.Pointcuts.anyPublicMethod()&quot;)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(JoinPoint jp)</span> </span>&#123;    <span class="comment">// ... use jp&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨<code>&#39;argNames&#39;</code>å±æ€§æœ‰ç‚¹ç¬¨æ‹™ï¼Œå› æ­¤ï¼Œå¦‚æœæœªæŒ‡å®š<code>&#39;argNames&#39;</code>å±æ€§ï¼ŒSpring AOP å°†æŸ¥çœ‹è¯¥ç±»çš„è°ƒè¯•ä¿¡æ¯ï¼Œå¹¶å°è¯•ä»å±€éƒ¨å˜é‡è¡¨ä¸­ç¡®å®šå‚æ•°åç§°ã€‚åªè¦å·²ä½¿ç”¨è°ƒè¯•ä¿¡æ¯(è‡³å°‘<code>&#39;-g:vars&#39;</code>)ç¼–è¯‘äº†ç±»ï¼Œå°±å­˜åœ¨æ­¤ä¿¡æ¯ã€‚å¯ç”¨æ­¤æ ‡å¿—æ—¶è¿›è¡Œç¼–è¯‘çš„ç»“æœæ˜¯ï¼š(1)æ‚¨çš„ä»£ç ç¨å¾®æ˜“äºç†è§£(é€†å‘å·¥ç¨‹)ï¼Œ(2)ç±»æ–‡ä»¶çš„å¤§å°ç•¥å¤§(é€šå¸¸æ— å…³ç´§è¦)ï¼Œ(3)åˆ é™¤æœªä½¿ç”¨çš„æœ¬åœ°ä»£ç çš„ä¼˜åŒ–å˜é‡ä¸é€‚ç”¨äºæ‚¨çš„ç¼–è¯‘å™¨ã€‚æ¢å¥è¯è¯´ï¼Œé€šè¿‡å¯ç”¨è¯¥æ ‡å¿—ï¼Œæ‚¨åº”è¯¥ä¸ä¼šé‡åˆ°ä»»ä½•å›°éš¾ã€‚</li>
</ul>
<p>Note</p>
<p>å¦‚æœå³ä½¿æ²¡æœ‰è°ƒè¯•ä¿¡æ¯ï¼ŒAspectJ ç¼–è¯‘å™¨(ajc)éƒ½å·²ç¼–è¯‘@AspectJ åˆ‡é¢ï¼Œåˆ™æ— éœ€æ·»åŠ <code>argNames</code>å±æ€§ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šä¿ç•™æ‰€éœ€çš„ä¿¡æ¯ã€‚</p>
<ul>
<li>å¦‚æœåœ¨æ²¡æœ‰å¿…è¦è°ƒè¯•ä¿¡æ¯çš„æƒ…å†µä¸‹ç¼–è¯‘äº†ä»£ç ï¼ŒSpring AOP ä¼šå°è¯•æ¨æ–­ç»‘å®šå˜é‡ä¸å‚æ•°çš„é…å¯¹(ä¾‹å¦‚ï¼Œå¦‚æœåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­ä»…ç»‘å®šäº†ä¸€ä¸ªå˜é‡ï¼Œå¹¶ä¸” advice æ–¹æ³•ä»…æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œåˆ™é…å¯¹å¾ˆæ˜æ˜¾)ã€‚å¦‚æœåœ¨ç»™å®šå¯ç”¨ä¿¡æ¯çš„æƒ…å†µä¸‹å˜é‡çš„ç»‘å®šä¸æ˜ç¡®ï¼Œåˆ™ä¼šæŠ›å‡º<code>AmbiguousBindingException</code>ã€‚</li>
<li>å¦‚æœä»¥ä¸Šæ‰€æœ‰ç­–ç•¥å‡å¤±è´¥ï¼Œåˆ™æŠ›å‡º<code>IllegalArgumentException</code>ã€‚</li>
</ul>
<h5 id="å¤„ç†å‚æ•°"><a href="#å¤„ç†å‚æ•°" class="headerlink" title="å¤„ç†å‚æ•°"></a>å¤„ç†å‚æ•°</h5><p>å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•ä½¿ç”¨åœ¨ Spring AOP å’Œ AspectJ ä¸Šå§‹ç»ˆæœ‰æ•ˆçš„å‚æ•°ç¼–å†™<code>proceed</code>è°ƒç”¨ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿å»ºè®®ç­¾åæŒ‰ Sequences ç»‘å®šæ¯ä¸ªæ–¹æ³•å‚æ•°ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;execution(List&lt;Account&gt; find*(..)) &amp;&amp; &quot; +        &quot;com.xyz.myapp.SystemArchitecture.inDataAccessLayer() &amp;&amp; &quot; +        &quot;args(accountHolderNamePattern)&quot;)</span><span class="function"><span class="keyword">public</span> Object <span class="title">preProcessQueryPattern</span><span class="params">(ProceedingJoinPoint pjp,        String accountHolderNamePattern)</span> <span class="keyword">throws</span> Throwable </span>&#123;    String newPattern = preProcess(accountHolderNamePattern);    <span class="keyword">return</span> pjp.proceed(<span class="keyword">new</span> Object[] &#123;newPattern&#125;);&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ— è®ºå¦‚ä½•éƒ½è¦è¿›è¡Œæ­¤ç»‘å®š(å¦‚ä¸Šä¾‹æ‰€ç¤º)ã€‚</p>
<h4 id="Advice-Ordering"><a href="#Advice-Ordering" class="headerlink" title="Advice Ordering"></a>Advice Ordering</h4><p>å½“å¤šæ¡å»ºè®®éƒ½å¸Œæœ›åœ¨åŒä¸€è¿æ¥ç‚¹ä¸Šè¿è¡Œæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ Spring AOP éµå¾ªä¸ AspectJ ç›¸åŒçš„ä¼˜å…ˆçº§è§„åˆ™æ¥ç¡®å®šå»ºè®®æ‰§è¡Œçš„ Sequencesã€‚ä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®é¦–å…ˆâ€œåœ¨é€”ä¸­â€è¿è¡Œ(å› æ­¤ï¼Œç»™å®šä¸¤æ¡ä¼˜å…ˆå»ºè®®ï¼Œåˆ™ä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®é¦–å…ˆè¿è¡Œ)ã€‚ä»è¿æ¥ç‚¹â€œå‡ºè·¯â€ä¸­ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®å°†æœ€åè¿è¡Œ(å› æ­¤ï¼Œç»™å®šä¸¤æ¡åç½®é€šçŸ¥ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®å°†ç¬¬äºŒæ¬¡è¿è¡Œ)ã€‚</p>
<p>å½“åœ¨ä¸åŒåˆ‡é¢å®šä¹‰çš„ä¸¤æ¡å»ºè®®éƒ½éœ€è¦åœ¨åŒä¸€è¿æ¥ç‚¹ä¸Šè¿è¡Œæ—¶ï¼Œé™¤éå¦è¡ŒæŒ‡å®šï¼Œå¦åˆ™æ‰§è¡Œ Sequences æ˜¯ä¸ç¡®å®šçš„ã€‚æ‚¨å¯ä»¥é€šè¿‡æŒ‡å®šä¼˜å…ˆçº§æ¥æ§åˆ¶æ‰§è¡Œ Sequencesã€‚é€šè¿‡åœ¨ Aspect ç±»ä¸­å®ç°<code>org.springframework.core.Ordered</code>æ¥å£æˆ–ä½¿ç”¨<code>Order</code>æ³¨è§£å¯¹å…¶è¿›è¡Œ æ³¨è§£ï¼Œå¯ä»¥é€šè¿‡æ™®é€šçš„ Spring æ–¹æ³•æ¥å®Œæˆã€‚ç»™å®šä¸¤ä¸ªåˆ‡é¢ï¼Œä»<code>Ordered.getValue()</code>è¿”å›è¾ƒä½å€¼(æˆ–æ³¨è§£å€¼)çš„åˆ‡é¢å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚</p>
<p>å½“åœ¨ç›¸åŒåˆ‡é¢å®šä¹‰çš„ä¸¤æ¡å»ºè®®éƒ½éœ€è¦åœ¨åŒä¸€è¿æ¥ç‚¹ä¸Šè¿è¡Œæ—¶ï¼Œå…¶ Sequences æ˜¯æœªå®šä¹‰çš„(å› ä¸ºæ— æ³•é€šè¿‡åå°„æ¥è·å– javac ç¼–è¯‘ç±»çš„å£°æ˜ Sequences)ã€‚è€ƒè™‘å°†è¿™äº›å»ºè®®æ–¹æ³•æŠ˜å æˆæ¯ä¸ªåˆ‡é¢ç±»ä¸­æ¯ä¸ªè¿æ¥ç‚¹çš„ä¸€ä¸ªå»ºè®®æ–¹æ³•ï¼Œæˆ–å°†å»ºè®®é‡æ„ä¸ºå•ç‹¬çš„åˆ‡é¢ç±»ï¼Œæ‚¨å¯ä»¥åœ¨åˆ‡é¢çº§åˆ«è¿›è¡Œ Orderã€‚</p>
<h3 id="Introductions"><a href="#Introductions" class="headerlink" title="Introductions"></a>Introductions</h3><p>ç®€ä»‹(åœ¨ AspectJ ä¸­ç§°ä¸ºç±»å‹é—´å£°æ˜)ä½¿åˆ‡é¢å¯ä»¥å£°æ˜å»ºè®®å¯¹è±¡å®ç°ç»™å®šçš„æ¥å£ï¼Œå¹¶ä»£è¡¨é‚£äº›å¯¹è±¡æä¾›è¯¥æ¥å£çš„å®ç°ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨<code>@DeclareParents</code>æ³¨è§£ è¿›è¡Œä»‹ç»ã€‚æ­¤æ³¨è§£ç”¨äºå£°æ˜åŒ¹é…ç±»å‹å…·æœ‰æ–°çš„çˆ¶ä»£(å› æ­¤è€Œå¾—å)ã€‚ä¾‹å¦‚ï¼Œåœ¨ç»™å®šåä¸º<code>UsageTracked</code>çš„æ¥å£å’Œè¯¥æ¥å£åä¸º<code>DefaultUsageTracked</code>çš„å®ç°çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸‹åˆ‡é¢å£°æ˜æœåŠ¡æ¥å£çš„æ‰€æœ‰å®ç°è€…ä¹Ÿéƒ½å®ç°<code>UsageTracked</code>æ¥å£(ä¾‹å¦‚ï¼Œé€šè¿‡ JMX å…¬å¼€ç»Ÿè®¡ä¿¡æ¯)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspectpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">UsageTracking</span> </span>&#123;    <span class="meta">@DeclareParents(value=&quot;com.xzy.myapp.service.*+&quot;, defaultImpl=DefaultUsageTracked.class)</span>    <span class="keyword">public</span> <span class="keyword">static</span> UsageTracked mixin;    <span class="meta">@Before(&quot;com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)&quot;)</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordUsage</span><span class="params">(UsageTracked usageTracked)</span> </span>&#123;        usageTracked.incrementUseCount();    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¦å®ç°çš„æ¥å£ç”±å¸¦æ³¨è§£çš„å­—æ®µçš„ç±»å‹ç¡®å®šã€‚ <code>@DeclareParents</code>æ³¨è§£çš„<code>value</code>å±æ€§æ˜¯ AspectJ ç±»å‹çš„æ¨¡å¼ã€‚ä»»ä½•åŒ¹é…ç±»å‹çš„ bean éƒ½å®ç°<code>UsageTracked</code>æ¥å£ã€‚è¯·æ³¨æ„ï¼Œåœ¨å‰é¢ç¤ºä¾‹çš„å»ºè®®ä¸­ï¼ŒæœåŠ¡ Bean å¯ä»¥ç›´æ¥ç”¨ä½œ<code>UsageTracked</code>æ¥å£çš„å®ç°ã€‚å¦‚æœä»¥ç¼–ç¨‹æ–¹å¼è®¿é—® beanï¼Œåˆ™åº”ç¼–å†™ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsageTracked usageTracked = (UsageTracked) context.getBean(<span class="string">&quot;myService&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹"><a href="#åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹" class="headerlink" title="åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹"></a>åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹</h4><p>Note</p>
<p>è¿™æ˜¯ä¸€ä¸ªé«˜çº§ä¸»é¢˜ã€‚å¦‚æœæ‚¨åˆšå¼€å§‹ä½¿ç”¨ AOPï¼Œåˆ™å¯ä»¥æ”¾å¿ƒåœ°è·³è¿‡å®ƒï¼Œç›´åˆ°ä»¥åã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­æ¯ä¸ªåˆ‡é¢éƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚ AspectJ å°†æ­¤ç§°ä¸ºå•ä¾‹å®ä¾‹åŒ–æ¨¡å‹ã€‚å¯ä»¥ä½¿ç”¨å¤‡ç”¨ç”Ÿå‘½å‘¨æœŸæ¥å®šä¹‰åˆ‡é¢ã€‚ Spring æ”¯æŒ AspectJ çš„<code>perthis</code>å’Œ<code>pertarget</code>å®ä¾‹åŒ–æ¨¡å‹(å½“å‰ä¸æ”¯æŒ<code>percflow, percflowbelow,</code>å’Œ<code>pertypewithin</code>)ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡åœ¨<code>@Aspect</code>æ³¨è§£ä¸­æŒ‡å®š<code>perthis</code>å­å¥æ¥å£°æ˜<code>perthis</code>åˆ‡é¢ã€‚è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect(&quot;perthis(com.xyz.myapp.SystemArchitecture.businessService())&quot;)</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspect</span> </span>&#123;    <span class="keyword">private</span> <span class="keyword">int</span> someState;    <span class="meta">@Before(com.xyz.myapp.SystemArchitecture.businessService())</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordServiceUsage</span><span class="params">()</span> </span>&#123;        <span class="comment">// ...    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>&#39;perthis&#39;</code>å­å¥çš„ä½œç”¨æ˜¯ä¸ºæ¯ä¸ªæ‰§è¡Œä¸šåŠ¡æœåŠ¡çš„å”¯ä¸€æœåŠ¡å¯¹è±¡(æ¯ä¸ªä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…çš„è”æ¥ç‚¹ç»‘å®šåˆ°â€œ thisâ€çš„å”¯ä¸€å¯¹è±¡)åˆ›å»ºä¸€ä¸ªåˆ‡é¢å®ä¾‹ã€‚åˆ‡é¢å®ä¾‹æ˜¯åœ¨æœåŠ¡å¯¹è±¡ä¸Šé¦–æ¬¡è°ƒç”¨æ–¹æ³•æ—¶åˆ›å»ºçš„ã€‚å½“æœåŠ¡å¯¹è±¡è¶…å‡ºèŒƒå›´æ—¶ï¼Œåˆ‡é¢å°†è¶…å‡ºèŒƒå›´ã€‚åœ¨åˆ›å»ºåˆ‡é¢å®ä¾‹ä¹‹å‰ï¼Œå…¶ä¸­çš„ä»»ä½•å»ºè®®éƒ½ä¸ä¼šæ‰§è¡Œã€‚åˆ›å»ºåˆ‡é¢å®ä¾‹åï¼Œåœ¨å…¶ä¸­å£°æ˜çš„å»ºè®®å°†åœ¨åŒ¹é…çš„è¿æ¥ç‚¹å¤„æ‰§è¡Œï¼Œä½†ä»…å½“æœåŠ¡å¯¹è±¡æ˜¯ä¸æ­¤åˆ‡é¢ç›¸å…³è”çš„å¯¹è±¡æ—¶æ‰æ‰§è¡Œã€‚æœ‰å…³<code>per</code>å­å¥çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ AspectJ ç¼–ç¨‹æŒ‡å—ã€‚</p>
<p><code>pertarget</code>å®ä¾‹åŒ–æ¨¡å‹çš„å·¥ä½œæ–¹å¼ä¸<code>perthis</code>å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯å®ƒä¸ºåŒ¹é…çš„è¿æ¥ç‚¹å¤„çš„æ¯ä¸ªå”¯ä¸€ç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªåˆ‡é¢å®ä¾‹ã€‚</p>
<h4 id="AOP-ç¤ºä¾‹"><a href="#AOP-ç¤ºä¾‹" class="headerlink" title="AOP ç¤ºä¾‹"></a>AOP ç¤ºä¾‹</h4><p>æ—¢ç„¶æ‚¨å·²ç»äº†è§£äº†æ‰€æœ‰ç»„æˆéƒ¨åˆ†æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚</p>
<p>æœ‰æ—¶ç”±äºå¹¶å‘é—®é¢˜(ä¾‹å¦‚ï¼Œæ­»é”å¤±è´¥è€…)ï¼Œä¸šåŠ¡æœåŠ¡çš„æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥ã€‚å¦‚æœé‡è¯•è¯¥æ“ä½œï¼Œåˆ™å¾ˆå¯èƒ½åœ¨ä¸‹ä¸€æ¬¡å°è¯•ä¸­æˆåŠŸã€‚å¯¹äºé€‚åˆåœ¨è¿™ç§æƒ…å†µä¸‹é‡è¯•çš„ä¸šåŠ¡æœåŠ¡(ä¸éœ€è¦ä¸ºè§£å†³å†²çªè€Œéœ€è¦è¿”å›ç»™ç”¨æˆ·çš„å¹‚ç­‰æ“ä½œ)ï¼Œæˆ‘ä»¬å¸Œæœ›é€æ˜åœ°é‡è¯•è¯¥æ“ä½œä»¥é¿å… Client ç«¯çœ‹åˆ°<code>PessimisticLockingFailureException</code>ã€‚è¿™é¡¹è¦æ±‚æ¸…æ¥šåœ°è·¨è¶Šäº†æœåŠ¡å±‚ä¸­çš„å¤šä¸ªæœåŠ¡ï¼Œå› æ­¤éå¸¸é€‚åˆé€šè¿‡ä¸€ä¸ªåˆ‡é¢å®æ–½ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬æƒ³é‡è¯•è¯¥æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œå‘¨å›´â€å»ºè®®ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¤šæ¬¡è°ƒç”¨<code>proceed</code>ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†åŸºæœ¬åˆ‡é¢çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspectpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentOperationExecutor</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_RETRIES = <span class="number">2</span>;    <span class="keyword">private</span> <span class="keyword">int</span> maxRetries = DEFAULT_MAX_RETRIES;    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">1</span>;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxRetries</span><span class="params">(<span class="keyword">int</span> maxRetries)</span> </span>&#123;        <span class="keyword">this</span>.maxRetries = maxRetries;    &#125;    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;        <span class="keyword">return</span> <span class="keyword">this</span>.order;    &#125;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;        <span class="keyword">this</span>.order = order;    &#125;    <span class="meta">@Around(&quot;com.xyz.myapp.SystemArchitecture.businessService()&quot;)</span>    <span class="function"><span class="keyword">public</span> Object <span class="title">doConcurrentOperation</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;        <span class="keyword">int</span> numAttempts = <span class="number">0</span>;        PessimisticLockingFailureException lockFailureException;        <span class="keyword">do</span> &#123;            numAttempts++;            <span class="keyword">try</span> &#123;                <span class="keyword">return</span> pjp.proceed();            &#125;            <span class="keyword">catch</span>(PessimisticLockingFailureException ex) &#123;                lockFailureException = ex;            &#125;        &#125; <span class="keyword">while</span>(numAttempts &lt;= <span class="keyword">this</span>.maxRetries);        <span class="keyword">throw</span> lockFailureException;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œåˆ‡é¢å®ç°äº†<code>Ordered</code>æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†åˆ‡é¢çš„ä¼˜å…ˆçº§è®¾ç½®ä¸ºé«˜äºäº‹åŠ¡å»ºè®®(æ¯æ¬¡é‡è¯•æ—¶éƒ½å¸Œæœ›æœ‰æ–°çš„äº‹åŠ¡)ã€‚ <code>maxRetries</code>å’Œ<code>order</code>å±æ€§å‡ç”± Spring é…ç½®ã€‚ä¸»è¦åŠ¨ä½œå‘ç”Ÿåœ¨<code>doConcurrentOperation</code>å‘¨å›´å»ºè®®ä¸­ã€‚è¯·æ³¨æ„ï¼Œç›®å‰ï¼Œæˆ‘ä»¬å°†é‡è¯•é€»è¾‘åº”ç”¨äºæ¯ä¸ª<code>businessService()</code>ã€‚æˆ‘ä»¬å°è¯• continueï¼Œå¦‚æœå¤±è´¥å¹¶å¤±è´¥äº†<code>PessimisticLockingFailureException</code>ï¼Œæˆ‘ä»¬å°†é‡è¯•ï¼Œé™¤éæˆ‘ä»¬ç”¨å°½äº†æ‰€æœ‰çš„é‡è¯•å°è¯•ã€‚</p>
<p>ç›¸åº”çš„ Spring é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;concurrentOperationExecutor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xyz.myapp.service.impl.ConcurrentOperationExecutor&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxRetries&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†ä¼˜åŒ–åˆ‡é¢ï¼Œä½¿å…¶ä»…é‡è¯•å¹‚ç­‰æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹<code>Idempotent</code>æ³¨è§£ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)public <span class="variable">@interface</span> Idempotent &#123;    <span class="comment">// marker annotation&#125;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨è§£æ¥æ³¨è§£æœåŠ¡æ“ä½œçš„å®ç°ã€‚åˆ‡é¢çš„æ›´æ”¹ä»…é‡è¯•å¹‚ç­‰æ“ä½œæ¶‰åŠç²¾ç®€åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä»¥ä¾¿åªæœ‰<code>@Idempotent</code>ä¸ªæ“ä½œåŒ¹é…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; &quot; +        &quot;@annotation(com.xyz.myapp.service.Idempotent)&quot;)</span><span class="function"><span class="keyword">public</span> Object <span class="title">doConcurrentOperation</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;    ...&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŸºäºæ¶æ„çš„-AOP-æ”¯æŒ"><a href="#åŸºäºæ¶æ„çš„-AOP-æ”¯æŒ" class="headerlink" title="åŸºäºæ¶æ„çš„ AOP æ”¯æŒ"></a>åŸºäºæ¶æ„çš„ AOP æ”¯æŒ</h2><p>å¦‚æœæ‚¨æ›´å–œæ¬¢åŸºäº XML çš„æ ¼å¼ï¼ŒSpring è¿˜æ”¯æŒä½¿ç”¨æ–°çš„<code>aop</code>åç§°ç©ºé—´æ ‡ç­¾å®šä¹‰åˆ‡é¢ã€‚æ”¯æŒä¸ä½¿ç”¨@AspectJ æ ·å¼æ—¶å®Œå…¨ç›¸åŒçš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å’Œå»ºè®®ç±»å‹ã€‚å› æ­¤ï¼Œåœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨æ–°è¯­æ³•ä¸Šï¼Œå¹¶ä½¿ Reader å‚è€ƒä¸Šä¸€èŠ‚(<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj">@AspectJ support</a>)ä¸­çš„è®¨è®ºï¼Œä»¥äº†è§£ç¼–å†™åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å’Œå»ºè®®å‚æ•°çš„ç»‘å®šã€‚</p>
<p>è¦ä½¿ç”¨æœ¬èŠ‚ä¸­æè¿°çš„ aop åç§°ç©ºé—´æ ‡ç­¾ï¼Œæ‚¨éœ€è¦å¯¼å…¥<code>spring-aop</code>æ¨¡å¼ï¼Œå¦‚<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#xsd-schemas">åŸºäº XML æ¨¡å¼çš„é…ç½®</a>ä¸­æ‰€è¿°ã€‚æœ‰å…³å¦‚ä½•åœ¨<code>aop</code>åç§°ç©ºé—´ä¸­å¯¼å…¥æ ‡ç­¾çš„ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#xsd-schemas-aop">AOP æ¨¡å¼</a>ã€‚</p>
<p>åœ¨æ‚¨çš„ Spring é…ç½®ä¸­ï¼Œæ‰€æœ‰åˆ‡é¢å’Œé¡¾é—®å…ƒç´ éƒ½å¿…é¡»æ”¾åœ¨<code>&lt;aop:config&gt;</code>å…ƒç´ å†…(åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡é…ç½®ä¸­å¯ä»¥æœ‰å¤šä¸ª<code>&lt;aop:config&gt;</code>å…ƒç´ )ã€‚ <code>&lt;aop:config&gt;</code>å…ƒç´ å¯ä»¥åŒ…å«åˆ‡å…¥ç‚¹ï¼Œé¡¾é—®å’Œåˆ‡é¢å…ƒç´ (è¯·æ³¨æ„ï¼Œè¿™äº›å…ƒç´ å¿…é¡»æŒ‰æ­¤ Sequences å£°æ˜)ã€‚</p>
<p>Warning</p>
<p><code>&lt;aop:config&gt;</code>æ ·å¼çš„é…ç½®å¤§é‡ä½¿ç”¨äº† Spring çš„<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-autoproxy">auto-proxying</a>æœºåˆ¶ã€‚å¦‚æœæ‚¨å·²ç»é€šè¿‡ä½¿ç”¨<code>BeanNameAutoProxyCreator</code>æˆ–ç±»ä¼¼æ–¹æ³•æ¥ä½¿ç”¨æ˜¾å¼è‡ªåŠ¨ä»£ç†ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜(ä¾‹å¦‚æœªç¼–åˆ¶å»ºè®®)ã€‚æ¨èçš„ç”¨æ³•æ¨¡å¼æ˜¯ä»…ä½¿ç”¨<code>&lt;aop:config&gt;</code>æ ·å¼æˆ–ä»…<code>AutoProxyCreator</code>æ ·å¼ï¼Œå¹¶ä¸”ä¸è¦æ··åˆä½¿ç”¨ã€‚</p>
<h3 id="å£°æ˜ä¸€ä¸ªåˆ‡é¢-1"><a href="#å£°æ˜ä¸€ä¸ªåˆ‡é¢-1" class="headerlink" title="å£°æ˜ä¸€ä¸ªåˆ‡é¢"></a>å£°æ˜ä¸€ä¸ªåˆ‡é¢</h3><p>ä½¿ç”¨æ¨¡å¼æ”¯æŒæ—¶ï¼Œåˆ‡é¢æ˜¯åœ¨ Spring åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­å®šä¹‰ä¸º Bean çš„å¸¸è§„ Java å¯¹è±¡ã€‚çŠ¶æ€å’Œè¡Œä¸ºåœ¨å¯¹è±¡çš„å­—æ®µå’Œæ–¹æ³•ä¸­æ•è·ï¼Œåˆ‡å…¥ç‚¹å’Œå»ºè®®ä¿¡æ¯åœ¨ XML ä¸­æ•è·ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨\ &lt;&gt;å…ƒç´ å£°æ˜ä¸€ä¸ªåˆ‡é¢ï¼Œå¹¶ä½¿ç”¨<code>ref</code>å±æ€§å¼•ç”¨è¯¥æ”¯æŒ beanï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>        ...    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;aBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;...&quot;</span>&gt;</span>    ...<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ”¯æŒåˆ‡é¢(åœ¨è¿™ç§æƒ…å†µä¸‹ä¸º<code>aBean</code>)çš„ bean å½“ç„¶å¯ä»¥åƒé…ç½®ä»»ä½•å…¶ä»– Spring bean ä¸€æ ·è¿›è¡Œé…ç½®å¹¶æ³¨å…¥ä¾èµ–é¡¹ã€‚</p>
<h3 id="å£°æ˜åˆ‡å…¥ç‚¹-1"><a href="#å£°æ˜åˆ‡å…¥ç‚¹-1" class="headerlink" title="å£°æ˜åˆ‡å…¥ç‚¹"></a>å£°æ˜åˆ‡å…¥ç‚¹</h3><p>æ‚¨å¯ä»¥åœ¨<code>&lt;aop:config&gt;</code>å…ƒç´ ä¸­å£°æ˜å‘½åçš„åˆ‡å…¥ç‚¹ï¼Œä»è€Œä½¿åˆ‡å…¥ç‚¹å®šä¹‰åœ¨å¤šä¸ªåˆ‡é¢å’Œé¡¾é—®ç¨‹åºä¹‹é—´å…±äº«ã€‚</p>
<p>å¯ä»¥å®šä¹‰ä»£è¡¨æœåŠ¡å±‚ä¸­ä»»ä½•ä¸šåŠ¡æœåŠ¡çš„æ‰§è¡Œçš„åˆ‡å…¥ç‚¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..))&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œåˆ‡å…¥ç‚¹è¡¨è¾¾å¼æœ¬èº«ä½¿ç”¨çš„æ˜¯ä¸<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj">@AspectJ support</a>ä¸­æ‰€è¿°çš„ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾å¼è¯­è¨€ã€‚å¦‚æœä½¿ç”¨åŸºäºæ¶æ„çš„å£°æ˜æ ·å¼ï¼Œåˆ™å¯ä»¥å¼•ç”¨åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­çš„ç±»å‹(@Aspects)ä¸­å®šä¹‰çš„å‘½ååˆ‡å…¥ç‚¹ã€‚å®šä¹‰ä¸Šè¿°åˆ‡å…¥ç‚¹çš„å¦ä¸€ç§æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;com.xyz.myapp.SystemArchitecture.businessService()&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å‡å®šæ‚¨å…·æœ‰<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-common-pointcuts">å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰</a>ä¸­æ‰€è¿°çš„<code>SystemArchitecture</code>å¤–è§‚ã€‚</p>
<p>ç„¶åï¼Œåœ¨åˆ‡é¢ä¸­å£°æ˜åˆ‡å…¥ç‚¹ä¸å£°æ˜é¡¶çº§åˆ‡å…¥ç‚¹éå¸¸ç›¸ä¼¼ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>            <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..))&quot;</span>/&gt;</span>        ...    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸@AspectJ åˆ‡é¢å‡ ä¹ç›¸åŒï¼Œä½¿ç”¨åŸºäºæ¶æ„çš„å®šä¹‰æ ·å¼å£°æ˜çš„åˆ‡å…¥ç‚¹å¯ä»¥æ”¶é›†è¿æ¥ç‚¹ä¸Šä¸‹æ–‡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹åˆ‡å…¥ç‚¹æ”¶é›†<code>this</code>å¯¹è±¡ä½œä¸ºè¿æ¥ç‚¹ä¸Šä¸‹æ–‡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å»ºè®®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>            <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..)) <span class="symbol">&amp;amp;</span><span class="symbol">&amp;amp;</span> this(service)&quot;</span>/&gt;</span>        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;businessService&quot;</span> <span class="attr">method</span>=<span class="string">&quot;monitor&quot;</span>/&gt;</span>        ...    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¿…é¡»å£°æ˜é€šçŸ¥ï¼Œä»¥é€šè¿‡åŒ…å«åŒ¹é…åç§°çš„å‚æ•°æ¥æ¥æ”¶æ”¶é›†çš„è¿æ¥ç‚¹ä¸Šä¸‹æ–‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">monitor</span>(<span class="params"><span class="built_in">Object</span> service</span>)</span> &#123;    ...&#125;</span><br></pre></td></tr></table></figure>

<p>ç»„åˆåˆ‡å…¥ç‚¹å­è¡¨è¾¾å¼æ—¶ï¼ŒXML æ–‡æ¡£ä¸­çš„<code>&amp;&amp;</code>å¾ˆå°´å°¬ï¼Œå› æ­¤å¯ä»¥åˆ†åˆ«ä½¿ç”¨<code>and</code>ï¼Œ<code>or</code>å’Œ<code>not</code>å…³é”®å­—ä»£æ›¿<code>&amp;&amp;</code>ï¼Œ<code>||</code>å’Œ<code>!</code>ã€‚ä¾‹å¦‚ï¼Œä¸Šä¸€ä¸ªåˆ‡å…¥ç‚¹å¯ä»¥æ›´å¥½åœ°ç¼–å†™å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>            <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service..(..)) and this(service)&quot;</span>/&gt;</span>        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;businessService&quot;</span> <span class="attr">method</span>=<span class="string">&quot;monitor&quot;</span>/&gt;</span>        ...    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œä»¥è¿™ç§æ–¹å¼å®šä¹‰çš„åˆ‡å…¥ç‚¹ç”±å…¶ XML <code>id</code>å¼•ç”¨ï¼Œå¹¶ä¸”ä¸èƒ½ç”¨ä½œå‘½ååˆ‡å…¥ç‚¹ä»¥å½¢æˆå¤åˆåˆ‡å…¥ç‚¹ã€‚å› æ­¤ï¼ŒåŸºäºæ¶æ„çš„å®šä¹‰æ ·å¼ä¸­çš„å‘½ååˆ‡å…¥ç‚¹æ”¯æŒæ¯”@AspectJ æ ·å¼æ‰€æä¾›çš„æ›´å—é™åˆ¶ã€‚</p>
<h3 id="å£°æ˜Advice"><a href="#å£°æ˜Advice" class="headerlink" title="å£°æ˜Advice"></a>å£°æ˜Advice</h3><p>åŸºäºæ¨¡å¼çš„ AOP æ”¯æŒä½¿ç”¨ä¸@AspectJ æ ·å¼ç›¸åŒçš„äº”ç§å»ºè®®ï¼Œå¹¶ä¸”å®ƒä»¬å…·æœ‰å®Œå…¨ç›¸åŒçš„è¯­ä¹‰ã€‚</p>
<h4 id="Before-Advice-1"><a href="#Before-Advice-1" class="headerlink" title="Before Advice"></a>Before Advice</h4><p>åœ¨è¿è¡ŒåŒ¹é…çš„æ–¹æ³•ä¹‹å‰ï¼Œå»ºè®®è¿è¡Œä¹‹å‰ã€‚ä½¿ç”¨\ &lt;&gt;å…ƒç´ åœ¨<code>&lt;aop:aspect&gt;</code>å†…éƒ¨å£°æ˜å®ƒï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;beforeExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:before</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doAccessCheck&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œ<code>dataAccessOperation</code>æ˜¯åœ¨æœ€é«˜(<code>&lt;aop:config&gt;</code>)çº§åˆ«å®šä¹‰çš„åˆ‡å…¥ç‚¹çš„<code>id</code>ã€‚è¦å®šä¹‰åˆ‡å…¥ç‚¹å†…è”ï¼Œè¯·ç”¨<code>pointcut</code>å±æ€§æ›¿æ¢<code>pointcut-ref</code>å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;beforeExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:before</span>        <span class="attr">pointcut</span>=<span class="string">&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doAccessCheck&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ­£å¦‚æˆ‘ä»¬åœ¨@AspectJ æ ·å¼çš„è®¨è®ºä¸­æ‰€æŒ‡å‡ºçš„é‚£æ ·ï¼Œä½¿ç”¨å‘½åçš„åˆ‡å…¥ç‚¹å¯ä»¥æ˜¾ç€æé«˜ä»£ç çš„å¯è¯»æ€§ã€‚</p>
<p><code>method</code>å±æ€§æ ‡è¯†æä¾›å»ºè®®æ­£æ–‡çš„æ–¹æ³•(<code>doAccessCheck</code>)ã€‚å¿…é¡»ä¸ºåŒ…å«å»ºè®®çš„ Aspect å…ƒç´ æ‰€å¼•ç”¨çš„ bean å®šä¹‰æ­¤æ–¹æ³•ã€‚åœ¨æ‰§è¡Œæ•°æ®è®¿é—®æ“ä½œ(ä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹)ä¹‹å‰ï¼Œå°†è°ƒç”¨ Aspect Bean ä¸Šçš„<code>doAccessCheck</code>æ–¹æ³•ã€‚</p>
<h4 id="è¿”å›å»ºè®®å"><a href="#è¿”å›å»ºè®®å" class="headerlink" title="è¿”å›å»ºè®®å"></a>è¿”å›å»ºè®®å</h4><p>è¿”å›çš„å»ºè®®åœ¨åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œæ­£å¸¸å®Œæˆæ—¶è¿è¡Œã€‚åœ¨<code>&lt;aop:aspect&gt;</code>å†…éƒ¨ä»¥ä¸å»ºè®®ä¹‹å‰ç›¸åŒçš„æ–¹å¼å£°æ˜å®ƒã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•å£°æ˜å®ƒï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;afterReturningExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:after-returning</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doAccessCheck&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸@AspectJ æ ·å¼ä¸€æ ·ï¼Œæ‚¨å¯ä»¥åœ¨å»ºè®®æ­£æ–‡ä¸­è·å–è¿”å›å€¼ã€‚ä¸ºæ­¤ï¼Œä½¿ç”¨ returning å±æ€§æŒ‡å®šè¿”å›å€¼åº”ä¼ é€’åˆ°çš„å‚æ•°çš„åç§°ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;afterReturningExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:after-returning</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">returning</span>=<span class="string">&quot;retVal&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doAccessCheck&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>doAccessCheck</code>æ–¹æ³•å¿…é¡»å£°æ˜ä¸€ä¸ªåä¸º<code>retVal</code>çš„å‚æ•°ã€‚è¯¥å‚æ•°çš„ç±»å‹ä»¥ä¸<code>@AfterReturning</code>ç›¸åŒçš„æ–¹å¼çº¦æŸåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å£°æ˜æ–¹æ³•ç­¾åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">doAccessCheck</span>(<span class="params"><span class="built_in">Object</span> retVal</span>)</span> &#123;...</span><br></pre></td></tr></table></figure>

<h4 id="æå‡ºå»ºè®®å"><a href="#æå‡ºå»ºè®®å" class="headerlink" title="æå‡ºå»ºè®®å"></a>æå‡ºå»ºè®®å</h4><p>æŠ›å‡ºå»ºè®®åï¼Œå½“åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œé€šè¿‡æŠ›å‡ºå¼‚å¸¸é€€å‡ºæ—¶æ‰§è¡Œå»ºè®®ã€‚é€šè¿‡ä½¿ç”¨æ·åå…ƒç´ åœ¨<code>&lt;aop:aspect&gt;</code>å†…éƒ¨å£°æ˜å®ƒï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;afterThrowingExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:after-throwing</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doRecoveryActions&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸@AspectJ æ ·å¼ä¸€æ ·ï¼Œæ‚¨å¯ä»¥åœ¨é€šçŸ¥æ­£æ–‡ä¸­è·å–å¼•å‘çš„å¼‚å¸¸ã€‚ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨ throwing å±æ€§æŒ‡å®šå¼‚å¸¸åº”ä¼ é€’åˆ°çš„å‚æ•°çš„åç§°ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;afterThrowingExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:after-throwing</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">throwing</span>=<span class="string">&quot;dataAccessEx&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doRecoveryActions&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>doRecoveryActions</code>æ–¹æ³•å¿…é¡»å£°æ˜ä¸€ä¸ªåä¸º<code>dataAccessEx</code>çš„å‚æ•°ã€‚è¯¥å‚æ•°çš„ç±»å‹ä»¥ä¸<code>@AfterThrowing</code>ç›¸åŒçš„æ–¹å¼çº¦æŸåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œæ–¹æ³•ç­¾åå¯ä»¥å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">doRecoveryActions</span>(<span class="params">DataAccessException dataAccessEx</span>)</span> &#123;...</span><br></pre></td></tr></table></figure>

<h4 id="æœ€å-å»ºè®®å"><a href="#æœ€å-å»ºè®®å" class="headerlink" title="(æœ€å)å»ºè®®å"></a>(æœ€å)å»ºè®®å</h4><p>æ— è®ºæœ€ç»ˆå¦‚ä½•æ‰§è¡ŒåŒ¹é…çš„æ–¹æ³•ï¼Œå»ºè®®(æœ€ç»ˆ)éƒ½ä¼šè¿è¡Œã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>after</code>å…ƒç´ å¯¹å…¶è¿›è¡Œå£°æ˜ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;afterFinallyExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:after</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;dataAccessOperation&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doReleaseLock&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Around-Advice-1"><a href="#Around-Advice-1" class="headerlink" title="Around Advice"></a>Around Advice</h4><p>æœ€åä¸€ç§å»ºè®®æ˜¯å›´ç»•å»ºè®®ã€‚å›´ç»•å»ºè®®åœ¨åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­â€œå›´ç»•â€è¿è¡Œã€‚å®ƒæœ‰æœºä¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰å’Œä¹‹åè¿›è¡Œå·¥ä½œï¼Œå¹¶ç¡®å®šä½•æ—¶ï¼Œå¦‚ä½•ä»¥åŠä»€è‡³æ ¹æœ¬ä¸æ‰§è¡Œè¯¥æ–¹æ³•ã€‚å‘¨å›´å»ºè®®é€šå¸¸ç”¨äºä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼(ä¾‹å¦‚ï¼Œå¯åŠ¨å’Œåœæ­¢è®¡æ—¶å™¨)åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰å’Œä¹‹åå…±äº«çŠ¶æ€ã€‚å§‹ç»ˆä½¿ç”¨æœ€ä¸å¼ºå¤§çš„å»ºè®®å½¢å¼ï¼Œä»¥æ»¡è¶³æ‚¨çš„è¦æ±‚ã€‚å¦‚æœå»ºè®®å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¯·ä¸è¦åœ¨å»ºè®®å‘¨å›´ä½¿ç”¨ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨<code>aop:around</code>å…ƒç´ åœ¨å»ºè®®å‘¨å›´è¿›è¡Œå£°æ˜ã€‚å’¨è¯¢æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º<code>ProceedingJoinPoint</code>ç±»å‹ã€‚åœ¨å»ºè®®çš„æ­£æ–‡ä¸­ï¼Œåœ¨<code>ProceedingJoinPoint</code>ä¸Šè°ƒç”¨<code>proceed()</code>ä¼šå¯¼è‡´åŸºç¡€æ–¹æ³•æ‰§è¡Œã€‚ <code>proceed</code>æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨<code>Object[]</code>è°ƒç”¨ã€‚æ•°ç»„ä¸­çš„å€¼ç”¨ä½œæ–¹æ³•æ‰§è¡Œæ—¶çš„å‚æ•°ã€‚æœ‰å…³ä½¿ç”¨<code>Object[]</code>è°ƒç”¨<code>proceed</code>çš„è¯´æ˜ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj-around-advice">Around Advice</a>ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•åœ¨ XML ä¸­å›´ç»•å»ºè®®è¿›è¡Œå£°æ˜ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;aroundExample&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;aBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:around</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;businessService&quot;</span>        <span class="attr">method</span>=<span class="string">&quot;doBasicProfiling&quot;</span>/&gt;</span>    ...<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>doBasicProfiling</code>é€šçŸ¥çš„å®ç°å¯ä»¥ä¸@AspectJ ç¤ºä¾‹å®Œå…¨ç›¸åŒ(å½“ç„¶è¦å‡å» æ³¨è§£)ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;    <span class="comment">// start stopwatch    Object retVal = pjp.proceed();    // stop stopwatch    return retVal;&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Advice-Parameters-1"><a href="#Advice-Parameters-1" class="headerlink" title="Advice Parameters"></a>Advice Parameters</h4><p>åŸºäºæ¶æ„çš„å£°æ˜æ ·å¼ä»¥ä¸@AspectJ æ”¯æŒç›¸åŒçš„æ–¹å¼æ”¯æŒå®Œå…¨ç±»å‹çš„å»ºè®®ï¼Œå³é€šè¿‡åç§°ä¸å»ºè®®æ–¹æ³•å‚æ•°åŒ¹é…åˆ‡å…¥ç‚¹å‚æ•°ã€‚æœ‰å…³è¯¦æƒ…ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj-advice-params">Advice Parameters</a>ã€‚å¦‚æœæ‚¨å¸Œæœ›æ˜¾å¼æŒ‡å®šå»ºè®®æ–¹æ³•çš„å‚æ•°åç§°(ä¸ä¾èµ–äºå…ˆå‰æè¿°çš„æ£€æµ‹ç­–ç•¥)ï¼Œåˆ™å¯ä»¥é€šè¿‡ä½¿ç”¨å»ºè®®å…ƒç´ çš„<code>arg-names</code>å±æ€§æ¥å®ç°ï¼Œè¯¥å±æ€§ä¸<code>argNames</code>å±æ€§çš„å¤„ç†æ–¹å¼ç›¸åŒã€‚å»ºè®® æ³¨è§£(å¦‚<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj-advice-params-names">ç¡®å®šå‚æ•°åç§°</a>ä¸­æ‰€è¿°)ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•åœ¨ XML ä¸­æŒ‡å®šå‚æ•°åç§°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:before    pointcut=<span class="string">&quot;com.xyz.lib.Pointcuts.anyPublicMethod() and @annotation(auditable)&quot;</span>    method=<span class="string">&quot;audit&quot;</span>    <span class="built_in">arg</span>-names=<span class="string">&quot;auditable&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p><code>arg-names</code>å±æ€§æ¥å—é€—å·åˆ†éš”çš„å‚æ•°åç§°åˆ—è¡¨ã€‚</p>
<p>ä»¥ä¸‹åŸºäº XSD çš„æ–¹æ³•ä¸­æ¶‰åŠç¨‹åº¦ç¨é«˜çš„ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€äº›ä¸ä¸€äº›å¼ºç±»å‹å‚æ•°ç»“åˆä½¿ç”¨çš„å»ºè®®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> x.y.service;<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonService</span> </span>&#123;    <span class="function">Person <span class="title">getPerson</span><span class="params">(String personName, <span class="keyword">int</span> age)</span></span>;&#125;<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFooService</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;    <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;        <span class="keyword">return</span> <span class="keyword">new</span> Person(name, age);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯åˆ‡é¢ã€‚è¯·æ³¨æ„ï¼Œ<code>profile(..)</code>æ–¹æ³•æ¥å—è®¸å¤šå¼ºç±»å‹çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ°å¥½æ˜¯ç”¨äºè¿›è¡Œæ–¹æ³•è°ƒç”¨çš„è¿æ¥ç‚¹ã€‚æ­¤å‚æ•°çš„å­˜åœ¨è¡¨æ˜<code>profile(..)</code>ç”¨ä½œ<code>around</code>å»ºè®®ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> x.y;<span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<span class="keyword">import</span> org.springframework.util.StopWatch;<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleProfiler</span> </span>&#123;    <span class="function"><span class="keyword">public</span> Object <span class="title">profile</span><span class="params">(ProceedingJoinPoint call, String name, <span class="keyword">int</span> age)</span> <span class="keyword">throws</span> Throwable </span>&#123;        StopWatch clock = <span class="keyword">new</span> StopWatch(<span class="string">&quot;Profiling for &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + age + <span class="string">&quot;&#x27;&quot;</span>);        <span class="keyword">try</span> &#123;            clock.start(call.toShortString());            <span class="keyword">return</span> call.proceed();        &#125; <span class="keyword">finally</span> &#123;            clock.stop();            System.out.println(clock.prettyPrint());        &#125;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œä»¥ä¸‹ç¤ºä¾‹ XML é…ç½®å½±å“äº†ç‰¹å®šè¿æ¥ç‚¹çš„ä¸Šè¿°å»ºè®®çš„æ‰§è¡Œï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>    <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span>    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span>    <span class="comment">&lt;!-- this is the object that will be proxied by Spring&#x27;s AOP infrastructure --&gt;</span>    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.service.DefaultPersonService&quot;</span>/&gt;</span>    <span class="comment">&lt;!-- this is the actual advice itself --&gt;</span>    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;profiler&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.SimpleProfiler&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;profiler&quot;</span>&gt;</span>            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;theExecutionOfSomePersonServiceMethod&quot;</span>                <span class="attr">expression</span>=<span class="string">&quot;execution(* x.y.service.PersonService.getPerson(String,int))                and args(name, age)&quot;</span>/&gt;</span>            <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;theExecutionOfSomePersonServiceMethod&quot;</span>                <span class="attr">method</span>=<span class="string">&quot;profile&quot;</span>/&gt;</span>        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span>    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è€ƒè™‘ä»¥ä¸‹é©±åŠ¨ç¨‹åºè„šæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;<span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<span class="keyword">import</span> x.y.service.PersonService;<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Boot</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        BeanFactory ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;x/y/plain.xml&quot;</span>);        PersonService person = (PersonService) ctx.getBean(<span class="string">&quot;personService&quot;</span>);        person.getPerson(<span class="string">&quot;Pengo&quot;</span>, <span class="number">12</span>);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™æ ·çš„ Boot ç±»ï¼Œæˆ‘ä»¬å°†åœ¨æ ‡å‡†è¾“å‡ºä¸Šè·å¾—ç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„è¾“å‡ºï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopWatch <span class="string">&#x27;Profiling for &#x27;</span>Pengo<span class="string">&#x27; and &#x27;</span><span class="number">12</span><span class="string">&#x27;&#x27;</span>: <span class="built_in">running</span> <span class="built_in">time</span> (millis) = <span class="number">0</span><span class="comment">-----------------------------------------ms     %     Task name-----------------------------------------00000  ?  execution(getFoo)</span></span><br></pre></td></tr></table></figure>

<h4 id="Advice-Ordering-1"><a href="#Advice-Ordering-1" class="headerlink" title="Advice Ordering"></a>Advice Ordering</h4><p>å½“éœ€è¦åœ¨åŒä¸€è¿æ¥ç‚¹(æ‰§è¡Œæ–¹æ³•)ä¸Šæ‰§è¡Œå¤šä¸ªå»ºè®®æ—¶ï¼Œæ’åºè§„åˆ™å¦‚<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj-advice-ordering">Advice Ordering</a>ä¸­æ‰€è¿°ã€‚åˆ‡é¢ä¹‹é—´çš„ä¼˜å…ˆçº§æ˜¯é€šè¿‡å°†<code>Order</code>æ³¨è§£æ·»åŠ åˆ°æ”¯æŒåˆ‡é¢çš„ Bean æˆ–é€šè¿‡ä½¿ Bean å®ç°<code>Ordered</code>æ¥å£æ¥ç¡®å®šçš„ã€‚</p>
<h3 id="Introductions-1"><a href="#Introductions-1" class="headerlink" title="Introductions"></a>Introductions</h3><p>ç®€ä»‹(åœ¨ AspectJ ä¸­ç§°ä¸ºç±»å‹é—´å£°æ˜)ä½¿åˆ‡é¢å¯ä»¥å£°æ˜å»ºè®®çš„å¯¹è±¡å®ç°ç»™å®šçš„æ¥å£ï¼Œå¹¶ä»£è¡¨é‚£äº›å¯¹è±¡æä¾›è¯¥æ¥å£çš„å®ç°ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨<code>aop:aspect</code>å†…çš„<code>aop:declare-parents</code>å…ƒç´ è¿›è¡Œä»‹ç»ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>aop:declare-parents</code>å…ƒç´ æ¥å£°æ˜åŒ¹é…ç±»å‹å…·æœ‰æ–°çš„çˆ¶ä»£(å› æ­¤è€Œå¾—å)ã€‚ä¾‹å¦‚ï¼Œç»™å®šåä¸º<code>UsageTracked</code>çš„æ¥å£å’Œè¯¥åä¸º<code>DefaultUsageTracked</code>çš„æ¥å£çš„å®ç°ï¼Œä»¥ä¸‹åˆ‡é¢å£°æ˜æœåŠ¡æ¥å£çš„æ‰€æœ‰å®ç°è€…ä¹Ÿéƒ½å®ç°<code>UsageTracked</code>æ¥å£ã€‚ (ä¾‹å¦‚ï¼Œä¸ºäº†é€šè¿‡ JMX å…¬å¼€ç»Ÿè®¡ä¿¡æ¯.)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;usageTrackerAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;usageTracking&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:declare-parents</span>        <span class="attr">types-matching</span>=<span class="string">&quot;com.xzy.myapp.service.*+&quot;</span>        <span class="attr">implement-interface</span>=<span class="string">&quot;com.xyz.myapp.service.tracking.UsageTracked&quot;</span>        <span class="attr">default-impl</span>=<span class="string">&quot;com.xyz.myapp.service.tracking.DefaultUsageTracked&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">aop:before</span>        <span class="attr">pointcut</span>=<span class="string">&quot;com.xyz.myapp.SystemArchitecture.businessService()            and this(usageTracked)&quot;</span>            <span class="attr">method</span>=<span class="string">&quot;recordUsage&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ”¯æŒ<code>usageTracking</code> bean çš„ç±»å°†åŒ…å«ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">recordUsage</span>(<span class="params">UsageTracked usageTracked</span>)</span> &#123;    usageTracked.incrementUseCount();&#125;</span><br></pre></td></tr></table></figure>

<p>è¦å®ç°çš„æ¥å£ç”±<code>implement-interface</code>å±æ€§ç¡®å®šã€‚ <code>types-matching</code>å±æ€§çš„å€¼æ˜¯ AspectJ ç±»å‹çš„æ¨¡å¼ã€‚ä»»ä½•åŒ¹é…ç±»å‹çš„ bean éƒ½å®ç°<code>UsageTracked</code>æ¥å£ã€‚è¯·æ³¨æ„ï¼Œåœ¨å‰é¢ç¤ºä¾‹çš„å»ºè®®ä¸­ï¼ŒæœåŠ¡ Bean å¯ä»¥ç›´æ¥ç”¨ä½œ<code>UsageTracked</code>æ¥å£çš„å®ç°ã€‚è¦ä»¥ç¼–ç¨‹æ–¹å¼è®¿é—® beanï¼Œå¯ä»¥ç¼–å†™ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsageTracked usageTracked = (UsageTracked) context.getBean(<span class="string">&quot;myService&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="5-5-5-åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹"><a href="#5-5-5-åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹" class="headerlink" title="5.5.5. åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹"></a>5.5.5. åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹</h4><p>æ¨¡å¼å®šä¹‰åˆ‡é¢å”¯ä¸€å—æ”¯æŒçš„å®ä¾‹åŒ–æ¨¡å‹æ˜¯å•ä¾‹æ¨¡å‹ã€‚åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šæ”¯æŒå…¶ä»–å®ä¾‹åŒ–æ¨¡å‹ã€‚</p>
<h4 id="5-5-6-Advisors"><a href="#5-5-6-Advisors" class="headerlink" title="5.5.6. Advisors"></a>5.5.6. Advisors</h4><p>â€œé¡¾é—®â€çš„æ¦‚å¿µæ¥è‡ª Spring ä¸­å®šä¹‰çš„ AOP æ”¯æŒï¼Œå¹¶ä¸”åœ¨ AspectJ ä¸­æ²¡æœ‰ç›´æ¥ç­‰æ•ˆçš„æ¦‚å¿µã€‚é¡¾é—®å°±åƒä¸€ä¸ªç‹¬ç«‹çš„å°åˆ‡é¢ï¼Œåªæœ‰ä¸€æ¡å»ºè®®ã€‚é€šçŸ¥æœ¬èº«ç”± bean è¡¨ç¤ºï¼Œå¹¶ä¸”å¿…é¡»å®ç°<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-api-advice-types">Spring çš„å»ºè®®ç±»å‹</a>ä¸­æè¿°çš„å»ºè®®æ¥å£ä¹‹ä¸€ã€‚é¡¾é—®å¯ä»¥åˆ©ç”¨ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚</p>
<p>Spring é€šè¿‡<code>&lt;aop:advisor&gt;</code>å…ƒç´ æ”¯æŒé¡¾é—®ç¨‹åºæ¦‚å¿µã€‚æ‚¨é€šå¸¸ä¼šçœ‹åˆ°å®ƒä¸äº‹åŠ¡å»ºè®®ç»“åˆä½¿ç”¨ï¼Œäº‹åŠ¡å»ºè®®åœ¨ Spring ä¸­ä¹Ÿæœ‰è‡ªå·±çš„åç§°ç©ºé—´æ”¯æŒã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºé¡¾é—®ç¨‹åºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;businessService&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..))&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">aop:advisor</span>        <span class="attr">pointcut-ref</span>=<span class="string">&quot;businessService&quot;</span>        <span class="attr">advice-ref</span>=<span class="string">&quot;tx-advice&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;tx-advice&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span>        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†å‰é¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨çš„<code>pointcut-ref</code>å±æ€§ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>pointcut</code>å±æ€§æ¥å†…è”å®šä¹‰åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚</p>
<p>è¦å®šä¹‰é¡¾é—®ç¨‹åºçš„ä¼˜å…ˆçº§ï¼Œä»¥ä¾¿è¯¥å»ºè®®ä¹¦å¯ä»¥å‚ä¸ Orderï¼Œè¯·ä½¿ç”¨<code>order</code>å±æ€§æ¥å®šä¹‰é¡¾é—®ç¨‹åºçš„<code>Ordered</code>å€¼ã€‚</p>
<h4 id="5-5-7-AOP-æ¨¡å¼ç¤ºä¾‹"><a href="#5-5-7-AOP-æ¨¡å¼ç¤ºä¾‹" class="headerlink" title="5.5.7. AOP æ¨¡å¼ç¤ºä¾‹"></a>5.5.7. AOP æ¨¡å¼ç¤ºä¾‹</h4><p>æœ¬èŠ‚æ˜¾ç¤ºäº†ä½¿ç”¨æ¨¡å¼æ”¯æŒé‡å†™æ—¶æ¥è‡ª<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ataspectj-example">AOP ç¤ºä¾‹</a>çš„å¹¶å‘é”å®šå¤±è´¥é‡è¯•ç¤ºä¾‹çš„å¤–è§‚ã€‚</p>
<p>æœ‰æ—¶ç”±äºå¹¶å‘é—®é¢˜(ä¾‹å¦‚ï¼Œæ­»é”å¤±è´¥è€…)ï¼Œä¸šåŠ¡æœåŠ¡çš„æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥ã€‚å¦‚æœé‡è¯•è¯¥æ“ä½œï¼Œåˆ™å¾ˆå¯èƒ½åœ¨ä¸‹ä¸€æ¬¡å°è¯•ä¸­æˆåŠŸã€‚å¯¹äºé€‚åˆåœ¨è¿™ç§æƒ…å†µä¸‹é‡è¯•çš„ä¸šåŠ¡æœåŠ¡(ä¸éœ€è¦ä¸ºè§£å†³å†²çªè€Œéœ€è¦è¿”å›ç»™ç”¨æˆ·çš„å¹‚ç­‰æ“ä½œ)ï¼Œæˆ‘ä»¬å¸Œæœ›é€æ˜åœ°é‡è¯•è¯¥æ“ä½œä»¥é¿å… Client ç«¯çœ‹åˆ°<code>PessimisticLockingFailureException</code>ã€‚è¿™é¡¹è¦æ±‚æ¸…æ¥šåœ°è·¨è¶Šäº†æœåŠ¡å±‚ä¸­çš„å¤šä¸ªæœåŠ¡ï¼Œå› æ­¤éå¸¸é€‚åˆé€šè¿‡ä¸€ä¸ªåˆ‡é¢å®æ–½ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬æƒ³é‡è¯•è¯¥æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œå‘¨å›´â€å»ºè®®ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¤šæ¬¡è°ƒç”¨<code>proceed</code>ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†åŸºæœ¬åˆ‡é¢çš„å®ç°(è¿™æ˜¯ä½¿ç”¨æ¨¡å¼æ”¯æŒçš„å¸¸è§„ Java ç±»)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentOperationExecutor</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_RETRIES = <span class="number">2</span>;    <span class="keyword">private</span> <span class="keyword">int</span> maxRetries = DEFAULT_MAX_RETRIES;    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">1</span>;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxRetries</span><span class="params">(<span class="keyword">int</span> maxRetries)</span> </span>&#123;        <span class="keyword">this</span>.maxRetries = maxRetries;    &#125;    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;        <span class="keyword">return</span> <span class="keyword">this</span>.order;    &#125;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;        <span class="keyword">this</span>.order = order;    &#125;    <span class="function"><span class="keyword">public</span> Object <span class="title">doConcurrentOperation</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;        <span class="keyword">int</span> numAttempts = <span class="number">0</span>;        PessimisticLockingFailureException lockFailureException;        <span class="keyword">do</span> &#123;            numAttempts++;            <span class="keyword">try</span> &#123;                <span class="keyword">return</span> pjp.proceed();            &#125;            <span class="keyword">catch</span>(PessimisticLockingFailureException ex) &#123;                lockFailureException = ex;            &#125;        &#125; <span class="keyword">while</span>(numAttempts &lt;= <span class="keyword">this</span>.maxRetries);        <span class="keyword">throw</span> lockFailureException;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œåˆ‡é¢å®ç°äº†<code>Ordered</code>æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†åˆ‡é¢çš„ä¼˜å…ˆçº§è®¾ç½®ä¸ºé«˜äºäº‹åŠ¡å»ºè®®(æ¯æ¬¡é‡è¯•æ—¶éƒ½å¸Œæœ›æœ‰æ–°çš„äº‹åŠ¡)ã€‚ <code>maxRetries</code>å’Œ<code>order</code>å±æ€§å‡ç”± Spring é…ç½®ã€‚ä¸»è¦åŠ¨ä½œå‘ç”Ÿåœ¨<code>doConcurrentOperation</code>å‘¨å›´å»ºè®®æ–¹æ³•ä¸­ã€‚æˆ‘ä»¬å°è¯• continueã€‚å¦‚æœæˆ‘ä»¬å¤±è´¥äº†<code>PessimisticLockingFailureException</code>ï¼Œæˆ‘ä»¬å°†é‡è¯•ï¼Œé™¤éæˆ‘ä»¬ç”¨å°½äº†æ‰€æœ‰çš„é‡è¯•å°è¯•ã€‚</p>
<p>Note</p>
<p>è¯¥ç±»ä¸@AspectJ ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ç±»ç›¸åŒï¼Œä½†æ˜¯é™¤å»äº† æ³¨è§£ã€‚</p>
<p>ç›¸åº”çš„ Spring é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;concurrentOperationRetry&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;concurrentOperationExecutor&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;idempotentOperation&quot;</span>            <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..))&quot;</span>/&gt;</span>        <span class="tag">&lt;<span class="name">aop:around</span>            <span class="attr">pointcut-ref</span>=<span class="string">&quot;idempotentOperation&quot;</span>            <span class="attr">method</span>=<span class="string">&quot;doConcurrentOperation&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;concurrentOperationExecutor&quot;</span>    <span class="attr">class</span>=<span class="string">&quot;com.xyz.myapp.service.impl.ConcurrentOperationExecutor&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxRetries&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span>        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œç›®å‰æˆ‘ä»¬å‡è®¾æ‰€æœ‰ä¸šåŠ¡æœåŠ¡éƒ½æ˜¯å¹‚ç­‰çš„ã€‚å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥<code>Idempotent</code>æ³¨è§£ å¹¶ä½¿ç”¨è¯¥æ³¨è§£æ¥æ³¨è§£æœåŠ¡æ“ä½œçš„å®ç°ï¼Œæ¥æ”¹è¿›åˆ‡é¢ï¼Œä½¿å…¶ä»…é‡è¯• true çš„å¹‚ç­‰æ“ä½œï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)public <span class="variable">@interface</span> Idempotent &#123;    <span class="comment">// marker annotation&#125;</span></span><br></pre></td></tr></table></figure>

<p>åˆ‡é¢çš„æ›´æ”¹ä»…é‡è¯•å¹‚ç­‰æ“ä½œæ¶‰åŠç²¾ç®€åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä»¥ä¾¿åªæœ‰<code>@Idempotent</code>ä¸ªæ“ä½œåŒ¹é…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;idempotentOperation&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xyz.myapp.service.*.*(..)) and        @annotation(com.xyz.myapp.service.Idempotent)&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="é€‰æ‹©è¦ä½¿ç”¨çš„-AOP-å£°æ˜æ ·å¼"><a href="#é€‰æ‹©è¦ä½¿ç”¨çš„-AOP-å£°æ˜æ ·å¼" class="headerlink" title="é€‰æ‹©è¦ä½¿ç”¨çš„ AOP å£°æ˜æ ·å¼"></a>é€‰æ‹©è¦ä½¿ç”¨çš„ AOP å£°æ˜æ ·å¼</h2><p>ä¸€æ—¦ç¡®å®šåˆ‡é¢æ˜¯å®ç°ç»™å®šéœ€æ±‚çš„æœ€ä½³æ–¹æ³•ï¼Œæ‚¨å¦‚ä½•åœ¨ä½¿ç”¨ Spring AOP æˆ– AspectJ ä»¥åŠåœ¨ Aspect è¯­è¨€(ä»£ç )æ ·å¼ï¼Œ@ AspectJ æ³¨è§£æ ·å¼æˆ– Spring XML æ ·å¼ä¹‹é—´åšå‡ºé€‰æ‹©ï¼Ÿè¿™äº›å†³å®šå—è®¸å¤šå› ç´ å½±å“ï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åºéœ€æ±‚ï¼Œå¼€å‘å·¥å…·ä»¥åŠå›¢é˜Ÿå¯¹ AOP çš„ç†Ÿæ‚‰ç¨‹åº¦ã€‚</p>
<h3 id="5-6-1-Spring-AOP-è¿˜æ˜¯-Full-AspectJï¼Ÿ"><a href="#5-6-1-Spring-AOP-è¿˜æ˜¯-Full-AspectJï¼Ÿ" class="headerlink" title="5.6.1. Spring AOP è¿˜æ˜¯ Full AspectJï¼Ÿ"></a>5.6.1. Spring AOP è¿˜æ˜¯ Full AspectJï¼Ÿ</h3><p>ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•å³å¯ã€‚ Spring AOP æ¯”ä½¿ç”¨å®Œæ•´çš„ AspectJ æ›´ç®€å•ï¼Œå› ä¸ºä¸éœ€è¦åœ¨å¼€å‘å’Œæ„å»ºè¿‡ç¨‹ä¸­å¼•å…¥ AspectJ ç¼–è¯‘å™¨/ç¼–ç»‡å™¨ã€‚å¦‚æœæ‚¨åªéœ€è¦å»ºè®®åœ¨ Spring bean ä¸Šæ‰§è¡Œæ“ä½œï¼Œåˆ™ Spring AOP æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚å¦‚æœæ‚¨éœ€è¦å»ºè®®ä¸å— Spring å®¹å™¨ Management çš„å¯¹è±¡(é€šå¸¸æ˜¯åŸŸå¯¹è±¡)ï¼Œåˆ™éœ€è¦ä½¿ç”¨ AspectJã€‚å¦‚æœæ‚¨å¸Œæœ›å»ºè®®é™¤ç®€å•æ–¹æ³•æ‰§è¡Œä»¥å¤–çš„è¿æ¥ç‚¹(ä¾‹å¦‚ï¼Œå­—æ®µ get æˆ–è®¾ç½®è¿æ¥ç‚¹ç­‰)ï¼Œåˆ™è¿˜éœ€è¦ä½¿ç”¨ AspectJã€‚</p>
<p>ä½¿ç”¨ AspectJ æ—¶ï¼Œå¯ä»¥é€‰æ‹© AspectJ è¯­è¨€è¯­æ³•(ä¹Ÿç§°ä¸ºâ€œä»£ç æ ·å¼â€)æˆ–@AspectJæ³¨è§£ æ ·å¼ã€‚æ˜¾ç„¶ï¼Œå¦‚æœæ‚¨ä¸ä½¿ç”¨ Java 5ï¼Œé‚£ä¹ˆå°†ä¸ºæ‚¨åšå‡ºé€‰æ‹©ï¼šä½¿ç”¨ä»£ç æ ·å¼ã€‚å¦‚æœåˆ‡é¢åœ¨æ‚¨çš„è®¾è®¡ä¸­èµ·ç€é‡è¦ä½œç”¨ï¼Œå¹¶ä¸”æ‚¨èƒ½å¤Ÿå°†<a target="_blank" rel="noopener" href="https://www.eclipse.org/ajdt/">AspectJ å¼€å‘å·¥å…·(AJDT)</a>æ’ä»¶ç”¨äº Eclipseï¼Œåˆ™ AspectJ è¯­è¨€è¯­æ³•æ˜¯é¦–é€‰ã€‚å®ƒæ›´å¹²å‡€ï¼Œæ›´ç®€å•ï¼Œå› ä¸ºè¯¥è¯­è¨€æ˜¯ä¸“ä¸ºç¼–å†™åˆ‡é¢è€Œè®¾è®¡çš„ã€‚å¦‚æœæ‚¨ä¸ä½¿ç”¨ Eclipse æˆ–åªæœ‰å°‘æ•°å‡ ä¸ªåˆ‡é¢åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ä¸èµ·ä½œç”¨ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½è¦è€ƒè™‘ä½¿ç”¨@AspectJ æ ·å¼ï¼Œåœ¨ IDE ä¸­åšæŒå¸¸è§„ Java ç¼–è¯‘ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ åˆ‡é¢ç¼–ç»‡é˜¶æ®µæ‚¨çš„æ„å»ºè„šæœ¬ã€‚</p>
<h3 id="5-6-2-AspectJ-æˆ–-Spring-AOP-çš„-XMLï¼Ÿ"><a href="#5-6-2-AspectJ-æˆ–-Spring-AOP-çš„-XMLï¼Ÿ" class="headerlink" title="5.6.2. @AspectJ æˆ– Spring AOP çš„ XMLï¼Ÿ"></a>5.6.2. @AspectJ æˆ– Spring AOP çš„ XMLï¼Ÿ</h3><p>å¦‚æœé€‰æ‹©ä½¿ç”¨ Spring AOPï¼Œåˆ™å¯ä»¥é€‰æ‹©@AspectJ æˆ– XML æ ·å¼ã€‚æœ‰å„ç§æŠ˜è¡·è€ƒè™‘ã€‚</p>
<p>XML æ ·å¼å¯èƒ½æ˜¯ç°æœ‰ Spring ç”¨æˆ·æœ€ç†Ÿæ‚‰çš„ï¼Œå¹¶ä¸”å¾—åˆ°äº† true çš„ POJO çš„æ”¯æŒã€‚å½“ä½¿ç”¨ AOP ä½œä¸ºé…ç½®ä¼ä¸šæœåŠ¡çš„å·¥å…·æ—¶ï¼ŒXML å¯èƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©(ä¸€ä¸ªå¾ˆå¥½çš„æµ‹è¯•æ˜¯æ‚¨æ˜¯å¦å°†åˆ‡å…¥ç‚¹è¡¨è¾¾å¼è§†ä¸ºé…ç½®çš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ç‹¬ç«‹æ›´æ”¹)ã€‚ä½¿ç”¨ XML æ ·å¼ï¼Œå¯ä»¥è¯´ä»æ‚¨çš„é…ç½®ä¸­å¯ä»¥æ›´æ¸…æ¥šåœ°äº†è§£ç³»ç»Ÿä¸­å­˜åœ¨å“ªäº›åˆ‡é¢ã€‚</p>
<p>XML æ ·å¼æœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚é¦–å…ˆï¼Œå®ƒæ²¡æœ‰å®Œå…¨å°†è¦è§£å†³çš„éœ€æ±‚çš„å®ç°å°è£…åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚ DRY åŸåˆ™è¯´ï¼Œç³»ç»Ÿä¸­çš„ä»»ä½•çŸ¥è¯†éƒ½åº”è¯¥æœ‰å•ä¸€ï¼Œæ˜ç¡®ï¼ŒAuthority çš„è¡¨ç¤ºå½¢å¼ã€‚å½“ä½¿ç”¨ XML æ ·å¼æ—¶ï¼Œå…³äºå¦‚ä½•å®ç°éœ€æ±‚çš„çŸ¥è¯†ä¼šåœ¨é…ç½®æ–‡ä»¶ä¸­çš„åå¤‡ bean ç±»çš„å£°æ˜å’Œ XML ä¸­åˆ†æ•£ã€‚å½“æ‚¨ä½¿ç”¨@AspectJ æ ·å¼æ—¶ï¼Œæ­¤ä¿¡æ¯å°†å°è£…åœ¨ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ä¸­ï¼šåˆ‡é¢ã€‚å…¶æ¬¡ï¼Œä¸@AspectJ æ ·å¼ç›¸æ¯”ï¼ŒXML æ ·å¼åœ¨è¡¨è¾¾èƒ½åŠ›ä¸Šæœ‰æ›´å¤šé™åˆ¶ï¼šä»…æ”¯æŒâ€œå•ä¾‹â€åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹ï¼Œå¹¶ä¸”æ— æ³•ç»„åˆä»¥ XML å£°æ˜çš„å‘½ååˆ‡å…¥ç‚¹ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨@AspectJ æ ·å¼ï¼Œæ‚¨å¯ä»¥ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Pointcut</span>(<span class="string">&quot;execution(* get*())&quot;</span>)public void propertyAccess() &#123;&#125;<span class="variable">@Pointcut</span>(<span class="string">&quot;execution(org.xyz.Account+ *(..))&quot;</span>)public void operationReturningAnAccount() &#123;&#125;<span class="variable">@Pointcut</span>(<span class="string">&quot;propertyAccess() &amp;&amp; operationReturningAnAccount()&quot;</span>)public void accountPropertyAccess() &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ XML æ ·å¼ä¸­ï¼Œæ‚¨å¯ä»¥å£°æ˜å‰ä¸¤ä¸ªåˆ‡å…¥ç‚¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;propertyAccess&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;execution(* get*())&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;operationReturningAnAccount&quot;</span>        <span class="attr">expression</span>=<span class="string">&quot;execution(org.xyz.Account+ *(..))&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>XML æ–¹æ³•çš„ç¼ºç‚¹æ˜¯æ— æ³•é€šè¿‡ç»„åˆè¿™äº›å®šä¹‰æ¥å®šä¹‰<code>accountPropertyAccess</code>åˆ‡å…¥ç‚¹ã€‚</p>
<p>@AspectJ æ ·å¼æ”¯æŒå…¶ä»–å®ä¾‹åŒ–æ¨¡å‹å’Œæ›´ä¸°å¯Œçš„åˆ‡å…¥ç‚¹ç»„åˆã€‚å®ƒå…·æœ‰å°†åˆ‡é¢ä¿æŒä¸ºæ¨¡å—åŒ–å•å…ƒçš„ä¼˜åŠ¿ã€‚å®ƒè¿˜å…·æœ‰çš„ä¼˜ç‚¹æ˜¯ï¼ŒSpring AOP å’Œ AspectJ éƒ½å¯ä»¥ç†è§£@AspectJ åˆ‡é¢ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨ä»¥åå†³å®šéœ€è¦ AspectJ çš„åŠŸèƒ½æ¥å®ç°å…¶ä»–è¦æ±‚ï¼Œåˆ™å¯ä»¥è½»æ¾åœ°è¿ç§»åˆ°åŸºäº AspectJ çš„æ–¹æ³•ã€‚æ€»è€Œè¨€ä¹‹ï¼Œåªè¦æ‚¨æ‹¥æœ‰æ¯”ç®€å•åœ°é…ç½®ä¼ä¸šæœåŠ¡æ›´å¤šçš„åŠŸèƒ½ï¼ŒSpring å›¢é˜Ÿå°±ä¼šå–œæ¬¢@AspectJ æ ·å¼ã€‚</p>
<h2 id="5-7-æ··åˆåˆ‡é¢ç±»å‹"><a href="#5-7-æ··åˆåˆ‡é¢ç±»å‹" class="headerlink" title="5.7. æ··åˆåˆ‡é¢ç±»å‹"></a>5.7. æ··åˆåˆ‡é¢ç±»å‹</h2><p>é€šè¿‡ä½¿ç”¨è‡ªåŠ¨ä»£ç†æ”¯æŒï¼Œæ¨¡å¼å®šä¹‰çš„<code>&lt;aop:aspect&gt;</code>åˆ‡é¢ï¼Œ<code>&lt;aop:advisor&gt;</code>å£°æ˜çš„é¡¾é—®ç¨‹åºï¼Œç”šè‡³æ˜¯åœ¨åŒä¸€é…ç½®ä¸­ä½¿ç”¨ Spring 1.2 æ ·å¼å®šä¹‰çš„ä»£ç†å’Œæ‹¦æˆªå™¨ï¼Œå®Œå…¨å¯ä»¥æ··åˆä½¿ç”¨@AspectJ æ ·å¼çš„åˆ‡é¢ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯é€šè¿‡ä½¿ç”¨ç›¸åŒçš„åŸºç¡€æ”¯æŒæœºåˆ¶å®ç°çš„ï¼Œå¹¶ä¸”å¯ä»¥æ¯«æ— å›°éš¾åœ°å…±å­˜ã€‚</p>
<h2 id="5-8-ä»£ç†æœºåˆ¶"><a href="#5-8-ä»£ç†æœºåˆ¶" class="headerlink" title="5.8. ä»£ç†æœºåˆ¶"></a>5.8. ä»£ç†æœºåˆ¶</h2><p>Spring AOP ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†æˆ– CGLIB åˆ›å»ºç»™å®šç›®æ ‡å¯¹è±¡çš„ä»£ç†ã€‚ (åªè¦æœ‰é€‰æ‹©ï¼Œé¦–é€‰ JDK åŠ¨æ€ä»£ç†)ã€‚</p>
<p>å¦‚æœè¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡å®ç°è‡³å°‘ä¸€ä¸ªæ¥å£ï¼Œåˆ™ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‚ä»£ç†äº†ç”±ç›®æ ‡ç±»å‹å®ç°çš„æ‰€æœ‰æ¥å£ã€‚å¦‚æœç›®æ ‡å¯¹è±¡æœªå®ç°ä»»ä½•æ¥å£ï¼Œåˆ™å°†åˆ›å»º CGLIB ä»£ç†ã€‚</p>
<p>å¦‚æœè¦å¼ºåˆ¶ä½¿ç”¨ CGLIB ä»£ç†(ä¾‹å¦‚ï¼Œä»£ç†ä¸ºç›®æ ‡å¯¹è±¡å®šä¹‰çš„æ¯ä¸ªæ–¹æ³•ï¼Œè€Œä¸ä»…æ˜¯ç”±å…¶æ¥å£å®ç°çš„æ–¹æ³•)ï¼Œéƒ½å¯ä»¥è¿™æ ·åšã€‚ä½†æ˜¯ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>ä¸èƒ½å»ºè®®<code>final</code>æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬ä¸èƒ½è¢«è¦†ç›–ã€‚</li>
<li>ä» Spring 3.2 å¼€å§‹ï¼Œä¸å†éœ€è¦å°† CGLIB æ·»åŠ åˆ°æ‚¨çš„é¡¹ç›® Classpath ä¸­ï¼Œå› ä¸º CGLIB ç±»åœ¨<code>org.springframework</code>ä¸‹é‡æ–°æ‰“åŒ…å¹¶ç›´æ¥åŒ…å«åœ¨ spring-core JAR ä¸­ã€‚è¿™æ„å‘³ç€åŸºäº CGLIB çš„ä»£ç†æ”¯æŒâ€œæœ‰æ•ˆâ€ï¼Œå°±åƒ JDK åŠ¨æ€ä»£ç†å§‹ç»ˆå…·æœ‰çš„ä¸€æ ·ã€‚</li>
<li>ä» Spring 4.0 å¼€å§‹ï¼Œç”±äº CGLIB ä»£ç†å®ä¾‹æ˜¯é€šè¿‡ Objenesis åˆ›å»ºçš„ï¼Œå› æ­¤ä¸å†è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸¤æ¬¡ã€‚ä»…å½“æ‚¨çš„ JVM ä¸å…è®¸ç»•è¿‡æ„é€ å‡½æ•°æ—¶ï¼Œæ‚¨æ‰å¯èƒ½ä» Spring çš„ AOP æ”¯æŒä¸­çœ‹åˆ°ä¸¤æ¬¡è°ƒç”¨å’Œç›¸åº”çš„è°ƒè¯•æ—¥å¿—æ¡ç›®ã€‚</li>
</ul>
<p>è¦å¼ºåˆ¶ä½¿ç”¨ CGLIB ä»£ç†ï¼Œè¯·å°†<code>&lt;aop:config&gt;</code>å…ƒç´ çš„<code>proxy-target-class</code>å±æ€§çš„å€¼è®¾ç½®ä¸º trueï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>&gt;</span>    <span class="comment">&lt;!-- other beans defined here... --&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¦åœ¨ä½¿ç”¨@AspectJ è‡ªåŠ¨ä»£ç†æ”¯æŒæ—¶å¼ºåˆ¶ CGLIB ä»£ç†ï¼Œè¯·å°†<code>&lt;aop:aspectj-autoproxy&gt;</code>å…ƒç´ çš„<code>proxy-target-class</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:aspectj-autoproxy proxy-target-<span class="class"><span class="keyword">class</span>=</span><span class="string">&quot;true&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>å¤šä¸ª<code>&lt;aop:config/&gt;</code>èŠ‚åœ¨è¿è¡Œæ—¶æŠ˜å åˆ°ä¸€ä¸ªç»Ÿä¸€çš„è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ä¸­ï¼Œè¯¥åˆ›å»ºå™¨å°†åº”ç”¨<code>&lt;aop:config/&gt;</code>èŠ‚ä¸­çš„ä»»ä½•(é€šå¸¸æ¥è‡ªä¸åŒ XML bean å®šä¹‰æ–‡ä»¶)æŒ‡å®šçš„* strong *ä»£ç†è®¾ç½®ã€‚è¿™ä¹Ÿé€‚ç”¨äº<code>&lt;tx:annotation-driven/&gt;</code>å’Œ<code>&lt;aop:aspectj-autoproxy/&gt;</code>å…ƒç´ ã€‚</p>
<p>æ˜ç¡®åœ°è¯´ï¼Œåœ¨<code>&lt;tx:annotation-driven/&gt;</code>ï¼Œ<code>&lt;aop:aspectj-autoproxy/&gt;</code>æˆ–<code>&lt;aop:config/&gt;</code>å…ƒç´ ä¸Šä½¿ç”¨<code>proxy-target-class=&quot;true&quot;</code>ä¼šå¼ºåˆ¶å¯¹æ‰€æœ‰ä¸‰ä¸ªå…ƒç´ *ä½¿ç”¨ CGLIB ä»£ç†ã€‚</p>
<h3 id="5-8-1-äº†è§£-AOP-ä»£ç†"><a href="#5-8-1-äº†è§£-AOP-ä»£ç†" class="headerlink" title="5.8.1. äº†è§£ AOP ä»£ç†"></a>5.8.1. äº†è§£ AOP ä»£ç†</h3><p>Spring AOP æ˜¯åŸºäºä»£ç†çš„ã€‚åœ¨ç¼–å†™è‡ªå·±çš„åˆ‡é¢æˆ–ä½¿ç”¨ Spring Framework éšé™„çš„ä»»ä½•åŸºäº Spring AOP çš„åˆ‡é¢ä¹‹å‰ï¼ŒæŒæ¡æœ€åä¸€æ¡è¯­å¥å®é™…å«ä¹‰çš„è¯­ä¹‰è‡³å…³é‡è¦ã€‚</p>
<p>é¦–å…ˆè€ƒè™‘æ‚¨æœ‰ä¸€ä¸ªæ™®é€šçš„ï¼Œæœªç»ä»£ç†çš„ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œç›´æ¥çš„å¯¹è±¡å¼•ç”¨çš„æƒ…å†µï¼Œå¦‚ä»¥ä¸‹ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePojo</span> <span class="title">implements</span> <span class="title">Pojo</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">foo</span>(<span class="params"></span>)</span> &#123;        <span class="comment">// this next method invocation is a direct call on the &#x27;this&#x27; reference        this.bar();    &#125;    public void bar() &#123;        // some logic...    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœåœ¨å¯¹è±¡å¼•ç”¨ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œåˆ™ç›´æ¥åœ¨è¯¥å¯¹è±¡å¼•ç”¨ä¸Šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾å’Œæ¸…å•æ‰€ç¤ºï¼š</p>
<p><img src="/2021/08/22/Java/spring/Spring-AOP/aop-proxy-plain-pojo-call.png" alt="aop ä»£ç†æ™®é€š pojo ç”µè¯"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="function"><span class="title">main</span>(<span class="params"><span class="built_in">String</span>[] args</span>)</span> &#123;        Pojo pojo = <span class="keyword">new</span> SimplePojo();        <span class="comment">// this is a direct method call on the &#x27;pojo&#x27; reference        pojo.foo();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å½“ Client ç«¯ä»£ç å…·æœ‰çš„å¼•ç”¨æ˜¯ä»£ç†æ—¶ï¼Œæƒ…å†µä¼šç¨æœ‰å˜åŒ–ã€‚è€ƒè™‘ä»¥ä¸‹å›¾è¡¨å’Œä»£ç ç‰‡æ®µï¼š</p>
<p><img src="/2021/08/22/Java/spring/Spring-AOP/aop-proxy-call.png" alt="aop ä»£ç†å‘¼å«"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        ProxyFactory factory = <span class="keyword">new</span> ProxyFactory(<span class="keyword">new</span> SimplePojo());        factory.addInterface(Pojo.class);        factory.addAdvice(<span class="keyword">new</span> RetryAdvice());        Pojo pojo = (Pojo) factory.getProxy();        <span class="comment">// this is a method call on the proxy!        pojo.foo();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦ç†è§£çš„å…³é”®æ˜¯ï¼Œ<code>Main</code>ç±»çš„<code>main(..)</code>æ–¹æ³•å†…éƒ¨çš„ Client ç«¯ä»£ç å…·æœ‰å¯¹ä»£ç†çš„å¼•ç”¨ã€‚è¿™æ„å‘³ç€è¯¥å¯¹è±¡å¼•ç”¨ä¸Šçš„æ–¹æ³•è°ƒç”¨æ˜¯ä»£ç†ä¸Šçš„è°ƒç”¨ã€‚ç»“æœï¼Œä»£ç†å¯ä»¥å§”æ´¾ç»™ä¸è¯¥ç‰¹å®šæ–¹æ³•è°ƒç”¨ç›¸å…³çš„æ‰€æœ‰æ‹¦æˆªå™¨(å»ºè®®)ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨æœ€ç»ˆåˆ°è¾¾ç›®æ ‡å¯¹è±¡(åœ¨è¿™ç§æƒ…å†µä¸‹ä¸º<code>SimplePojo</code>ï¼Œåˆ™ä¸º<code>this.bar()</code>æˆ–<code>this.foo()</code>)ï¼Œåˆ™å°†é’ˆå¯¹<code>this</code>å¼•ç”¨è€Œä¸æ˜¯å¯¹<code>this</code>å¼•ç”¨è°ƒç”¨å®ƒå¯èƒ½å¯¹å…¶è‡ªèº«è¿›è¡Œçš„ä»»ä½•æ–¹æ³•è°ƒç”¨ã€‚ä»£ç†ã€‚è¿™å…·æœ‰é‡è¦çš„æ„ä¹‰ã€‚è¿™æ„å‘³ç€è‡ªè°ƒç”¨ä¸ä¼šå¯¼è‡´ä¸æ–¹æ³•è°ƒç”¨ç›¸å…³çš„å»ºè®®å¾—åˆ°æ‰§è¡Œçš„æœºä¼šã€‚</p>
<p>å¥½å§ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠï¼Ÿæœ€å¥½çš„æ–¹æ³•(æ­¤å¤„å®½æ¾åœ°ä½¿ç”¨æœ¯è¯­â€œæœ€å¥½â€)æ˜¯é‡æ„ä»£ç ï¼Œä»¥å…å‘ç”Ÿè‡ªè°ƒç”¨ã€‚è¿™ç¡®å®éœ€è¦æ‚¨åšä¸€äº›å·¥ä½œï¼Œä½†è¿™æ˜¯æœ€å¥½çš„ï¼Œä¾µå…¥æ€§æœ€å°çš„æ–¹æ³•ã€‚ä¸‹ä¸€ç§æ–¹æ³•ç»å¯¹å¯æ€•ï¼Œæˆ‘ä»¬æ­£è¦æŒ‡å‡ºè¿™ä¸€ç‚¹ï¼Œæ°æ°æ˜¯å› ä¸ºå®ƒæ˜¯å¦‚æ­¤å¯æ€•ã€‚æ‚¨å¯ä»¥(å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ç—›è‹¦çš„)å®Œå…¨å°†ç±»ä¸­çš„é€»è¾‘ä¸ Spring AOP ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePojo</span> <span class="title">implements</span> <span class="title">Pojo</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">foo</span>(<span class="params"></span>)</span> &#123;        <span class="comment">// this works, but... gah!        ((Pojo) AopContext.currentProxy()).bar();    &#125;    public void bar() &#123;        // some logic...    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™å°†æ‚¨çš„ä»£ç å®Œå…¨è€¦åˆåˆ° Spring AOPï¼Œå¹¶ä¸”ä½¿ç±»æœ¬èº«æ„è¯†åˆ°åœ¨ AOP ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨å®ƒè¿™ä¸€äº‹å®ï¼Œè€Œ AOP å´æ˜¯äº‹å®ã€‚åˆ›å»ºä»£ç†æ—¶ï¼Œè¿˜éœ€è¦ä¸€äº›å…¶ä»–é…ç½®ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        ProxyFactory factory = <span class="keyword">new</span> ProxyFactory(<span class="keyword">new</span> SimplePojo());        factory.adddInterface(Pojo.class);        factory.addAdvice(<span class="keyword">new</span> RetryAdvice());        factory.setExposeProxy(<span class="keyword">true</span>);        Pojo pojo = (Pojo) factory.getProxy();        <span class="comment">// this is a method call on the proxy!        pojo.foo();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œå¿…é¡»æ³¨æ„ï¼ŒAspectJ æ²¡æœ‰æ­¤è‡ªè°ƒç”¨é—®é¢˜ï¼Œå› ä¸ºå®ƒä¸æ˜¯åŸºäºä»£ç†çš„ AOP æ¡†æ¶ã€‚</p>
<h2 id="5-9-ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º-AspectJ-ä»£ç†"><a href="#5-9-ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º-AspectJ-ä»£ç†" class="headerlink" title="5.9. ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º@AspectJ ä»£ç†"></a>5.9. ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º@AspectJ ä»£ç†</h2><p>é™¤äº†ä½¿ç”¨<code>&lt;aop:config&gt;</code>æˆ–<code>&lt;aop:aspectj-autoproxy&gt;</code>å£°æ˜é…ç½®ä¸­çš„å„ä¸ªåˆ‡é¢å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼åˆ›å»ºå»ºè®®ç›®æ ‡å¯¹è±¡çš„ä»£ç†ã€‚æœ‰å…³ Spring çš„ AOP API çš„å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-api">next chapter</a>ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¦é‡ç‚¹ä»‹ç»é€šè¿‡ä½¿ç”¨@AspectJ åˆ‡é¢è‡ªåŠ¨åˆ›å»ºä»£ç†çš„åŠŸèƒ½ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨<code>org.springframework.aop.aspectj.annotation.AspectJProxyFactory</code>ç±»ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª@AspectJ åˆ‡é¢å»ºè®®çš„ç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç†ã€‚æ­¤ç±»çš„åŸºæœ¬ç”¨æ³•éå¸¸ç®€å•ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a factory that can generate a proxy for the given target objectAspectJProxyFactory factory = new AspectJProxyFactory(targetObject);// add an aspect, the class must be an @AspectJ aspect// you can call this as many times as you need with different aspectsfactory.addAspect(SecurityManager.class);// you can also add existing aspect instances, the type of the object supplied must be an @AspectJ aspectfactory.addAspect(usageTracker);// now get the proxy object...MyInterfaceType proxy = factory.getProxy();</span></span><br></pre></td></tr></table></figure>

<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.1.3.RELEASE/javadoc-api/org/springframework/aop/aspectj/annotation/AspectJProxyFactory.html">javadoc</a>ã€‚</p>
<h2 id="5-10-åœ¨-Spring-åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨-AspectJ"><a href="#5-10-åœ¨-Spring-åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨-AspectJ" class="headerlink" title="5.10. åœ¨ Spring åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ AspectJ"></a>5.10. åœ¨ Spring åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ AspectJ</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ¬ç« ä»‹ç»çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯çº¯ Spring AOPã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å¦‚æœæ‚¨çš„éœ€æ±‚è¶…å‡ºäº† Spring AOP æ‰€æä¾›çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ AspectJ ç¼–è¯‘å™¨æˆ– weaver ä»£æ›¿ Spring AOP æˆ–é™¤ Spring AOP ä¹‹å¤–ä½¿ç”¨ã€‚</p>
<p>Spring é™„å¸¦äº†ä¸€ä¸ªå°çš„ AspectJ åˆ‡é¢åº“ï¼Œè¯¥åº“åœ¨æ‚¨çš„å‘è¡Œç‰ˆä¸­å¯ä»¥ä½œä¸º<code>spring-aspects.jar</code>ç‹¬ç«‹ä½¿ç”¨ã€‚æ‚¨éœ€è¦å°†å…¶æ·»åŠ åˆ° Classpath ä¸­æ‰èƒ½ä½¿ç”¨å…¶ä¸­çš„åˆ‡é¢ã€‚ <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-atconfigurable">ä½¿ç”¨ AspectJ é€šè¿‡ Spring ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡</a>å’Œ<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-ajlib-other">AspectJ çš„å…¶ä»– Spring åˆ‡é¢</a>è®¨è®ºäº†è¯¥åº“çš„å†…å®¹ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚ <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-configure">ä½¿ç”¨ Spring IoC é…ç½® AspectJ Aspects</a>è®¨è®ºå¦‚ä½•ä¾èµ–æ³¨å…¥ä½¿ç”¨ AspectJ ç¼–è¯‘å™¨ç¼–ç»‡çš„ AspectJ åˆ‡é¢ã€‚æœ€åï¼Œ<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw">åœ¨ Spring Framework ä¸­ä½¿ç”¨ AspectJ è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡</a>ä»‹ç»äº†ä½¿ç”¨ AspectJ çš„ Spring åº”ç”¨ç¨‹åºçš„åŠ è½½æ—¶ç¼–ç»‡ã€‚</p>
<h3 id="5-10-1-ä½¿ç”¨-AspectJ-é€šè¿‡-Spring-ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡"><a href="#5-10-1-ä½¿ç”¨-AspectJ-é€šè¿‡-Spring-ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡" class="headerlink" title="5.10.1. ä½¿ç”¨ AspectJ é€šè¿‡ Spring ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡"></a>5.10.1. ä½¿ç”¨ AspectJ é€šè¿‡ Spring ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡</h3><p>Spring å®¹å™¨å®ä¾‹åŒ–å¹¶é…ç½®åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„ beanã€‚ç»™å®šåŒ…å«è¦åº”ç”¨çš„é…ç½®çš„ Bean å®šä¹‰çš„åç§°ï¼Œä¹Ÿå¯ä»¥è¦æ±‚ Bean å·¥å‚é…ç½®é¢„å…ˆå­˜åœ¨çš„å¯¹è±¡ã€‚ <code>spring-aspects.jar</code>åŒ…å«æ³¨è§£é©±åŠ¨çš„åˆ‡é¢ï¼Œè¯¥åˆ‡é¢åˆ©ç”¨æ­¤åŠŸèƒ½å…è®¸ä»»ä½•å¯¹è±¡çš„ä¾èµ–é¡¹æ³¨å…¥ã€‚è¯¥æ”¯æ¶æ—¨åœ¨ç”¨äºåœ¨ä»»ä½•å®¹å™¨çš„æ§åˆ¶èŒƒå›´ä¹‹å¤–åˆ›å»ºçš„å¯¹è±¡ã€‚åŸŸå¯¹è±¡é€šå¸¸å±äºæ­¤ç±»ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ˜¯é€šè¿‡<code>new</code>è¿ç®—ç¬¦æˆ–é€šè¿‡ ORM å·¥å…·ä»¥æ•°æ®åº“æŸ¥è¯¢çš„æ–¹å¼é€šè¿‡ç¨‹åºåˆ›å»ºçš„ã€‚</p>
<p><code>@Configurable</code>æ³¨è§£ å°†ä¸€ä¸ªç±»æ ‡è®°ä¸ºç¬¦åˆ Spring é©±åŠ¨çš„é…ç½®ã€‚åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°†å…¶çº¯ç²¹ç”¨ä½œæ ‡è®° æ³¨è§£ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.myapp.domain;<span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Configurable;<span class="meta">@Configurablepublic</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;    <span class="comment">// ...&#125;</span></span><br></pre></td></tr></table></figure>

<p>å½“ä»¥è¿™ç§æ–¹å¼ç”¨ä½œæ ‡è®°æ¥å£æ—¶ï¼ŒSpring é€šè¿‡ä½¿ç”¨å…·æœ‰ä¸å®Œå…¨é™å®šç±»å‹åç§°(<code>com.xyz.myapp.domain.Account</code>)åŒåçš„ bean å®šä¹‰(é€šå¸¸ä¸ºåŸå‹ä½œç”¨åŸŸ)æ¥é…ç½®å¸¦æ³¨è§£ç±»å‹çš„æ–°å®ä¾‹(åœ¨æœ¬ä¾‹ä¸­ä¸º<code>Account</code>)ã€‚ ã€‚ç”±äº Bean çš„é»˜è®¤åç§°æ˜¯å…¶ç±»å‹çš„å®Œå…¨é™å®šåç§°ï¼Œå› æ­¤å£°æ˜åŸå‹å®šä¹‰çš„ä¾¿æ·æ–¹æ³•æ˜¯çœç•¥<code>id</code>å±æ€§ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.xyz.myapp.domain.Account&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;fundsTransferService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;fundsTransferService&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦æ˜¾å¼æŒ‡å®šè¦ä½¿ç”¨çš„åŸå‹ bean å®šä¹‰çš„åç§°ï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨æ³¨è§£ä¸­è¿™æ ·åšï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.myapp.domain;<span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Configurable;<span class="meta">@Configurable(<span class="meta-string">&quot;account&quot;</span>)</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;    <span class="comment">// ...&#125;</span></span><br></pre></td></tr></table></figure>

<p>Spring ç°åœ¨æŸ¥æ‰¾åä¸º<code>account</code>çš„ bean å®šä¹‰ï¼Œå¹¶å°†å…¶ç”¨ä½œé…ç½®æ–°<code>Account</code>å®ä¾‹çš„å®šä¹‰ã€‚</p>
<p>æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªåŠ¨è£…é…æ¥é¿å…å®Œå…¨æŒ‡å®šä¸“ç”¨çš„ bean å®šä¹‰ã€‚è¦è®© Spring åº”ç”¨è‡ªåŠ¨è£…é…ï¼Œè¯·ä½¿ç”¨<code>@Configurable</code>æ³¨è§£çš„<code>autowire</code>å±æ€§ã€‚æ‚¨å¯ä»¥åˆ†åˆ«æŒ‰ç±»å‹æˆ–åç§°æŒ‡å®š<code>@Configurable(autowire=Autowire.BY_TYPE)</code>æˆ–<code>@Configurable(autowire=Autowire.BY_NAME</code>è‡ªåŠ¨å¸ƒçº¿ã€‚æˆ–è€…ï¼Œä» Spring 2.5 å¼€å§‹ï¼Œæœ€å¥½åœ¨å­—æ®µæˆ–æ–¹æ³•çº§åˆ«ä½¿ç”¨<code>@Autowired</code>æˆ–<code>@Inject</code>ä¸º<code>@Configurable</code> bean æŒ‡å®šæ˜¾å¼çš„ï¼Œæ³¨è§£ é©±åŠ¨çš„ä¾èµ–é¡¹æ³¨å…¥(æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#beans-annotation-config">åŸºäºæ³¨è§£çš„å®¹å™¨é…ç½®</a>)ã€‚</p>
<p>æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>dependencyCheck</code>å±æ€§(ä¾‹å¦‚<code>@Configurable(autowire=Autowire.BY_NAME,dependencyCheck=true)</code>)ä¸ºæ–°åˆ›å»ºå’Œé…ç½®çš„å¯¹è±¡ä¸­çš„å¯¹è±¡å¼•ç”¨å¯ç”¨ Spring ä¾èµ–é¡¹æ£€æŸ¥ã€‚å¦‚æœæ­¤å±æ€§è®¾ç½®ä¸º<code>true</code>ï¼Œåˆ™ Spring åœ¨é…ç½®åéªŒè¯æ˜¯å¦å·²è®¾ç½®æ‰€æœ‰å±æ€§(ä¸æ˜¯åŸºå…ƒæˆ–é›†åˆ)ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå•ç‹¬ä½¿ç”¨æ³¨è§£ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚æ³¨è§£ ä¸­å­˜åœ¨çš„æ˜¯<code>spring-aspects.jar</code>ä¸­çš„<code>AnnotationBeanConfigurerAspect</code>ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œåˆ‡é¢è¯´ï¼šâ€œåœ¨ä»å¸¦æœ‰<code>@Configurable</code>æ³¨è§£ çš„ç±»å‹çš„æ–°å¯¹è±¡çš„åˆå§‹åŒ–è¿”å›ä¹‹åï¼Œæ ¹æ®æ³¨è§£çš„å±æ€§ä½¿ç”¨ Spring é…ç½®æ–°åˆ›å»ºçš„å¯¹è±¡â€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œåˆå§‹åŒ–â€æ˜¯æŒ‡æ–°å®ä¾‹åŒ–çš„å¯¹è±¡(ä¾‹å¦‚ï¼Œç”¨<code>new</code>è¿ç®—ç¬¦å®ä¾‹åŒ–çš„å¯¹è±¡)ä»¥åŠæ­£åœ¨ååºåˆ—åŒ–(ä¾‹å¦‚ï¼Œé€šè¿‡<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/api/java/io/Serializable.html">readResolve()</a>)çš„<code>Serializable</code>å¯¹è±¡ã€‚</p>
<p>Note</p>
<p>ä¸Šæ®µä¸­çš„å…³é”®çŸ­è¯­ä¹‹ä¸€æ˜¯â€œæœ¬è´¨ä¸Šâ€ã€‚å¯¹äºå¤§å¤šæ•°æƒ…å†µï¼Œâ€œä»æ–°å¯¹è±¡çš„åˆå§‹åŒ–è¿”å›åâ€çš„ç¡®åˆ‡è¯­ä¹‰æ˜¯å¯ä»¥çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œåˆå§‹åŒ–ä¹‹åâ€æ˜¯æŒ‡åœ¨æ„é€ å¯¹è±¡ä¹‹åæ³¨å…¥ä¾èµ–é¡¹ã€‚è¿™æ„å‘³ç€è¯¥ä¾èµ–é¡¹ä¸å¯åœ¨ç±»çš„æ„é€ å‡½æ•°ä½“ä¸­ä½¿ç”¨ã€‚å¦‚æœè¦åœ¨æ„é€ å‡½æ•°ä¸»ä½“æ‰§è¡Œä¹‹å‰æ³¨å…¥ä¾èµ–é¡¹ï¼Œä»è€Œå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸»ä½“ä¸­ä½¿ç”¨è¿™äº›ä¾èµ–é¡¹ï¼Œåˆ™éœ€è¦åœ¨<code>@Configurable</code>å£°æ˜ä¸­å®šä¹‰æ­¤å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configurable(preConstruction=true)</span></span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj/doc/next/progguide/index.html">AspectJ ç¼–ç¨‹æŒ‡å—</a>çš„ AspectJ <a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj/doc/next/progguide/semantics-joinPoints.html">åœ¨æœ¬é™„å½•ä¸­</a>ä¸­æ‰¾åˆ°æœ‰å…³å„ç§åˆ‡å…¥ç‚¹ç±»å‹çš„è¯­è¨€è¯­ä¹‰çš„æ›´å¤šä¿¡æ¯ã€‚</p>
<p>ä¸ºæ­¤ï¼Œå¿…é¡»å°†å¸¦æ³¨è§£çš„ç±»å‹ä¸ AspectJ ç¼–ç»‡å™¨ç¼–ç»‡åœ¨ä¸€èµ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ„å»ºæ—¶ Ant æˆ– Maven ä»»åŠ¡æ¥æ‰§è¡Œæ­¤æ“ä½œ(ä¾‹å¦‚ï¼Œå‚è§__)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŠ è½½æ—¶ç¼–ç»‡(è¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw">åœ¨ Spring Framework ä¸­ä½¿ç”¨ AspectJ è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡</a>)ã€‚ <code>AnnotationBeanConfigurerAspect</code>æœ¬èº«éœ€è¦ç”± Spring é…ç½®(ä»¥è·å–å¯¹å°†ç”¨äºé…ç½®æ–°å¯¹è±¡çš„ Bean å·¥å‚çš„å¼•ç”¨)ã€‚å¦‚æœä½¿ç”¨åŸºäº Java çš„é…ç½®ï¼Œåˆ™å¯ä»¥å°†<code>@EnableSpringConfigured</code>æ·»åŠ åˆ°ä»»ä½•<code>@Configuration</code>ç±»ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span><span class="variable">@EnableSpringConfiguredpublic</span> class AppConfig &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ‚¨å–œæ¬¢åŸºäº XML çš„é…ç½®ï¼ŒSpring <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#xsd-schemas-context">context namespace</a>å®šä¹‰äº†ä¸€ä¸ªæ–¹ä¾¿çš„<code>context:spring-configured</code>å…ƒç´ ï¼Œæ‚¨å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼ä½¿ç”¨å®ƒï¼š</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;context:spring-configured/&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨é…ç½®åˆ‡é¢ä¹‹å‰åˆ›å»ºçš„<code>@Configurable</code>ä¸ªå¯¹è±¡çš„å®ä¾‹å¯¼è‡´å‘è°ƒè¯•æ—¥å¿—å‘å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”æœªè¿›è¡Œä»»ä½•å¯¹è±¡é…ç½®ã€‚ä¸€ä¸ªç¤ºä¾‹å¯èƒ½æ˜¯ Spring é…ç½®ä¸­çš„ beanï¼Œå½“å®ƒç”± Spring åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºåŸŸå¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨<code>depends-on</code> bean å±æ€§æ¥æ‰‹åŠ¨æŒ‡å®šè¯¥ bean å–å†³äºé…ç½®åˆ‡é¢ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨<code>depends-on</code>å±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myService&quot;</span>        <span class="attr">class</span>=<span class="string">&quot;com.xzy.myapp.service.MyService&quot;</span>        <span class="attr">depends-on</span>=<span class="string">&quot;org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect&quot;</span>&gt;</span>    <span class="comment">&lt;!-- ... --&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>é™¤éæ‚¨çœŸçš„æƒ³åœ¨è¿è¡Œæ—¶ä¾èµ–å®ƒçš„è¯­ä¹‰ï¼Œå¦åˆ™ä¸è¦é€šè¿‡ bean configurer åˆ‡é¢æ¿€æ´»<code>@Configurable</code>å¤„ç†ã€‚ç‰¹åˆ«æ˜¯ï¼Œè¯·ç¡®ä¿ä¸è¦åœ¨å·²é€šè¿‡å®¹å™¨æ³¨å†Œä¸ºå¸¸è§„ Spring bean çš„ bean ç±»ä¸Šä½¿ç”¨<code>@Configurable</code>ã€‚è¿™æ ·åšå°†å¯¼è‡´ä¸¤æ¬¡åˆå§‹åŒ–ï¼Œä¸€æ¬¡æ˜¯é€šè¿‡å®¹å™¨ï¼Œä¸€æ¬¡æ˜¯é€šè¿‡åˆ‡é¢ã€‚</p>
<h4 id="å•å…ƒæµ‹è¯•-Configurable-å¯¹è±¡"><a href="#å•å…ƒæµ‹è¯•-Configurable-å¯¹è±¡" class="headerlink" title="å•å…ƒæµ‹è¯•@Configurable å¯¹è±¡"></a>å•å…ƒæµ‹è¯•@Configurable å¯¹è±¡</h4><p><code>@Configurable</code>æ”¯æŒçš„ç›®æ ‡ä¹‹ä¸€æ˜¯å®ç°åŸŸå¯¹è±¡çš„ç‹¬ç«‹å•å…ƒæµ‹è¯•ï¼Œè€Œä¸ä¼šé‡åˆ°ä¸ç¡¬ç¼–ç æŸ¥æ‰¾ç›¸å…³çš„å›°éš¾ã€‚å¦‚æœ AspectJ å°šæœªç¼–ç»‡<code>@Configurable</code>ç±»å‹ï¼Œåˆ™æ³¨è§£åœ¨å•å…ƒæµ‹è¯•æœŸé—´ä¸èµ·ä½œç”¨ã€‚æ‚¨å¯ä»¥åœ¨è¢«æµ‹å¯¹è±¡ä¸­è®¾ç½®æ¨¡æ‹Ÿæˆ–å­˜æ ¹å±æ€§å¼•ç”¨ï¼Œç„¶åç…§å¸¸è¿›è¡Œã€‚å¦‚æœ<code>@Configurable</code>ç±»å‹æ˜¯ AspectJ ç¼–ç»‡çš„ï¼Œæ‚¨ä»ç„¶å¯ä»¥åƒå¾€å¸¸ä¸€æ ·åœ¨å®¹å™¨å¤–éƒ¨è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯æ¯æ¬¡æ„é€ <code>@Configurable</code>å¯¹è±¡æ—¶ï¼Œéƒ½ä¼šçœ‹åˆ°ä¸€æ¡è­¦å‘Šæ¶ˆæ¯ï¼ŒæŒ‡ç¤ºè¯¥å¯¹è±¡å°šæœªç”± Spring é…ç½®ã€‚</p>
<h4 id="å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡"><a href="#å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡" class="headerlink" title="å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡"></a>å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡</h4><p>ç”¨äºå®ç°<code>@Configurable</code>æ”¯æŒçš„<code>AnnotationBeanConfigurerAspect</code>æ˜¯ AspectJ å•ä¾‹åˆ‡é¢ã€‚å•ä¾‹åˆ‡é¢çš„èŒƒå›´ä¸<code>static</code>æˆå‘˜çš„èŒƒå›´ç›¸åŒï¼šæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªåˆ‡é¢å®ä¾‹æ¥å®šä¹‰ç±»å‹ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„ä¸­å®šä¹‰å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œåˆ™éœ€è¦è€ƒè™‘åœ¨å“ªé‡Œå®šä¹‰<code>@EnableSpringConfigured</code> bean ä»¥åŠåœ¨å“ªé‡Œå°†<code>spring-aspects.jar</code>æ”¾åœ¨ Classpath ä¸Šã€‚</p>
<p>è€ƒè™‘ä¸€ä¸ªå…¸å‹çš„ Spring Web åº”ç”¨ç¨‹åºé…ç½®ï¼Œè¯¥é…ç½®å…·æœ‰ä¸€ä¸ªå…±äº«çš„çˆ¶åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡å®šä¹‰äº†é€šç”¨çš„ä¸šåŠ¡æœåŠ¡ï¼Œæ”¯æŒé‚£äº›æœåŠ¡æ‰€éœ€çš„ä¸€åˆ‡ï¼Œä»¥åŠæ¯ä¸ª Servlet çš„ä¸€ä¸ªå­åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡(å…¶ä¸­åŒ…å«è¯¥ Servlet çš„ç‰¹å®šå®šä¹‰)ã€‚æ‰€æœ‰è¿™äº›ä¸Šä¸‹æ–‡å…±å­˜äºç›¸åŒçš„ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„ä¸­ï¼Œå› æ­¤<code>AnnotationBeanConfigurerAspect</code>åªèƒ½ä¿ç•™å¯¹å…¶ä¸­ä¸€ä¸ªçš„å¼•ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®åœ¨å…±äº«(çˆ¶)åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­å®šä¹‰<code>@EnableSpringConfigured</code> beanã€‚è¿™å®šä¹‰äº†æ‚¨å¯èƒ½æƒ³æ³¨å…¥åŸŸå¯¹è±¡çš„æœåŠ¡ã€‚ç»“æœæ˜¯ï¼Œæ‚¨æ— æ³•ä½¿ç”¨@Configurable æœºåˆ¶æ¥é…ç½®åŸŸå¯¹è±¡ï¼Œè¯¥åŸŸå¯¹è±¡å¼•ç”¨çš„æ˜¯åœ¨å­(ç‰¹å®šäº servlet çš„)ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„ bean çš„å¼•ç”¨(æ— è®ºå¦‚ä½•ï¼Œè¿™å¯èƒ½ä¸æ˜¯æ‚¨æƒ³åšçš„äº‹æƒ…)ã€‚</p>
<p>åœ¨åŒä¸€å®¹å™¨ä¸­éƒ¨ç½²å¤šä¸ª Web åº”ç”¨ç¨‹åºæ—¶ï¼Œè¯·ç¡®ä¿æ¯ä¸ª Web åº”ç”¨ç¨‹åºä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨(ä¾‹å¦‚ï¼Œå°†<code>spring-aspects.jar</code>æ”¾åœ¨<code>&#39;WEB-INF/lib&#39;</code>ä¸­)åŠ è½½<code>spring-aspects.jar</code>ä¸­çš„ç±»å‹ã€‚å¦‚æœ<code>spring-aspects.jar</code>ä»…æ·»åŠ åˆ°å®¹å™¨çº§çš„ Classpath ä¸­(å¹¶å› æ­¤ç”±å…±äº«çš„çˆ¶ç±»åŠ è½½å™¨åŠ è½½)ï¼Œåˆ™æ‰€æœ‰ Web åº”ç”¨ç¨‹åºéƒ½å…±äº«ç›¸åŒçš„åˆ‡é¢å®ä¾‹(è¿™å¯èƒ½ä¸æ˜¯æ‚¨æƒ³è¦çš„)ã€‚</p>
<h3 id="5-10-2-AspectJ-çš„å…¶ä»–-Spring-åˆ‡é¢"><a href="#5-10-2-AspectJ-çš„å…¶ä»–-Spring-åˆ‡é¢" class="headerlink" title="5.10.2. AspectJ çš„å…¶ä»– Spring åˆ‡é¢"></a>5.10.2. AspectJ çš„å…¶ä»– Spring åˆ‡é¢</h3><p>é™¤äº†<code>@Configurable</code>åˆ‡é¢ä¹‹å¤–ï¼Œ<code>spring-aspects.jar</code>è¿˜åŒ…å«ä¸€ä¸ª AspectJ åˆ‡é¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥é©±åŠ¨ Spring çš„äº‹åŠ¡ Managementï¼Œè¯¥äº‹åŠ¡ Management ä½¿ç”¨<code>@Transactional</code>æ³¨è§£ è¿›è¡Œæ³¨è§£çš„ç±»å‹å’Œæ–¹æ³•ã€‚è¿™ä¸»è¦é€‚ç”¨äºå¸Œæœ›åœ¨ Spring å®¹å™¨ä¹‹å¤–ä½¿ç”¨ Spring Framework çš„äº‹åŠ¡æ”¯æŒçš„ç”¨æˆ·ã€‚</p>
<p>è§£é‡Š<code>@Transactional</code>æ³¨è§£ çš„åˆ‡é¢æ˜¯<code>AnnotationTransactionAspect</code>ã€‚ä½¿ç”¨æ­¤åˆ‡é¢æ—¶ï¼Œå¿…é¡»æ³¨è§£å®ç°ç±»(æˆ–è¯¥ç±»ä¸­çš„æ–¹æ³•æˆ–ä¸¤è€…)ï¼Œè€Œä¸æ˜¯æ³¨è§£è¯¥ç±»æ‰€å®ç°çš„æ¥å£(å¦‚æœæœ‰)ã€‚ AspectJ éµå¾ª Java çš„è§„åˆ™ï¼Œå³ä¸ç»§æ‰¿æ¥å£ä¸Šçš„ æ³¨è§£ã€‚</p>
<p>ç±»ä¸Šçš„<code>@Transactional</code>æ³¨è§£ æŒ‡å®šç”¨äºæ‰§è¡Œè¯¥ç±»ä¸­ä»»ä½•å…¬å…±æ“ä½œçš„é»˜è®¤äº‹åŠ¡è¯­ä¹‰ã€‚</p>
<p>ç±»å†…æ–¹æ³•ä¸Šçš„<code>@Transactional</code>æ³¨è§£ å°†è¦†ç›–ç±» æ³¨è§£(å¦‚æœå­˜åœ¨)ç»™å‡ºçš„é»˜è®¤äº‹åŠ¡è¯­ä¹‰ã€‚å¯ä»¥æ ‡æ³¨ä»»ä½•å¯è§æ€§çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰æ–¹æ³•ã€‚ç›´æ¥æ³¨è§£éå…¬å…±æ–¹æ³•æ˜¯æ‰§è¡Œæ­¤ç±»æ–¹æ³•è€Œè·å¾—äº‹åŠ¡åˆ’åˆ†çš„å”¯ä¸€æ–¹æ³•ã€‚</p>
<p>Tip</p>
<p>ä» Spring Framework 4.2 å¼€å§‹ï¼Œ<code>spring-aspects</code>æä¾›äº†ç±»ä¼¼çš„åˆ‡é¢ï¼Œä¸ºæ ‡å‡†<code>javax.transaction.Transactional</code>æ³¨è§£ æä¾›äº†å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ã€‚æ£€æŸ¥<code>JtaAnnotationTransactionAspect</code>äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<p>å¯¹äºå¸Œæœ›ä½¿ç”¨ Spring é…ç½®å’Œäº‹åŠ¡ Management æ”¯æŒä½†åˆä¸æƒ³(æˆ–ä¸èƒ½)ä½¿ç”¨æ³¨è§£çš„ AspectJ ç¨‹åºå‘˜ï¼Œ<code>spring-aspects.jar</code>è¿˜åŒ…å«<code>abstract</code>ä¸ªåˆ‡é¢ï¼Œæ‚¨å¯ä»¥æ‰©å±•å®ƒä»¬ä»¥æä¾›è‡ªå·±çš„åˆ‡å…¥ç‚¹å®šä¹‰ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<code>AbstractBeanConfigurerAspect</code>å’Œ<code>AbstractTransactionAspect</code>åˆ‡é¢çš„èµ„æºã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ‘˜å½•æ˜¾ç¤ºäº†å¦‚ä½•ç¼–å†™åˆ‡é¢æ¥ä½¿ç”¨ä¸å®Œå…¨é™å®šçš„ç±»ååŒ¹é…çš„åŸå‹ Bean å®šä¹‰æ¥é…ç½®åŸŸæ¨¡å‹ä¸­å®šä¹‰çš„å¯¹è±¡çš„æ‰€æœ‰å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> aspect DomainObjectConfiguration extends AbstractBeanConfigurerAspect &#123;    <span class="function"><span class="keyword">public</span> <span class="title">DomainObjectConfiguration</span><span class="params">()</span> </span>&#123;        setBeanWiringInfoResolver(<span class="keyword">new</span> ClassNameBeanWiringInfoResolver());    &#125;    <span class="comment">// the creation of a new bean (any object in the domain model)    protected pointcut beanCreation(Object beanInstance) :        initialization(new(..)) &amp;&amp;        SystemArchitecture.inDomainModel() &amp;&amp;        this(beanInstance);&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-10-3-ä½¿ç”¨-Spring-IoC-é…ç½®-AspectJ-Aspects"><a href="#5-10-3-ä½¿ç”¨-Spring-IoC-é…ç½®-AspectJ-Aspects" class="headerlink" title="5.10.3. ä½¿ç”¨ Spring IoC é…ç½® AspectJ Aspects"></a>5.10.3. ä½¿ç”¨ Spring IoC é…ç½® AspectJ Aspects</h3><p>å½“æ‚¨å°† AspectJ åˆ‡é¢ä¸ Spring åº”ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ—¢è‡ªç„¶åˆå¸Œæœ›èƒ½å¤Ÿä½¿ç”¨ Spring é…ç½®è¿™äº›åˆ‡é¢ã€‚ AspectJ è¿è¡Œæ—¶æœ¬èº«è´Ÿè´£åˆ‡é¢çš„åˆ›å»ºï¼Œå¹¶ä¸”é€šè¿‡ Spring é…ç½® AspectJ åˆ›å»ºçš„åˆ‡é¢çš„æ–¹æ³•å–å†³äºåˆ‡é¢æ‰€ä½¿ç”¨çš„ AspectJ å®ä¾‹åŒ–æ¨¡å‹(<code>per-xxx</code>å­å¥)ã€‚</p>
<p>AspectJ çš„å¤§å¤šæ•°åˆ‡é¢éƒ½æ˜¯å•ä¾‹åˆ‡é¢ã€‚è¿™äº›åˆ‡é¢çš„é…ç½®å¾ˆå®¹æ˜“ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ­£å¸¸å¼•ç”¨å¤–è§‚ç±»å‹å¹¶åŒ…å«<code>factory-method=&quot;aspectOf&quot;</code> bean å±æ€§çš„ bean å®šä¹‰ã€‚è¿™å¯ä»¥ç¡®ä¿ Spring é€šè¿‡å‘ AspectJ ç´¢è¦é•¿å®½æ¯”å®ä¾‹ï¼Œè€Œä¸æ˜¯å°è¯•è‡ªå·±åˆ›å»ºå®ä¾‹æ¥è·å¾—é•¿å®½æ¯”å®ä¾‹ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨<code>factory-method=&quot;aspectOf&quot;</code>å±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;profiler&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xyz.profiler.Profiler&quot;</span>        <span class="attr">factory-method</span>=<span class="string">&quot;aspectOf&quot;</span>&gt;</span> (1)    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;profilingStrategy&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;jamonProfilingStrategy&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>(1)</strong> è¯·æ³¨æ„<code>factory-method=&quot;aspectOf&quot;</code>å±æ€§</li>
</ul>
<p>éå•ä¸€åˆ‡é¢å¾ˆéš¾é…ç½®ã€‚ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºåŸå‹ bean å®šä¹‰å¹¶ä½¿ç”¨<code>spring-aspects.jar</code>çš„<code>@Configurable</code>æ”¯æŒæ¥é…ç½®åˆ‡é¢å®ä¾‹(ä¸€æ—¦ AspectJ è¿è¡Œæ—¶åˆ›å»ºäº† bean)æ¥å®ç°ã€‚</p>
<p>å¦‚æœæ‚¨æœ‰ä¸€äº›è¦ä¸ AspectJ ç¼–ç»‡çš„@AspectJ åˆ‡é¢(ä¾‹å¦‚ï¼Œå¯¹åŸŸæ¨¡å‹ç±»å‹ä½¿ç”¨åŠ è½½æ—¶ç¼–ç»‡)ä»¥åŠè¦ä¸ Spring AOP ä¸€èµ·ä½¿ç”¨çš„å…¶ä»–@AspectJ åˆ‡é¢ï¼Œé‚£ä¹ˆè¿™äº›åˆ‡é¢éƒ½å·²åœ¨ Spring ä¸­é…ç½®ï¼Œæ‚¨éœ€è¦å‘Šè¯‰ Spring AOP @AspectJ è‡ªåŠ¨ä»£ç†æ”¯æŒï¼Œåº”ä½¿ç”¨é…ç½®ä¸­å®šä¹‰çš„@AspectJ åˆ‡é¢çš„ç¡®åˆ‡å­é›†è¿›è¡Œè‡ªåŠ¨ä»£ç†ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>&lt;aop:aspectj-autoproxy/&gt;</code>å£°æ˜ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª<code>&lt;include/&gt;</code>å…ƒç´ æ¥å®Œæˆæ­¤æ“ä½œã€‚æ¯ä¸ª<code>&lt;include/&gt;</code>å…ƒç´ éƒ½æŒ‡å®šä¸€ä¸ªåç§°æ¨¡å¼ï¼Œå¹¶ä¸”åªæœ‰åç§°ä¸è‡³å°‘ä¸€ä¸ªæ¨¡å¼åŒ¹é…çš„ bean æ‰å¯ç”¨äº Spring AOP è‡ªåŠ¨ä»£ç†é…ç½®ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>&lt;include/&gt;</code>å…ƒç´ ï¼š</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;aop:aspectj-autoproxy&gt;    &lt;aop:include name=&quot;thisBean&quot;/&gt;    &lt;aop:include name=&quot;thatBean&quot;/&gt;&lt;/aop:aspectj-autoproxy&gt;</span></span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>ä¸è¦è¢«<code>&lt;aop:aspectj-autoproxy/&gt;</code>å…ƒç´ çš„åç§°æ‰€è¿·æƒ‘ã€‚ä½¿ç”¨å®ƒå¯ä»¥åˆ›å»º Spring AOP ä»£ç†ã€‚æ­¤å¤„ä½¿ç”¨äº†@AspectJ æ ·å¼çš„å£°æ˜ï¼Œä½†æ˜¯ä¸æ¶‰åŠ AspectJ è¿è¡Œæ—¶ã€‚</p>
<h3 id="5-10-4-åœ¨-Spring-Framework-ä¸­ä½¿ç”¨-AspectJ-è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡"><a href="#5-10-4-åœ¨-Spring-Framework-ä¸­ä½¿ç”¨-AspectJ-è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡" class="headerlink" title="5.10.4. åœ¨ Spring Framework ä¸­ä½¿ç”¨ AspectJ è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡"></a>5.10.4. åœ¨ Spring Framework ä¸­ä½¿ç”¨ AspectJ è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡</h3><p>åŠ è½½æ—¶ç¼–ç»‡(LTW)æ˜¯æŒ‡åœ¨å°† AspectJ åˆ‡é¢åŠ è½½åˆ°åº”ç”¨ç¨‹åºçš„ç±»æ–‡ä»¶ä¸­æ—¶å°†å®ƒä»¬ç¼–ç»‡åˆ° Java è™šæ‹Ÿæœº(JVM)ä¸­çš„è¿‡ç¨‹ã€‚æœ¬éƒ¨åˆ†çš„é‡ç‚¹æ˜¯åœ¨ Spring æ¡†æ¶çš„ç‰¹å®šä¸Šä¸‹æ–‡ä¸­é…ç½®å’Œä½¿ç”¨ LTWã€‚æœ¬èŠ‚ä¸æ˜¯ LTW çš„ä¸€èˆ¬ä»‹ç»ã€‚æœ‰å…³ LTW çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠä»…ä½¿ç”¨ AspectJ é…ç½® LTW(å®Œå…¨ä¸æ¶‰åŠ Spring)çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj/doc/released/devguide/ltw.html">AspectJ å¼€å‘ç¯å¢ƒæŒ‡å—çš„ LTW éƒ¨åˆ†</a>ã€‚</p>
<p>Spring æ¡†æ¶ä¸º AspectJ LTW å¸¦æ¥çš„ä»·å€¼åœ¨äºèƒ½å¤Ÿå¯¹ç¼–ç»‡è¿‡ç¨‹è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ã€‚ â€œé¦™è‰â€ AspectJ LTW é€šè¿‡ä½¿ç”¨ Java(5)ä»£ç†æ¥å®ç°ï¼Œè¯¥ä»£ç†é€šè¿‡åœ¨å¯åŠ¨ JVM æ—¶æŒ‡å®š VM å‚æ•°æ¥æ‰“å¼€ã€‚å› æ­¤ï¼Œå®ƒæ˜¯ä¸€ä¸ª JVM èŒƒå›´çš„è®¾ç½®ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¾ˆå¥½ï¼Œä½†é€šå¸¸æœ‰ç‚¹è¿‡äºç²—ç³™ã€‚å¯ç”¨äº† Spring çš„ LTW å…è®¸æ‚¨ä»¥<code>ClassLoader</code>ä¸ºåŸºç¡€æ‰“å¼€ LTWï¼Œå®ƒçš„ç²’åº¦æ›´ç»†ï¼Œå¹¶ä¸”åœ¨â€œå• JVM-å¤šåº”ç”¨ç¨‹åºâ€ç¯å¢ƒä¸­(ä¾‹å¦‚åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¸­å‘ç°)æ›´æœ‰æ„ä¹‰ã€‚ç¯å¢ƒ)ã€‚</p>
<p>æ­¤å¤–ï¼Œ<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw-environments">åœ¨æŸäº›ç¯å¢ƒä¸­</a>ï¼Œæ­¤æ”¯æŒå¯å®ç°åŠ è½½æ—¶ç¼–ç»‡ï¼Œè€Œæ— éœ€å¯¹æ·»åŠ <code>-javaagent:path/to/aspectjweaver.jar</code>æˆ–<code>-javaagent:path/to/org.springframework.instrument-&#123;version&#125;.jar</code>(ä»¥å‰ç§°ä¸º<code>spring-agent.jar</code>)æ‰€éœ€çš„åº”ç”¨æœåŠ¡å™¨çš„å¯åŠ¨è„šæœ¬è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚å¼€å‘äººå‘˜å¯ä»¥ä¿®æ”¹æ„æˆåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œä»¥å®ç°åŠ è½½æ—¶ç¼–ç»‡ï¼Œè€Œä¸å¿…ä¾èµ–é€šå¸¸è´Ÿè´£éƒ¨ç½²é…ç½®(ä¾‹å¦‚å¯åŠ¨è„šæœ¬)çš„ Management å‘˜ã€‚</p>
<p>ç°åœ¨ï¼Œé”€å”®å·¥ä½œå·²ç»ç»“æŸï¼Œè®©æˆ‘ä»¬é¦–å…ˆæµè§ˆä¸€ä¸ªä½¿ç”¨ Spring çš„ AspectJ LTW çš„å¿«é€Ÿç¤ºä¾‹ï¼Œç„¶åè¯¦ç»†ä»‹ç»ç¤ºä¾‹ä¸­å¼•å…¥çš„å…ƒç´ ã€‚æœ‰å…³å®Œæ•´ç¤ºä¾‹ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-petclinic">Petclinicsample ç”³è¯·</a>ã€‚</p>
<h4 id="ç¬¬ä¸€ä¸ªä¾‹å­"><a href="#ç¬¬ä¸€ä¸ªä¾‹å­" class="headerlink" title="ç¬¬ä¸€ä¸ªä¾‹å­"></a>ç¬¬ä¸€ä¸ªä¾‹å­</h4><p>å‡è®¾æ‚¨æ˜¯ä¸€ä½è´Ÿè´£è¯Šæ–­ç³»ç»Ÿä¸­æŸäº›æ€§èƒ½é—®é¢˜çš„åŸå› çš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€‚ä¸å…¶ä½¿ç”¨åˆ†æå·¥å…·ï¼Œä¸å¦‚ä½¿ç”¨ä¸€ä¸ªç®€å•çš„åˆ†æåˆ‡é¢ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿè·å¾—ä¸€äº›æ€§èƒ½ Metricsã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³åœ¨è¯¥ç‰¹å®šåŒºåŸŸåº”ç”¨æ›´ç»†ç²’åº¦çš„åˆ†æå·¥å…·ã€‚</p>
<p>Note</p>
<p>æ­¤å¤„æä¾›çš„ç¤ºä¾‹ä½¿ç”¨ XML é…ç½®ã€‚æ‚¨è¿˜å¯ä»¥å°†<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#beans-java">Java configuration</a>é…ç½®å’Œä½¿ç”¨@AspectJã€‚å…·ä½“æ¥è¯´ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>@EnableLoadTimeWeaving</code>æ³¨è§£ æ›¿ä»£<code>&lt;context:load-time-weaver/&gt;</code>(æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw-spring">below</a>)ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº†é…ç½®åˆ‡é¢ï¼Œå®ƒä¸æ˜¯èŠ±å“¨çš„-å®ƒæ˜¯åŸºäºæ—¶é—´çš„æ¢æŸ¥å™¨ï¼Œå®ƒä½¿ç”¨@AspectJ æ ·å¼çš„åˆ‡é¢å£°æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> foo;<span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;<span class="keyword">import</span> org.aspectj.lang.annotation.Around;<span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;<span class="keyword">import</span> org.springframework.util.StopWatch;<span class="keyword">import</span> org.springframework.core.annotation.Order;<span class="meta">@Aspectpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfilingAspect</span> </span>&#123;    <span class="meta">@Around(&quot;methodsToBeProfiled()&quot;)</span>    <span class="function"><span class="keyword">public</span> Object <span class="title">profile</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;        StopWatch sw = <span class="keyword">new</span> StopWatch(getClass().getSimpleName());        <span class="keyword">try</span> &#123;            sw.start(pjp.getSignature().getName());            <span class="keyword">return</span> pjp.proceed();        &#125; <span class="keyword">finally</span> &#123;            sw.stop();            System.out.println(sw.prettyPrint());        &#125;    &#125;    <span class="meta">@Pointcut(&quot;execution(public * foo..*.*(..))&quot;)</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodsToBeProfiled</span><span class="params">()</span></span>&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª<code>META-INF/aop.xml</code>æ–‡ä»¶ï¼Œä»¥é€šçŸ¥ AspectJ ç¼–ç»‡è€…æˆ‘ä»¬è¦å°†<code>ProfilingAspect</code>ç¼–ç»‡åˆ°ç±»ä¸­ã€‚æ­¤æ–‡ä»¶çº¦å®šï¼Œå³åœ¨ JavaClasspath ä¸Šåä¸º<code>META-INF/aop.xml</code>çš„æ–‡ä»¶ï¼Œæ˜¯æ ‡å‡† AspectJã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤º<code>aop.xml</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">aspectj</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//AspectJ//DTD//EN&quot;</span> <span class="meta-string">&quot;http://www.eclipse.org/aspectj/dtd/aspectj.dtd&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">aspectj</span>&gt;</span>    <span class="tag">&lt;<span class="name">weaver</span>&gt;</span>        <span class="comment">&lt;!-- only weave classes in our application-specific packages --&gt;</span>        <span class="tag">&lt;<span class="name">include</span> <span class="attr">within</span>=<span class="string">&quot;foo.*&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">weaver</span>&gt;</span>    <span class="tag">&lt;<span class="name">aspects</span>&gt;</span>        <span class="comment">&lt;!-- weave in just this aspect --&gt;</span>        <span class="tag">&lt;<span class="name">aspect</span> <span class="attr">name</span>=<span class="string">&quot;foo.ProfilingAspect&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">aspects</span>&gt;</span><span class="tag">&lt;/<span class="name">aspectj</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ continue è¿›è¡Œé…ç½®ä¸­ç‰¹å®šäº Spring çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸ª<code>LoadTimeWeaver</code>(ç¨åè¯´æ˜)ã€‚æ­¤åŠ è½½æ—¶ç»‡å¸ƒå™¨æ˜¯å¿…ä¸å¯å°‘çš„ç»„ä»¶ï¼Œè´Ÿè´£å°†ä¸€ä¸ªæˆ–å¤šä¸ª<code>META-INF/aop.xml</code>æ–‡ä»¶ä¸­çš„åˆ‡é¢é…ç½®ç¼–ç»‡åˆ°åº”ç”¨ç¨‹åºçš„ç±»ä¸­ã€‚å¥½å¤„æ˜¯ï¼Œå®ƒä¸éœ€è¦å¾ˆå¤šé…ç½®(æ‚¨å¯ä»¥æŒ‡å®šä¸€äº›å…¶ä»–é€‰é¡¹ï¼Œä½†æ˜¯ç¨åä¼šè¯¦ç»†ä»‹ç»)ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span>    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;        http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/context        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span>    <span class="comment">&lt;!-- a service object; we will be profiling its methods --&gt;</span>    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;entitlementCalculationService&quot;</span>            <span class="attr">class</span>=<span class="string">&quot;foo.StubEntitlementCalculationService&quot;</span>/&gt;</span>    <span class="comment">&lt;!-- this switches on the load-time weaving --&gt;</span>    <span class="tag">&lt;<span class="name">context:load-time-weaver</span>/&gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæ‰€æœ‰å¿…éœ€çš„æ„ä»¶(åˆ‡é¢ï¼Œ<code>META-INF/aop.xml</code>æ–‡ä»¶å’Œ Spring é…ç½®)éƒ½å°±ä½äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>main(..)</code>æ–¹æ³•åˆ›å»ºä»¥ä¸‹é©±åŠ¨ç¨‹åºç±»ï¼Œä»¥æ¼”ç¤ºå®é™…çš„ LTWï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> foo;<span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;beans.xml&quot;</span>, Main.class);        EntitlementCalculationService entitlementCalculationService            = (EntitlementCalculationService) ctx.getBean(<span class="string">&quot;entitlementCalculationService&quot;</span>);        <span class="comment">// the profiling aspect is &#x27;woven&#x27; around this method execution        entitlementCalculationService.calculateEntitlement();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜æœ‰æœ€åä¸€ä»¶äº‹è¦åšã€‚æœ¬èŠ‚çš„å¼•è¨€ç¡®å®è¯´è¿‡ï¼Œå¯ä»¥ä½¿ç”¨ Spring ä»¥<code>ClassLoader</code>ä¸ºåŸºç¡€é€‰æ‹©æ€§åœ°æ‰“å¼€ LTWï¼Œè¿™æ˜¯äº‹å®ã€‚ä½†æ˜¯ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Java ä»£ç†(Spring éšé™„)æ‰“å¼€ LTWã€‚æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œå‰é¢æ˜¾ç¤ºçš„<code>Main</code>ç±»ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:C:<span class="regexp">/projects/</span>foo/lib/<span class="built_in">global</span>/spring-instrument.jar foo.Main</span><br></pre></td></tr></table></figure>

<p><code>-javaagent</code>æ˜¯ç”¨äºæŒ‡å®šå’Œå¯ç”¨<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/api/java/lang/instrument/package-summary.html">ä»£ç†æ¥æ£€æµ‹åœ¨ JVM ä¸Šè¿è¡Œçš„ç¨‹åº</a>çš„æ ‡å¿—ã€‚ Spring æ¡†æ¶é™„å¸¦äº†è¿™æ ·çš„ä»£ç†<code>InstrumentationSavingAgent</code>ï¼Œè¯¥ä»£ç†æ‰“åŒ…åœ¨<code>spring-instrument.jar</code>ä¸­ï¼Œåœ¨ä¸Šä¸€ç¤ºä¾‹ä¸­ï¼Œè¯¥ä»£ç†ä½œä¸º<code>-javaagent</code>è‡ªå˜é‡çš„å€¼æä¾›ã€‚</p>
<p><code>Main</code>ç¨‹åºçš„æ‰§è¡Œè¾“å‡ºç±»ä¼¼äºä¸‹ä¸€ä¸ªç¤ºä¾‹ã€‚ (æˆ‘åœ¨<code>calculateEntitlement()</code>å®ç°ä¸­å¼•å…¥äº†<code>Thread.sleep(..)</code>è¯­å¥ï¼Œä»¥ä¾¿æ¢æŸ¥å™¨å®é™…ä¸Šæ•è·çš„ä¸æ˜¯ 0 æ¯«ç§’(<code>01234</code>æ¯«ç§’ä¸æ˜¯ AOP å¼•å…¥çš„å¼€é”€)ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†è¿è¡Œæ¢æŸ¥å™¨æ—¶å¾—åˆ°çš„è¾“å‡ºï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Calculating entitlementStopWatch <span class="string">&#x27;ProfilingAspect&#x27;</span>: <span class="built_in">running</span> <span class="built_in">time</span> (millis) = <span class="number">1234</span><span class="comment">------ ----- ----------------------------ms     %     Task name------ ----- ----------------------------01234  100%  calculateEntitlement</span></span><br></pre></td></tr></table></figure>

<p>ç”±äºæ­¤ LTW æ˜¯é€šè¿‡ä½¿ç”¨æˆç†Ÿçš„ AspectJ æ¥å®ç°çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä»…é™äºå»ºè®® Spring Beanã€‚ <code>Main</code>ç¨‹åºçš„ä»¥ä¸‹ç»†å¾®å˜åŒ–ä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> foo;<span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;beans.xml&quot;</span>, Main.class);        EntitlementCalculationService entitlementCalculationService =            <span class="keyword">new</span> StubEntitlementCalculationService();        <span class="comment">// the profiling aspect will be &#x27;woven&#x27; around this method execution        entitlementCalculationService.calculateEntitlement();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œåœ¨å‰é¢çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¦‚ä½•å¼•å¯¼ Spring å®¹å™¨ï¼Œç„¶åå®Œå…¨åœ¨ Spring ä¸Šä¸‹æ–‡ä¹‹å¤–åˆ›å»º<code>StubEntitlementCalculationService</code>çš„æ–°å®ä¾‹ã€‚å‰–æå»ºè®®ä»ä¼šè¢«åº”ç”¨ã€‚</p>
<p>è¯šç„¶ï¼Œè¿™ä¸ªä¾‹å­å¾ˆç®€å•ã€‚ä½†æ˜¯ï¼Œåœ¨å‰é¢çš„ç¤ºä¾‹ä¸­å·²ç»ä»‹ç»äº† Spring å¯¹ LTW æ”¯æŒçš„åŸºç¡€ï¼Œæœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†è¯¦ç»†è§£é‡Šäº†æ¯ä¸€ä½é…ç½®å’Œç”¨æ³•çš„â€œåŸå› â€ã€‚</p>
<p>Note</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ä½¿ç”¨çš„<code>ProfilingAspect</code>å¯èƒ½æ˜¯åŸºæœ¬çš„ï¼Œä½†å¾ˆæœ‰ç”¨ã€‚è¿™æ˜¯å¼€å‘æ—¶åˆ‡é¢çš„ä¸€ä¸ªå¾ˆå¥½çš„ç¤ºä¾‹ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨å®ƒï¼Œç„¶åè½»æ¾åœ°å°†å…¶ä»éƒ¨ç½²åˆ° UAT æˆ– Producing çš„åº”ç”¨ç¨‹åºæ„å»ºä¸­æ’é™¤ã€‚</p>
<h4 id="Aspects"><a href="#Aspects" class="headerlink" title="Aspects"></a>Aspects</h4><p>æ‚¨åœ¨ LTW ä¸­ä½¿ç”¨çš„åˆ‡é¢å¿…é¡»æ˜¯ AspectJ åˆ‡é¢ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ AspectJ è¯­è¨€æœ¬èº«æ¥ç¼–å†™å®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@AspectJ é£æ ¼æ¥ç¼–å†™åˆ‡é¢ã€‚è¿™æ ·ï¼Œæ‚¨çš„åˆ‡é¢å°±æ˜¯æœ‰æ•ˆçš„ AspectJ å’Œ Spring AOP åˆ‡é¢ã€‚æ­¤å¤–ï¼Œç¼–è¯‘çš„åˆ‡é¢ç±»éœ€è¦åœ¨ Classpath ä¸Šå¯ç”¨ã€‚</p>
<h4 id="â€˜META-INF-aop-xmlâ€™"><a href="#â€˜META-INF-aop-xmlâ€™" class="headerlink" title="â€˜META-INF/aop.xmlâ€™"></a>â€˜META-INF/aop.xmlâ€™</h4><p>é€šè¿‡ä½¿ç”¨ JavaClasspath ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ª<code>META-INF/aop.xml</code>æ–‡ä»¶(ç›´æ¥æˆ–é€šå¸¸åœ¨ jar æ–‡ä»¶ä¸­)æ¥é…ç½® AspectJ LTW åŸºç¡€ç»“æ„ã€‚</p>
<p>è¯¥æ–‡ä»¶çš„ç»“æ„å’Œå†…å®¹åœ¨ LTW éƒ¨åˆ†<a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj/doc/released/devguide/ltw-configuration.html">AspectJ å‚è€ƒæ–‡æ¡£</a>ä¸­è¯¦ç»†ä»‹ç»ã€‚ç”±äº aop.xml æ–‡ä»¶æ˜¯ 100ï¼…AspectJï¼Œå› æ­¤åœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p>
<h4 id="å¿…éœ€çš„åº“-JARS"><a href="#å¿…éœ€çš„åº“-JARS" class="headerlink" title="å¿…éœ€çš„åº“(JARS)"></a>å¿…éœ€çš„åº“(JARS)</h4><p>è‡³å°‘ï¼Œæ‚¨éœ€è¦ä»¥ä¸‹åº“æ¥ä½¿ç”¨ Spring Framework å¯¹ AspectJ LTW çš„æ”¯æŒï¼š</p>
<ul>
<li><code>spring-aop.jar</code>(2.5 ç‰ˆæˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥åŠæ‰€æœ‰å¼ºåˆ¶æ€§ä¾èµ–é¡¹)</li>
<li><code>aspectjweaver.jar</code>(1.6.8 ç‰ˆæˆ–æ›´é«˜ç‰ˆæœ¬)</li>
</ul>
<p>å¦‚æœæ‚¨ä½¿ç”¨<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw-environment-generic">Spring æä¾›çš„ä»£ç†ç¨‹åºå¯å®ç°æ£€æµ‹</a>ï¼Œåˆ™è¿˜éœ€è¦ï¼š</p>
<ul>
<li><code>spring-instrument.jar</code></li>
</ul>
<h4 id="Spring-Configuration"><a href="#Spring-Configuration" class="headerlink" title="Spring Configuration"></a>Spring Configuration</h4><p>Spring çš„ LTW æ”¯æŒä¸­çš„å…³é”®ç»„ä»¶æ˜¯<code>LoadTimeWeaver</code>æ¥å£(åœ¨<code>org.springframework.instrument.classloading</code>åŒ…ä¸­)ï¼Œä»¥åŠ Spring å‘è¡Œç‰ˆé™„å¸¦çš„ä¼—å¤šå®ç°ã€‚ <code>LoadTimeWeaver</code>è´Ÿè´£åœ¨è¿è¡Œæ—¶å°†ä¸€ä¸ªæˆ–å¤šä¸ª<code>java.lang.instrument.ClassFileTransformers</code>æ·»åŠ åˆ°<code>ClassLoader</code>ï¼Œè¿™ä¸ºå„ç§æœ‰è¶£çš„åº”ç”¨ç¨‹åºæ‰“å¼€äº†å¤§é—¨ï¼Œå…¶ä¸­ä¹‹ä¸€æ°å¥½æ˜¯åˆ‡é¢çš„ LTWã€‚</p>
<p>Tip</p>
<p>å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰è¿è¡Œæ—¶ç±»æ–‡ä»¶è½¬æ¢çš„æ¦‚å¿µï¼Œè¯·åœ¨ continue ä¹‹å‰å…ˆæŸ¥çœ‹<code>java.lang.instrument</code>è½¯ä»¶åŒ…çš„ javadoc API æ–‡æ¡£ã€‚è™½ç„¶è¯¥æ–‡æ¡£å¹¶ä¸å…¨é¢ï¼Œä½†æ˜¯è‡³å°‘æ‚¨å¯ä»¥çœ‹åˆ°å…³é”®çš„æ¥å£å’Œç±»(åœ¨æ‚¨é˜…è¯»æœ¬èŠ‚æ—¶ä½œä¸ºå‚è€ƒ)ã€‚</p>
<p>ä¸ºç‰¹å®šçš„<code>ApplicationContext</code>é…ç½®<code>LoadTimeWeaver</code>å°±åƒæ·»åŠ ä¸€è¡Œä¸€æ ·å®¹æ˜“ã€‚ (è¯·æ³¨æ„ï¼Œæ‚¨å‡ ä¹è‚¯å®šéœ€è¦ä½¿ç”¨<code>ApplicationContext</code>ä½œä¸ºæ‚¨çš„ Spring å®¹å™¨â€”é€šå¸¸ï¼Œ<code>BeanFactory</code>æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸º LTW æ”¯æŒä½¿ç”¨<code>BeanFactoryPostProcessors</code>.)</p>
<p>è¦å¯ç”¨ Spring Framework çš„ LTW æ”¯æŒï¼Œæ‚¨éœ€è¦é…ç½®<code>LoadTimeWeaver</code>ï¼Œé€šå¸¸é€šè¿‡ä½¿ç”¨<code>@EnableLoadTimeWeaving</code>æ³¨è§£æ¥å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span><span class="variable">@EnableLoadTimeWeavingpublic</span> class AppConfig &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œå¦‚æœæ‚¨æ›´å–œæ¬¢åŸºäº XML çš„é…ç½®ï¼Œè¯·ä½¿ç”¨<code>&lt;context:load-time-weaver/&gt;</code>å…ƒç´ ã€‚è¯·æ³¨æ„ï¼Œè¯¥å…ƒç´ æ˜¯åœ¨<code>context</code>åç§°ç©ºé—´ä¸­å®šä¹‰çš„ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>&lt;context:load-time-weaver/&gt;</code>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span>    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;        http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/context        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">context:load-time-weaver</span>/&gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„é…ç½®ä¼šè‡ªåŠ¨ä¸ºæ‚¨å®šä¹‰å¹¶æ³¨å†Œè®¸å¤š LTW ç‰¹å®šçš„åŸºç¡€ç»“æ„ Beanï¼Œä¾‹å¦‚<code>LoadTimeWeaver</code>å’Œ<code>AspectJWeavingEnabler</code>ã€‚ç¼ºçœ<code>LoadTimeWeaver</code>æ˜¯<code>DefaultContextLoadTimeWeaver</code>ç±»ï¼Œå®ƒå°†å°è¯•è£…é¥°è‡ªåŠ¨æ£€æµ‹åˆ°çš„<code>LoadTimeWeaver</code>ã€‚ â€œè‡ªåŠ¨æ£€æµ‹åˆ°â€çš„<code>LoadTimeWeaver</code>çš„ç¡®åˆ‡ç±»å‹å–å†³äºæ‚¨çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚ä¸‹è¡¨æ€»ç»“äº†å„ç§<code>LoadTimeWeaver</code>å®ç°ï¼š</p>
<p>*è¡¨ 13. DefaultContextLoadTimeWeaver LoadTimeWeavers *</p>
<table>
<thead>
<tr>
<th>Runtime Environment</th>
<th><code>LoadTimeWeaver</code>å®æ–½</th>
</tr>
</thead>
<tbody><tr>
<td>åœ¨ Oracle çš„<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/middleware/weblogic/overview/index-085209.html">WebLogic</a>ä¸­è¿è¡Œ</td>
<td><code>WebLogicLoadTimeWeaver</code></td>
</tr>
<tr>
<td>åœ¨ Oracle çš„<a target="_blank" rel="noopener" href="http://glassfish.dev.java.net/">GlassFish</a>ä¸­è¿è¡Œ</td>
<td><code>GlassFishLoadTimeWeaver</code></td>
</tr>
<tr>
<td>åœ¨<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">Apache Tomcat</a>ä¸­è¿è¡Œ</td>
<td><code>TomcatLoadTimeWeaver</code></td>
</tr>
<tr>
<td>åœ¨ Red Hat çš„<a target="_blank" rel="noopener" href="http://www.jboss.org/jbossas/">JBoss AS</a>æˆ–<a target="_blank" rel="noopener" href="http://www.wildfly.org/">WildFly</a>ä¸­è¿è¡Œ</td>
<td><code>JBossLoadTimeWeaver</code></td>
</tr>
<tr>
<td>åœ¨ IBM çš„<a target="_blank" rel="noopener" href="https://www-01.ibm.com/software/webservers/appserv/was/">WebSphere</a>ä¸­è¿è¡Œ</td>
<td><code>WebSphereLoadTimeWeaver</code></td>
</tr>
<tr>
<td>JVM ä» Spring <code>InstrumentationSavingAgent</code>(<code>java -javaagent:path/to/spring-instrument.jar</code>)å¼€å§‹</td>
<td><code>InstrumentationLoadTimeWeaver</code></td>
</tr>
<tr>
<td>å›é€€ï¼ŒæœŸæœ›åŸºç¡€ ClassLoader éµå¾ªé€šç”¨çº¦å®š(ä¾‹å¦‚é€‚ç”¨äº<code>TomcatInstrumentableClassLoader</code>å’Œ<a target="_blank" rel="noopener" href="http://www.caucho.com/">Resin</a>)</td>
<td><code>ReflectiveLoadTimeWeaver</code></td>
</tr>
</tbody></table>
<p>è¯·æ³¨æ„ï¼Œè¯¥è¡¨ä»…åˆ—å‡ºäº†ä½¿ç”¨<code>DefaultContextLoadTimeWeaver</code>æ—¶è‡ªåŠ¨æ£€æµ‹åˆ°çš„<code>LoadTimeWeavers</code>ã€‚æ‚¨å¯ä»¥ç¡®åˆ‡æŒ‡å®šè¦ä½¿ç”¨çš„<code>LoadTimeWeaver</code>å®ç°ã€‚</p>
<p>è¦ä½¿ç”¨ Java é…ç½®æŒ‡å®šç‰¹å®šçš„<code>LoadTimeWeaver</code>ï¼Œè¯·å®ç°<code>LoadTimeWeavingConfigurer</code>æ¥å£å¹¶è¦†ç›–<code>getLoadTimeWeaver()</code>æ–¹æ³•ã€‚ä»¥ä¸‹ç¤ºä¾‹æŒ‡å®š<code>ReflectiveLoadTimeWeaver</code>ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span><span class="variable">@EnableLoadTimeWeavingpublic</span> class AppConfig implements LoadTimeWeavingConfigurer &#123;    <span class="variable">@Override</span>    public LoadTimeWeaver getLoadTimeWeaver() &#123;        <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">ReflectiveLoadTimeWeaver</span>();    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨åŸºäº XML çš„é…ç½®ï¼Œåˆ™å¯ä»¥å°†å®Œå…¨é™å®šçš„ç±»åæŒ‡å®šä¸º<code>&lt;context:load-time-weaver/&gt;</code>å…ƒç´ ä¸Šçš„<code>weaver-class</code>å±æ€§çš„å€¼ã€‚åŒæ ·ï¼Œä»¥ä¸‹ç¤ºä¾‹æŒ‡å®š<code>ReflectiveLoadTimeWeaver</code>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span>    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;        http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/context        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">context:load-time-weaver</span>            <span class="attr">weaver-class</span>=<span class="string">&quot;org.springframework.instrument.classloading.ReflectiveLoadTimeWeaver&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»¥åå¯ä»¥ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„åç§°<code>loadTimeWeaver</code>ä» Spring å®¹å™¨ä¸­æ£€ç´¢ç”±é…ç½®å®šä¹‰å’Œæ³¨å†Œçš„<code>LoadTimeWeaver</code>ã€‚è¯·è®°ä½ï¼Œ<code>LoadTimeWeaver</code>ä»…ä½œä¸º Spring çš„ LTW åŸºç¡€ç»“æ„æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ª<code>ClassFileTransformers</code>çš„æœºåˆ¶è€Œå­˜åœ¨ã€‚æ‰§è¡Œ LTW çš„å®é™…<code>ClassFileTransformer</code>æ˜¯<code>ClassPreProcessorAgentAdapter</code>(æ¥è‡ª<code>org.aspectj.weaver.loadtime</code>ç¨‹åºåŒ…)ç±»ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<code>ClassPreProcessorAgentAdapter</code>ç±»çš„ç±»çº§ javadocï¼Œå› ä¸ºå®é™…ä¸Šå¦‚ä½•å®ç°ç¼–ç»‡çš„ç»†èŠ‚ä¸åœ¨æœ¬æ–‡æ¡£çš„è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚</p>
<p>è¿˜éœ€è¦è®¨è®ºé…ç½®çš„æœ€åä¸€ä¸ªå±æ€§ï¼š<code>aspectjWeaving</code>å±æ€§(å¦‚æœä½¿ç”¨ XMLï¼Œåˆ™ä¸º<code>aspectj-weaving</code>)ã€‚æ­¤å±æ€§æ§åˆ¶æ˜¯å¦å¯ç”¨ LTWã€‚å®ƒæ¥å—ä¸‰ä¸ªå¯èƒ½çš„å€¼ä¹‹ä¸€ï¼Œå¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™é»˜è®¤å€¼ä¸º<code>autodetect</code>ã€‚ä¸‹è¡¨æ€»ç»“äº†ä¸‰ä¸ªå¯èƒ½çš„å€¼ï¼š</p>
<p><em>è¡¨ 14. AspectJ ç¼–ç»‡å±æ€§å€¼</em></p>
<table>
<thead>
<tr>
<th>Annotation Value</th>
<th>XML Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody><tr>
<td><code>ENABLED</code></td>
<td><code>on</code></td>
<td>AspectJ æ­£åœ¨ç¼–ç»‡ï¼Œå¹¶ä¸”åœ¨åŠ è½½æ—¶é€‚å½“åœ°ç¼–ç»‡äº†åˆ‡é¢ã€‚</td>
</tr>
<tr>
<td><code>DISABLED</code></td>
<td><code>off</code></td>
<td>LTW å·²å…³é—­ã€‚åŠ è½½æ—¶ä¸ä¼šç¼–ç»‡ä»»ä½•åˆ‡é¢ã€‚</td>
</tr>
<tr>
<td><code>AUTODETECT</code></td>
<td><code>autodetect</code></td>
<td>å¦‚æœ Spring LTW åŸºç¡€ç»“æ„å¯ä»¥æ‰¾åˆ°è‡³å°‘ä¸€ä¸ª<code>META-INF/aop.xml</code>æ–‡ä»¶ï¼Œåˆ™è¡¨ç¤º AspectJ ç¼–ç»‡å·²å¼€å§‹ã€‚å¦åˆ™ï¼Œå®ƒå…³é—­ã€‚è¿™æ˜¯é»˜è®¤å€¼ã€‚</td>
</tr>
</tbody></table>
<h4 id="Environment-specific-Configuration"><a href="#Environment-specific-Configuration" class="headerlink" title="Environment-specific Configuration"></a>Environment-specific Configuration</h4><p>æœ€åä¸€éƒ¨åˆ†åŒ…å«åœ¨åº”ç”¨ç¨‹åºæœåŠ¡å™¨å’Œ Web å®¹å™¨ç­‰ç¯å¢ƒä¸­ä½¿ç”¨ Spring çš„ LTW æ”¯æŒæ—¶æ‰€éœ€çš„æ‰€æœ‰å…¶ä»–è®¾ç½®å’Œé…ç½®ã€‚</p>
<h4 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h4><p>ä»å†å²ä¸Šçœ‹ï¼Œ<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">Apache Tomcat</a>çš„é»˜è®¤ç±»åŠ è½½å™¨ä¸æ”¯æŒç±»è½¬æ¢ï¼Œå› æ­¤ Spring æä¾›äº†å¢å¼ºçš„å®ç°æ¥æ»¡è¶³æ­¤éœ€æ±‚ã€‚åä¸º<code>TomcatInstrumentableClassLoader</code>çš„åŠ è½½ç¨‹åºå¯åœ¨ Tomcat 6.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p>
<p>Tip</p>
<p>ä¸è¦åœ¨ Tomcat 8.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šå®šä¹‰<code>TomcatInstrumentableClassLoader</code>ã€‚ç›¸åï¼Œè®© Spring é€šè¿‡<code>TomcatLoadTimeWeaver</code>ç­–ç•¥è‡ªåŠ¨ä½¿ç”¨ Tomcat çš„æ–°æœ¬æœº<code>InstrumentableClassLoader</code>å·¥å…·ã€‚</p>
<p>å¦‚æœä»ç„¶éœ€è¦ä½¿ç”¨<code>TomcatInstrumentableClassLoader</code>ï¼Œåˆ™å¯ä»¥ä¸ºæ¯ä¸ª Web åº”ç”¨ç¨‹åºåˆ†åˆ«è¿›è¡Œæ³¨å†Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>å°†<code>org.springframework.instrument.tomcat.jar</code>å¤åˆ¶åˆ°<code>$CATALINA_HOME/lib</code>ï¼Œå…¶ä¸­<code>$CATALINA_HOME</code>ä»£è¡¨ Tomcat å®‰è£…çš„æ ¹ç›®å½•</li>
<li>é€šè¿‡ç¼–è¾‘ Web åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡æ–‡ä»¶ï¼ŒæŒ‡ç¤º Tomcat ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨(è€Œä¸æ˜¯é»˜è®¤å€¼)ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/myWebApp&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;/my/webApp/location&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">Loader</span>        <span class="attr">loaderClass</span>=<span class="string">&quot;org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Apache Tomcat 6.0 æ”¯æŒå¤šä¸ªä¸Šä¸‹æ–‡ä½ç½®ï¼š</p>
<ul>
<li>æœåŠ¡å™¨é…ç½®æ–‡ä»¶ï¼š<code>$CATALINA_HOME/conf/server.xml</code></li>
<li>é»˜è®¤ä¸Šä¸‹æ–‡é…ç½®ï¼š<code>$CATALINA_HOME/conf/context.xml</code>ï¼Œè¿™ä¼šå½±å“æ‰€æœ‰å·²éƒ¨ç½²çš„ Web åº”ç”¨ç¨‹åº</li>
<li>æ¯ä¸ª Web åº”ç”¨ç¨‹åºé…ç½®ï¼Œå¯ä»¥åœ¨<code>$CATALINA_HOME/conf/[enginename]/[hostname]/[webapp]-context.xml</code>éƒ¨ç½²åœ¨æœåŠ¡å™¨ç«¯ï¼Œä¹Ÿå¯ä»¥åœ¨<code>META-INF/context.xml</code>åµŒå…¥åœ¨ Web åº”ç”¨ç¨‹åºå­˜æ¡£ä¸­</li>
</ul>
<p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨åµŒå…¥å¼çš„é€ä¸ª Web åº”ç”¨ç¨‹åºé…ç½®æ ·å¼ï¼Œå› ä¸ºå®ƒåªå½±å“ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¹æœåŠ¡å™¨é…ç½®è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚æœ‰å…³å¯ç”¨ä¸Šä¸‹æ–‡ä½ç½®çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ Tomcat 6.0.x <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-6.0-doc/config/context.html">documentation</a>ã€‚</p>
<p>æˆ–è€…ï¼Œè€ƒè™‘ä½¿ç”¨ Spring æä¾›çš„é€šç”¨ VM ä»£ç†ï¼Œè¯¥ä»£ç†åœ¨ Tomcat çš„å¯åŠ¨è„šæœ¬ä¸­æŒ‡å®š(æœ¬èŠ‚å‰é¢å·²æè¿°)ã€‚è¿™ä½¿å¾—æ£€æµ‹å¯¹æ‰€æœ‰å·²éƒ¨ç½²çš„ Web åº”ç”¨ç¨‹åºå‡å¯ç”¨ï¼Œæ— è®ºå®ƒä»¬è¿è¡Œåœ¨<code>ClassLoader</code>ä¸Šã€‚</p>
<h6 id="WebLogicï¼ŒWebSphereï¼ŒResinï¼ŒGlassFish-å’Œ-JBoss"><a href="#WebLogicï¼ŒWebSphereï¼ŒResinï¼ŒGlassFish-å’Œ-JBoss" class="headerlink" title="WebLogicï¼ŒWebSphereï¼ŒResinï¼ŒGlassFish å’Œ JBoss"></a>WebLogicï¼ŒWebSphereï¼ŒResinï¼ŒGlassFish å’Œ JBoss</h6><p>æœ€æ–°ç‰ˆæœ¬çš„ WebLogic Server(ç‰ˆæœ¬ 10 å’Œæ›´é«˜ç‰ˆæœ¬)ï¼ŒIBM WebSphere Application Server(ç‰ˆæœ¬ 7 å’Œæ›´é«˜ç‰ˆæœ¬)ï¼ŒResin(ç‰ˆæœ¬ 3.1 å’Œæ›´é«˜ç‰ˆæœ¬)ä»¥åŠ JBoss(ç‰ˆæœ¬ 6.x æˆ–æ›´é«˜ç‰ˆæœ¬)æä¾›äº†<code>ClassLoader</code>å¹¶èƒ½å¤Ÿè¿›è¡Œæœ¬åœ°æ£€æµ‹ã€‚ Spring çš„æœ¬åœ° LTW åˆ©ç”¨æ­¤ç±» ClassLoader å®ç°æ¥å®ç° AspectJ ç¼–ç»‡ã€‚æ‚¨å¯ä»¥é€šè¿‡æ¿€æ´»åŠ è½½æ—¶ç¼–ç»‡æ¥å¯ç”¨ LTWï¼Œå¦‚<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-using-aspectj">described earlier</a>ã€‚å…·ä½“æ¥è¯´ï¼Œæ‚¨æ— éœ€ä¿®æ”¹å¯åŠ¨è„šæœ¬å³å¯æ·»åŠ <code>-javaagent:path/to/spring-instrument.jar</code>ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå…·æœ‰ GlassFish å·¥å…·åŠŸèƒ½çš„<code>ClassLoader</code>ä»…åœ¨å…¶ EAR ç¯å¢ƒä¸­å¯ç”¨ã€‚å¯¹äº GlassFish Web åº”ç”¨ç¨‹åºï¼Œè¯·éµå¾ª Tomcat è®¾ç½®è¯´æ˜<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-aj-ltw-environment-tomcat">outlined earlier</a>ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œåœ¨ JBoss 6.x ä¸Šï¼Œæ‚¨éœ€è¦ç¦ç”¨åº”ç”¨æœåŠ¡å™¨æ‰«æï¼Œä»¥é˜²æ­¢å®ƒåœ¨åº”ç”¨ç¨‹åºå®é™…å¯åŠ¨ä¹‹å‰åŠ è½½ç±»ã€‚ä¸€ä¸ªå¿«é€Ÿçš„è§£å†³æ–¹æ³•æ˜¯å°†åä¸º<code>WEB-INF/jboss-scanning.xml</code>çš„æ–‡ä»¶æ·»åŠ åˆ°æ‚¨çš„å·¥ä»¶ä¸­ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scanning</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:jboss:scanning:1.0&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="é€šç”¨-Java-åº”ç”¨ç¨‹åº"><a href="#é€šç”¨-Java-åº”ç”¨ç¨‹åº" class="headerlink" title="é€šç”¨ Java åº”ç”¨ç¨‹åº"></a>é€šç”¨ Java åº”ç”¨ç¨‹åº</h4><p>åœ¨ä¸æ”¯æŒæˆ–ç°æœ‰<code>LoadTimeWeaver</code>å®ç°ä¸æ”¯æŒçš„ç¯å¢ƒä¸­éœ€è¦ç±»æ£€æµ‹æ—¶ï¼ŒJDK ä»£ç†å¯ä»¥æ˜¯å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒSpring æä¾›äº†<code>InstrumentationLoadTimeWeaver</code>ï¼Œè¿™éœ€è¦ä¸€ä¸ª Spring ç‰¹å®š(ä½†éå¸¸é€šç”¨)çš„ VM ä»£ç†<code>org.springframework.instrument-&#123;version&#125;.jar</code>(ä»¥å‰ç§°ä¸º<code>spring-agent.jar</code>)ã€‚</p>
<p>è¦ä½¿ç”¨å®ƒï¼Œæ‚¨å¿…é¡»é€šè¿‡æä¾›ä»¥ä¸‹ JVM é€‰é¡¹æ¥ä½¿ç”¨ Spring ä»£ç†å¯åŠ¨è™šæ‹Ÿæœºï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:<span class="regexp">/path/</span>to/org.springframework.instrument-&#123;version&#125;.jar</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œè¿™éœ€è¦ä¿®æ”¹ VM å¯åŠ¨è„šæœ¬ï¼Œè¿™å¯èƒ½ä¼šé˜»æ­¢æ‚¨åœ¨åº”ç”¨ç¨‹åºæœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨å®ƒ(å–å†³äºæ‚¨çš„æ“ä½œç­–ç•¥)ã€‚æ­¤å¤–ï¼ŒJDK ä»£ç†ä¼šæ£€æµ‹æ•´ä¸ª VMï¼Œè¿™å¯èƒ½ä¼šå¾ˆæ˜‚è´µã€‚</p>
<p>å‡ºäºæ€§èƒ½åŸå› ï¼Œæˆ‘ä»¬å»ºè®®ä»…åœ¨ç›®æ ‡ç¯å¢ƒ(ä¾‹å¦‚<a target="_blank" rel="noopener" href="https://www.eclipse.org/jetty/">Jetty</a>)æ²¡æœ‰(æˆ–ä¸æ”¯æŒ)ä¸“ç”¨ LTW çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨æ­¤é…ç½®ã€‚</p>
<h2 id="5-11-æ›´å¤šèµ„æº"><a href="#5-11-æ›´å¤šèµ„æº" class="headerlink" title="5.11. æ›´å¤šèµ„æº"></a>5.11. æ›´å¤šèµ„æº</h2><p>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj">AspectJ website</a>ä¸Šæ‰¾åˆ°æœ‰å…³ AspectJ çš„æ›´å¤šä¿¡æ¯ã€‚</p>
<ul>
<li>Adrian Colyer ç­‰äººçš„ã€Š Eclipse AspectJ *ã€‹ã€‚ç­‰(Addison-Wesleyï¼Œ2005 å¹´)ä¸º AspectJ è¯­è¨€æä¾›äº†å…¨é¢çš„ä»‹ç»å’Œå‚è€ƒã€‚</li>
</ul>
<p>å¼ºçƒˆæ¨è Ramnivas Laddad(Manningï¼Œ2009)å‡ºç‰ˆçš„ã€Š AspectJ in Action *ã€‹ç¬¬äºŒç‰ˆã€‚æœ¬ä¹¦çš„é‡ç‚¹æ˜¯ AspectJï¼Œä½†åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¢è®¨äº†è®¸å¤šé€šç”¨çš„ AOP ä¸»é¢˜ã€‚</p>
<h2 id="6-Spring-AOP-API"><a href="#6-Spring-AOP-API" class="headerlink" title="6. Spring AOP API"></a>6. Spring AOP API</h2><p>ä¸Šä¸€ç« ä½¿ç”¨@AspectJ å’ŒåŸºäºæ¨¡å¼çš„åˆ‡é¢å®šä¹‰æè¿°äº† Spring å¯¹ AOP çš„æ”¯æŒã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºè¾ƒä½çº§åˆ«çš„ Spring AOP API å’Œé€šå¸¸åœ¨ Spring 1.2 åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„ AOP æ”¯æŒã€‚å¯¹äºæ–°åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ä¸Šä¸€ç« ä¸­ä»‹ç»çš„ Spring 2.0 å’Œæ›´é«˜ç‰ˆæœ¬çš„ AOP æ”¯æŒã€‚ä½†æ˜¯ï¼Œå½“æ‚¨ä½¿ç”¨ç°æœ‰åº”ç”¨ç¨‹åº(æˆ–é˜…è¯»ä¹¦ç±å’Œæ–‡ç« )æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ° Spring 1.2 æ ·å¼çš„ç¤ºä¾‹ã€‚ Spring 5 ä»ç„¶ä¸ Spring 1.2 å‘åå…¼å®¹ï¼ŒSpring 5 å®Œå…¨æ”¯æŒæœ¬ç« ä¸­æè¿°çš„æ‰€æœ‰å†…å®¹ã€‚</p>
<h3 id="6-1-Spring-ä¸­çš„-Pointcut-API"><a href="#6-1-Spring-ä¸­çš„-Pointcut-API" class="headerlink" title="6.1. Spring ä¸­çš„ Pointcut API"></a>6.1. Spring ä¸­çš„ Pointcut API</h3><p>æœ¬èŠ‚æè¿°äº† Spring å¦‚ä½•å¤„ç†å…³é”®åˆ‡å…¥ç‚¹æ¦‚å¿µã€‚</p>
<h4 id="6-1-1-Concepts"><a href="#6-1-1-Concepts" class="headerlink" title="6.1.1. Concepts"></a>6.1.1. Concepts</h4><p>Spring çš„åˆ‡å…¥ç‚¹æ¨¡å‹ä½¿åˆ‡å…¥ç‚¹é‡ç”¨ä¸å—å»ºè®®ç±»å‹çš„å½±å“ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åˆ‡å…¥ç‚¹æ¥å®šä½ä¸åŒçš„å»ºè®®ã€‚</p>
<p><code>org.springframework.aop.Pointcut</code>ç•Œé¢æ˜¯ä¸­å¤®ç•Œé¢ï¼Œç”¨äºå°†å»ºè®®å®šå‘åˆ°ç‰¹å®šçš„ç±»å’Œæ–¹æ³•ã€‚å®Œæ•´çš„ç•Œé¢å¦‚ä¸‹ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Pointcut</span> &#123;    <span class="function">ClassFilter <span class="title">getClassFilter</span>(<span class="params"></span>)</span>;    <span class="function">MethodMatcher <span class="title">getMethodMatcher</span>(<span class="params"></span>)</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>å°†<code>Pointcut</code>æ¥å£åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå¯ä»¥é‡ç”¨ç±»å’Œæ–¹æ³•åŒ¹é…çš„éƒ¨åˆ†ä»¥åŠç»†ç²’åº¦çš„åˆæˆæ“ä½œ(ä¾‹å¦‚ä¸å¦ä¸€ä¸ªæ–¹æ³•åŒ¹é…å™¨æ‰§è¡Œâ€œè”åˆâ€)ã€‚</p>
<p><code>ClassFilter</code>æ¥å£ç”¨äºå°†åˆ‡å…¥ç‚¹é™åˆ¶ä¸ºç»™å®šçš„ä¸€ç»„ç›®æ ‡ç±»ã€‚å¦‚æœ<code>matches()</code>æ–¹æ³•å§‹ç»ˆè¿”å› trueï¼Œåˆ™åŒ¹é…æ‰€æœ‰ç›®æ ‡ç±»ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†<code>ClassFilter</code>æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClassFilter</span> </span>&#123;    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class clazz)</span></span>;&#125;</span><br></pre></td></tr></table></figure>

<p><code>MethodMatcher</code>ç•Œé¢é€šå¸¸æ›´é‡è¦ã€‚å®Œæ•´çš„ç•Œé¢å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodMatcher</span> </span>&#123;    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method m, Class targetClass)</span></span>;    <span class="function"><span class="keyword">boolean</span> <span class="title">isRuntime</span><span class="params">()</span></span>;    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method m, Class targetClass, Object[] args)</span></span>;&#125;</span><br></pre></td></tr></table></figure>

<p><code>matches(Method, Class)</code>æ–¹æ³•ç”¨äºæµ‹è¯•æ­¤åˆ‡å…¥ç‚¹æ˜¯å¦ä¸ç›®æ ‡ç±»ä¸Šçš„ç»™å®šæ–¹æ³•åŒ¹é…ã€‚åˆ›å»º AOP ä»£ç†æ—¶å¯ä»¥æ‰§è¡Œæ­¤è¯„ä¼°ï¼Œä»¥é¿å…éœ€è¦å¯¹æ¯ä¸ªæ–¹æ³•è°ƒç”¨è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœç»™å®šæ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°çš„<code>matches</code>æ–¹æ³•è¿”å›<code>true</code>ï¼Œè€Œç”¨äº MethodMatcher çš„<code>isRuntime()</code>çš„æ–¹æ³•è¿”å›<code>true</code>ï¼Œåˆ™åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶éƒ½ä¼šè°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„ match æ–¹æ³•ã€‚è¿™æ ·ï¼Œåˆ‡å…¥ç‚¹å°±å¯ä»¥åœ¨æ‰§è¡Œç›®æ ‡å»ºè®®ä¹‹å‰ç«‹å³æŸ¥çœ‹ä¼ é€’ç»™æ–¹æ³•è°ƒç”¨çš„å‚æ•°ã€‚</p>
<p>å¤§å¤šæ•°<code>MethodMatcher</code>å®ç°æ˜¯é™æ€çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬çš„<code>isRuntime()</code>æ–¹æ³•è¿”å›<code>false</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ°¸è¿œä¸ä¼šè°ƒç”¨ä¸‰å‚æ•°<code>matches</code>æ–¹æ³•ã€‚</p>
<p>Tip</p>
<p>å¦‚æœå¯èƒ½ï¼Œè¯·å°è¯•ä½¿åˆ‡å…¥ç‚¹æˆä¸ºé™æ€ï¼Œä»è€Œåœ¨åˆ›å»º AOP ä»£ç†æ—¶å…è®¸ AOP æ¡†æ¶ç¼“å­˜åˆ‡å…¥ç‚¹è¯„ä¼°çš„ç»“æœã€‚</p>
<h4 id="6-1-2-åˆ‡å…¥ç‚¹çš„æ“ä½œ"><a href="#6-1-2-åˆ‡å…¥ç‚¹çš„æ“ä½œ" class="headerlink" title="6.1.2. åˆ‡å…¥ç‚¹çš„æ“ä½œ"></a>6.1.2. åˆ‡å…¥ç‚¹çš„æ“ä½œ</h4><p>Spring æ”¯æŒåˆ‡å…¥ç‚¹ä¸Šçš„æ“ä½œ(ç‰¹åˆ«æ˜¯è”åˆå’Œç›¸äº¤)ã€‚</p>
<p>è”åˆè¡¨ç¤ºä¸¤ä¸ªåˆ‡å…¥ç‚¹éƒ½åŒ¹é…çš„æ–¹æ³•ã€‚äº¤é›†æ˜¯æŒ‡ä¸¤ä¸ªåˆ‡å…¥ç‚¹éƒ½åŒ¹é…çš„æ–¹æ³•ã€‚è”åˆé€šå¸¸æ›´æœ‰ç”¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>org.springframework.aop.support.Pointcuts</code>ç±»ä¸­çš„é™æ€æ–¹æ³•æˆ–åŒä¸€åŒ…ä¸­çš„<code>ComposablePointcut</code>ç±»æ¥ç¼–å†™åˆ‡å…¥ç‚¹ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾å¼é€šå¸¸æ˜¯ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•ã€‚</p>
<h4 id="6-1-3-AspectJ-è¡¨è¾¾åˆ‡å…¥ç‚¹"><a href="#6-1-3-AspectJ-è¡¨è¾¾åˆ‡å…¥ç‚¹" class="headerlink" title="6.1.3. AspectJ è¡¨è¾¾åˆ‡å…¥ç‚¹"></a>6.1.3. AspectJ è¡¨è¾¾åˆ‡å…¥ç‚¹</h4><p>ä» 2.0 å¼€å§‹ï¼ŒSpring ä½¿ç”¨çš„æœ€é‡è¦çš„åˆ‡å…¥ç‚¹ç±»å‹æ˜¯<code>org.springframework.aop.aspectj.AspectJExpressionPointcut</code>ã€‚è¿™æ˜¯ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œè¯¥åˆ‡å…¥ç‚¹ä½¿ç”¨ AspectJ æä¾›çš„åº“æ¥è§£æ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å­—ç¬¦ä¸²ã€‚</p>
<p>æœ‰å…³æ”¯æŒçš„ AspectJ åˆ‡å…¥ç‚¹ Primitives çš„è®¨è®ºï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop">previous chapter</a>ã€‚</p>
<h4 id="6-1-4-ä¾¿æ·åˆ‡å…¥ç‚¹å®ç°"><a href="#6-1-4-ä¾¿æ·åˆ‡å…¥ç‚¹å®ç°" class="headerlink" title="6.1.4. ä¾¿æ·åˆ‡å…¥ç‚¹å®ç°"></a>6.1.4. ä¾¿æ·åˆ‡å…¥ç‚¹å®ç°</h4><p>Spring æä¾›äº†å‡ ç§æ–¹ä¾¿çš„åˆ‡å…¥ç‚¹å®ç°ã€‚æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶ä¸­ä¸€äº›ã€‚å…¶ä»–çš„åˆ™åº”å½’å…¥ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„åˆ‡å…¥ç‚¹ä¸­ã€‚</p>
<h5 id="Static-Pointcuts"><a href="#Static-Pointcuts" class="headerlink" title="Static Pointcuts"></a>Static Pointcuts</h5><p>é™æ€åˆ‡å…¥ç‚¹æ˜¯åŸºäºæ–¹æ³•å’Œç›®æ ‡ç±»çš„ï¼Œä¸èƒ½è€ƒè™‘æ–¹æ³•çš„å‚æ•°ã€‚é™æ€åˆ‡å…¥ç‚¹è¶³ä»¥æ»¡è¶³å¤§å¤šæ•°ç”¨é€”ï¼Œå¹¶ä¸”æœ€å¥½ã€‚é¦–æ¬¡è°ƒç”¨æ–¹æ³•æ—¶ï¼ŒSpring åªèƒ½è¯„ä¼°ä¸€æ¬¡é™æ€åˆ‡å…¥ç‚¹ã€‚ä¹‹åï¼Œæ— éœ€åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶å†æ¬¡è¯„ä¼°åˆ‡å…¥ç‚¹ã€‚</p>
<p>æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†æè¿°äº† Spring é™„å¸¦çš„ä¸€äº›é™æ€åˆ‡å…¥ç‚¹å®ç°ã€‚</p>
<h6 id="æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹"><a href="#æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹"></a>æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹</h6><p>æŒ‡å®šé™æ€åˆ‡å…¥ç‚¹çš„ä¸€ç§æ˜æ˜¾æ–¹æ³•æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚é™¤äº† Spring ä¹‹å¤–ï¼Œè¿˜æœ‰å‡ ä¸ª AOP æ¡†æ¶ä½¿ä¹‹æˆä¸ºå¯èƒ½ã€‚ <code>org.springframework.aop.support.JdkRegexpMethodPointcut</code>æ˜¯é€šç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹ï¼Œå®ƒä½¿ç”¨ JDK ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒã€‚</p>
<p>ä½¿ç”¨<code>JdkRegexpMethodPointcut</code>ç±»ï¼Œå¯ä»¥æä¾›æ¨¡å¼å­—ç¬¦ä¸²åˆ—è¡¨ã€‚å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™åˆ‡å…¥ç‚¹çš„å€¼ä¸º<code>true</code>ã€‚ (å› æ­¤ï¼Œç»“æœå®é™…ä¸Šæ˜¯è¿™äº›åˆ‡å…¥ç‚¹çš„å¹¶é›†.)</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>JdkRegexpMethodPointcut</code>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;settersAndAbsquatulatePointcut&quot;</span>        <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.support.JdkRegexpMethodPointcut&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patterns&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.*set.*<span class="tag">&lt;/<span class="name">value</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.*absquatulate<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring æä¾›äº†ä¸€ä¸ªåä¸º<code>RegexpMethodPointcutAdvisor</code>çš„ä¾¿æ·ç±»ï¼Œå®ƒä½¿æˆ‘ä»¬ä¹Ÿå¯ä»¥å¼•ç”¨<code>Advice</code>(è¯·è®°ä½<code>Advice</code>å¯ä»¥æ˜¯æ‹¦æˆªå™¨ï¼Œè€Œä¸æ˜¯å»ºè®®ï¼Œå¼•å‘å»ºè®®ç­‰)ã€‚åœ¨åå°ï¼ŒSpring ä½¿ç”¨<code>JdkRegexpMethodPointcut</code>ã€‚ä½¿ç”¨<code>RegexpMethodPointcutAdvisor</code>ç®€åŒ–äº†æ¥çº¿ï¼Œå› ä¸ºä¸€ä¸ª bean å°è£…äº†åˆ‡å…¥ç‚¹å’Œå»ºè®®ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;settersAndAbsquatulateAdvisor&quot;</span>        <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.support.RegexpMethodPointcutAdvisor&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;advice&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;beanNameOfAopAllianceInterceptor&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patterns&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.*set.*<span class="tag">&lt;/<span class="name">value</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.*absquatulate<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥å°†<code>RegexpMethodPointcutAdvisor</code>ä¸ä»»ä½•<code>Advice</code>ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚</p>
<h6 id="Attribute-driven-Pointcuts"><a href="#Attribute-driven-Pointcuts" class="headerlink" title="Attribute-driven Pointcuts"></a>Attribute-driven Pointcuts</h6><p>é™æ€åˆ‡å…¥ç‚¹çš„ä¸€ç§é‡è¦ç±»å‹æ˜¯å…ƒæ•°æ®é©±åŠ¨çš„åˆ‡å…¥ç‚¹ã€‚è¿™ä½¿ç”¨å…ƒæ•°æ®å±æ€§çš„å€¼(é€šå¸¸æ˜¯æºçº§åˆ«çš„å…ƒæ•°æ®)ã€‚</p>
<h5 id="Dynamic-pointcuts"><a href="#Dynamic-pointcuts" class="headerlink" title="Dynamic pointcuts"></a>Dynamic pointcuts</h5><p>åŠ¨æ€åˆ‡å…¥ç‚¹æ¯”é™æ€åˆ‡å…¥ç‚¹æ›´æ˜‚è´µã€‚å®ƒä»¬è€ƒè™‘äº†æ–¹æ³•å‚æ•°ä»¥åŠé™æ€ä¿¡æ¯ã€‚è¿™æ„å‘³ç€å¿…é¡»åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶å¯¹å®ƒä»¬è¿›è¡Œè¯„ä¼°ï¼Œå¹¶ä¸”ç”±äºå‚æ•°ä¼šæœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ— æ³•ç¼“å­˜ç»“æœã€‚</p>
<p>ä¸»è¦ç¤ºä¾‹æ˜¯<code>control flow</code>åˆ‡å…¥ç‚¹ã€‚</p>
<h6 id="æ§åˆ¶æµåˆ‡å…¥ç‚¹"><a href="#æ§åˆ¶æµåˆ‡å…¥ç‚¹" class="headerlink" title="æ§åˆ¶æµåˆ‡å…¥ç‚¹"></a>æ§åˆ¶æµåˆ‡å…¥ç‚¹</h6><p>Spring æ§åˆ¶æµåˆ‡å…¥ç‚¹åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äº AspectJ <code>cflow</code>åˆ‡å…¥ç‚¹ï¼Œä½†åŠŸèƒ½è¾ƒå¼±ã€‚ (å½“å‰æ— æ³•æŒ‡å®šä¸€ä¸ªåˆ‡å…¥ç‚¹åœ¨ä¸å¦ä¸€ä¸ªåˆ‡å…¥ç‚¹åŒ¹é…çš„è¿æ¥ç‚¹ä¸‹æ‰§è¡Œ.)æ§åˆ¶æµåˆ‡å…¥ç‚¹ä¸å½“å‰è°ƒç”¨å †æ ˆåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¿æ¥ç‚¹æ˜¯ç”±<code>com.mycompany.web</code>åŒ…ä¸­çš„æ–¹æ³•æˆ–<code>SomeCaller</code>ç±»è°ƒç”¨çš„ï¼Œåˆ™å¯èƒ½ä¼šè§¦å‘ã€‚é€šè¿‡ä½¿ç”¨<code>org.springframework.aop.support.ControlFlowPointcut</code>ç±»æŒ‡å®šæ§åˆ¶æµåˆ‡å…¥ç‚¹ã€‚</p>
<p>Note</p>
<p>ä¸å…¶ä»–åŠ¨æ€åˆ‡å…¥ç‚¹ç›¸æ¯”ï¼Œæ§åˆ¶æµåˆ‡å…¥ç‚¹åœ¨è¿è¡Œæ—¶è¿›è¡Œè¯„ä¼°è¦æ˜‚è´µå¾—å¤šã€‚åœ¨ Java 1.4 ä¸­ï¼Œæˆæœ¬å¤§çº¦æ˜¯å…¶ä»–åŠ¨æ€åˆ‡å…¥ç‚¹çš„äº”å€ã€‚</p>
<h4 id="6-1-5-åˆ‡å…¥ç‚¹è¶…ç±»"><a href="#6-1-5-åˆ‡å…¥ç‚¹è¶…ç±»" class="headerlink" title="6.1.5. åˆ‡å…¥ç‚¹è¶…ç±»"></a>6.1.5. åˆ‡å…¥ç‚¹è¶…ç±»</h4><p>Spring æä¾›äº†æœ‰ç”¨çš„åˆ‡å…¥ç‚¹è¶…ç±»ï¼Œä»¥å¸®åŠ©æ‚¨å®ç°è‡ªå·±çš„åˆ‡å…¥ç‚¹ã€‚</p>
<p>å› ä¸ºé™æ€åˆ‡å…¥ç‚¹æœ€æœ‰ç”¨ï¼Œæ‰€ä»¥æ‚¨å¯èƒ½åº”è¯¥å­ç±»<code>StaticMethodMatcherPointcut</code>ã€‚è¿™ä»…éœ€è¦å®ç°ä¸€ä¸ªæŠ½è±¡æ–¹æ³•(å°½ç®¡æ‚¨å¯ä»¥è¦†ç›–å…¶ä»–æ–¹æ³•ä»¥è‡ªå®šä¹‰è¡Œä¸º)ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•å¯¹<code>StaticMethodMatcherPointcut</code>è¿›è¡Œå­ç±»åŒ–ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestStaticPointcut</span> <span class="keyword">extends</span> <span class="title">StaticMethodMatcherPointcut</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="function"><span class="title">matches</span>(<span class="params">Method m, Class targetClass</span>)</span> &#123;        <span class="comment">// return true if custom criteria match    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>åŠ¨æ€åˆ‡å…¥ç‚¹ä¹Ÿæœ‰è¶…ç±»ã€‚</p>
<p>åœ¨ Spring 1.0 RC2 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œæ‚¨å¯ä»¥å°†è‡ªå®šä¹‰åˆ‡å…¥ç‚¹ä¸ä»»ä½•å»ºè®®ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚</p>
<h4 id="6-1-6-è‡ªå®šä¹‰åˆ‡å…¥ç‚¹"><a href="#6-1-6-è‡ªå®šä¹‰åˆ‡å…¥ç‚¹" class="headerlink" title="6.1.6. è‡ªå®šä¹‰åˆ‡å…¥ç‚¹"></a>6.1.6. è‡ªå®šä¹‰åˆ‡å…¥ç‚¹</h4><p>ç”±äº Spring AOP ä¸­çš„åˆ‡å…¥ç‚¹æ˜¯ Java ç±»ï¼Œè€Œä¸æ˜¯è¯­è¨€åŠŸèƒ½(å¦‚ AspectJ)ï¼Œå› æ­¤å¯ä»¥å£°æ˜è‡ªå®šä¹‰åˆ‡å…¥ç‚¹ï¼Œæ— è®ºæ˜¯é™æ€è¿˜æ˜¯åŠ¨æ€ã€‚ Spring ä¸­çš„è‡ªå®šä¹‰åˆ‡å…¥ç‚¹å¯ä»¥ä»»æ„å¤æ‚ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ AspectJ åˆ‡å…¥ç‚¹è¡¨è¾¾è¯­è¨€ã€‚</p>
<p>Note</p>
<p>æ›´é«˜ç‰ˆæœ¬çš„ Spring å¯èƒ½æä¾›å¯¹ JAC offered æä¾›çš„â€œè¯­ä¹‰åˆ‡å…¥ç‚¹â€çš„æ”¯æŒï¼Œä¾‹å¦‚ï¼Œâ€œæ›´æ”¹ç›®æ ‡å¯¹è±¡ä¸­å®ä¾‹å˜é‡çš„æ‰€æœ‰æ–¹æ³•â€ã€‚</p>
<h3 id="6-2-Spring-å’¨è¯¢-API"><a href="#6-2-Spring-å’¨è¯¢-API" class="headerlink" title="6.2. Spring å’¨è¯¢ API"></a>6.2. Spring å’¨è¯¢ API</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ Spring AOP å¦‚ä½•å¤„ç†å»ºè®®ã€‚</p>
<h4 id="6-2-1-å’¨è¯¢ç”Ÿå‘½å‘¨æœŸ"><a href="#6-2-1-å’¨è¯¢ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="6.2.1. å’¨è¯¢ç”Ÿå‘½å‘¨æœŸ"></a>6.2.1. å’¨è¯¢ç”Ÿå‘½å‘¨æœŸ</h4><p>æ¯ä¸ªå»ºè®®éƒ½æ˜¯ä¸€ä¸ª Spring beanã€‚å»ºè®®å®ä¾‹å¯ä»¥åœ¨æ‰€æœ‰å»ºè®®å¯¹è±¡ä¹‹é—´å…±äº«ï¼Œæˆ–è€…å¯¹äºæ¯ä¸ªå»ºè®®å¯¹è±¡éƒ½æ˜¯å”¯ä¸€çš„ã€‚è¿™å¯¹åº”äºæ¯ä¸ªç±»æˆ–æ¯ä¸ªå®ä¾‹çš„å»ºè®®ã€‚</p>
<p>æ¯ç­å»ºè®®æœ€å¸¸ç”¨ã€‚é€‚ç”¨äºä¸€èˆ¬å»ºè®®ï¼Œä¾‹å¦‚ Transaction é¡¾é—®ã€‚è¿™äº›ä¸ä¾èµ–äºä»£ç†å¯¹è±¡çš„çŠ¶æ€æˆ–æ·»åŠ æ–°çŠ¶æ€ã€‚å®ƒä»¬ä»…ä½œç”¨äºæ–¹æ³•å’Œå‚æ•°ã€‚</p>
<p>æ¯ä¸ªå®ä¾‹çš„å»ºè®®éƒ½é€‚åˆå¼•å…¥ï¼Œä»¥æ”¯æŒæ··åˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå»ºè®®å°†çŠ¶æ€æ·»åŠ åˆ°ä»£ç†å¯¹è±¡ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨åŒä¸€ AOP ä»£ç†ä¸­æ··åˆä½¿ç”¨å…±äº«å»ºè®®å’ŒåŸºäºå®ä¾‹çš„å»ºè®®ã€‚</p>
<h4 id="6-2-2-Spring-çš„å»ºè®®ç±»å‹"><a href="#6-2-2-Spring-çš„å»ºè®®ç±»å‹" class="headerlink" title="6.2.2. Spring çš„å»ºè®®ç±»å‹"></a>6.2.2. Spring çš„å»ºè®®ç±»å‹</h4><p>Spring æä¾›äº†å‡ ç§å»ºè®®ç±»å‹ï¼Œå¹¶ä¸”å¯ä»¥æ‰©å±•ä»¥æ”¯æŒä»»æ„å»ºè®®ç±»å‹ã€‚æœ¬èŠ‚ä»‹ç»åŸºæœ¬æ¦‚å¿µå’Œæ ‡å‡†å»ºè®®ç±»å‹ã€‚</p>
<h5 id="å›´ç»•å»ºè®®è¿›è¡Œæ‹¦æˆª"><a href="#å›´ç»•å»ºè®®è¿›è¡Œæ‹¦æˆª" class="headerlink" title="å›´ç»•å»ºè®®è¿›è¡Œæ‹¦æˆª"></a>å›´ç»•å»ºè®®è¿›è¡Œæ‹¦æˆª</h5><p>Spring ä¸­æœ€åŸºæœ¬çš„å»ºè®®ç±»å‹æ˜¯å›´ç»•å»ºè®®çš„æ‹¦æˆªã€‚</p>
<p>å¯¹äºä½¿ç”¨æ–¹æ³•æ‹¦æˆªçš„å»ºè®®ï¼ŒSpring ç¬¦åˆ AOP <code>Alliance</code>æ¥å£ã€‚å®ç°<code>MethodInterceptor</code>å¹¶å›´ç»•å»ºè®®å®ç°çš„ç±»ä¹Ÿåº”å®ç°ä»¥ä¸‹æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodInterceptor</span> <span class="keyword">extends</span> <span class="title">Interceptor</span> </span>&#123;    <span class="function">Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><code>invoke()</code>æ–¹æ³•çš„<code>MethodInvocation</code>å‚æ•°å…¬å¼€äº†æ­£åœ¨è°ƒç”¨çš„æ–¹æ³•ï¼Œç›®æ ‡è¿æ¥ç‚¹ï¼ŒAOP ä»£ç†ä»¥åŠè¯¥æ–¹æ³•çš„å‚æ•°ã€‚ <code>invoke()</code>æ–¹æ³•åº”è¿”å›è°ƒç”¨çš„ç»“æœï¼šè¿æ¥ç‚¹çš„è¿”å›å€¼ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„<code>MethodInterceptor</code>å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DebugInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;        System.out.println(<span class="string">&quot;Before: invocation=[&quot;</span> + invocation + <span class="string">&quot;]&quot;</span>);        Object rval = invocation.proceed();        System.out.println(<span class="string">&quot;Invocation returned&quot;</span>);        <span class="keyword">return</span> rval;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„å¯¹<code>MethodInvocation</code>çš„<code>proceed()</code>æ–¹æ³•çš„è°ƒç”¨ã€‚è¿™æ²¿ç€æ‹¦æˆªå™¨é“¾å‘ä¸‹åˆ°è¾¾è¿æ¥ç‚¹ã€‚å¤§å¤šæ•°æ‹¦æˆªå™¨éƒ½è°ƒç”¨æ­¤æ–¹æ³•å¹¶è¿”å›å…¶è¿”å›å€¼ã€‚ä½†æ˜¯ï¼Œ<code>MethodInterceptor</code>å°±åƒä»»ä½•å‘¨å›´çš„å»ºè®®ä¸€æ ·ï¼Œå¯ä»¥è¿”å›ä¸åŒçš„å€¼æˆ–å¼•å‘å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è°ƒç”¨ proceed æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæ‚¨æ²¡æœ‰å……åˆ†çš„ç†ç”±å°±ä¸æƒ³è¿™æ ·åšã€‚</p>
<p>Note</p>
<p><code>MethodInterceptor</code>å®ç°æä¾›ä¸å…¶ä»–ç¬¦åˆ AOP Alliance è¦æ±‚çš„ AOP å®ç°çš„äº’æ“ä½œæ€§ã€‚æœ¬èŠ‚å…¶ä½™éƒ¨åˆ†è®¨è®ºçš„å…¶ä»–å»ºè®®ç±»å‹å°†å®ç°å¸¸è§çš„ AOP æ¦‚å¿µï¼Œä½†ä»¥ç‰¹å®šäº Spring çš„æ–¹å¼ã€‚å°½ç®¡ä½¿ç”¨æœ€å…·ä½“çš„å»ºè®®ç±»å‹æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œä½†æ˜¯å¦‚æœæ‚¨å¯èƒ½æƒ³åœ¨å¦ä¸€ä¸ª AOP æ¡†æ¶ä¸­è¿è¡Œåˆ‡é¢ï¼Œè¯·åšæŒä½¿ç”¨<code>MethodInterceptor</code>ã€‚è¯·æ³¨æ„ï¼Œåˆ‡å…¥ç‚¹å½“å‰æ— æ³•åœ¨æ¡†æ¶ä¹‹é—´äº’æ“ä½œï¼Œå¹¶ä¸” AOP Alliance å½“å‰æœªå®šä¹‰åˆ‡å…¥ç‚¹æ¥å£ã€‚</p>
<h5 id="Before-Advice-2"><a href="#Before-Advice-2" class="headerlink" title="Before Advice"></a>Before Advice</h5><p>ä¸€ç§æ›´ç®€å•çš„å»ºè®®ç±»å‹æ˜¯äº‹å‰å»ºè®®ã€‚ä¸éœ€è¦<code>MethodInvocation</code>å¯¹è±¡ï¼Œå› ä¸ºå®ƒä»…åœ¨è¿›å…¥æ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨ã€‚</p>
<p>å…ˆè¡Œå»ºè®®çš„ä¸»è¦ä¼˜ç‚¹æ˜¯æ— éœ€è°ƒç”¨<code>proceed()</code>æ–¹æ³•ï¼Œå› æ­¤ï¼Œä¸ä¼šæ— æ„ä¸­æœªèƒ½æ²¿æ‹¦æˆªå™¨é“¾ continue å‰è¿›ã€‚</p>
<p>ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†<code>MethodBeforeAdvice</code>ç•Œé¢ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodBeforeAdvice</span> <span class="keyword">extends</span> <span class="title">BeforeAdvice</span> </span>&#123;    <span class="keyword">void</span> before(Method m, <span class="keyword">Object</span>[] args, <span class="keyword">Object</span> target) throws <span class="built_in">Throwable</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>(å°½ç®¡é€šå¸¸çš„å¯¹è±¡é€‚ç”¨äºå­—æ®µæ‹¦æˆªï¼Œå¹¶ä¸” Spring ä¸å¤ªå¯èƒ½å®ç°å®ƒï¼Œä½† Spring çš„ API è®¾è®¡å…è®¸å…ˆäºå­—æ®µå’¨è¯¢.)</p>
<p>è¯·æ³¨æ„ï¼Œè¿”å›ç±»å‹ä¸º<code>void</code>ã€‚é€šçŸ¥å¯ä»¥åœ¨è”æ¥ç‚¹æ‰§è¡Œä¹‹å‰æ’å…¥è‡ªå®šä¹‰è¡Œä¸ºï¼Œä½†ä¸èƒ½æ›´æ”¹è¿”å›å€¼ã€‚å¦‚æœä¹‹å‰çš„å»ºè®®å¼•å‘å¼‚å¸¸ï¼Œå®ƒå°†ä¸­æ­¢æ‹¦æˆªå™¨é“¾çš„è¿›ä¸€æ­¥æ‰§è¡Œã€‚å¼‚å¸¸ä¼šä¼ æ’­å›æ‹¦æˆªå™¨é“¾ã€‚å¦‚æœæœªé€‰ä¸­å®ƒæˆ–åœ¨è°ƒç”¨çš„æ–¹æ³•çš„ç­¾åä¸Šï¼Œåˆ™å°†å…¶ç›´æ¥ä¼ é€’ç»™ Client ç«¯ã€‚å¦åˆ™ï¼Œå®ƒå°†è¢« AOP ä»£ç†åŒ…è£…åœ¨æœªç»æ£€æŸ¥çš„å¼‚å¸¸ä¸­ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº† Spring ä¸­çš„ before å»ºè®®ï¼Œè¯¥å»ºè®®è®¡ç®—æ‰€æœ‰æ–¹æ³•è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountingBeforeAdvice</span> <span class="keyword">implements</span> <span class="title">MethodBeforeAdvice</span> </span>&#123;    <span class="keyword">private</span> <span class="keyword">int</span> count;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method m, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;        ++count;    &#125;    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;        <span class="keyword">return</span> count;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Tip</p>
<p>åœ¨å°†å»ºè®®ä¸ä»»ä½•åˆ‡å…¥ç‚¹ä¸€èµ·ä½¿ç”¨ä¹‹å‰ã€‚</p>
<h5 id="Throws-Advice"><a href="#Throws-Advice" class="headerlink" title="Throws Advice"></a>Throws Advice</h5><p>å¦‚æœè”æ¥ç‚¹å¼•å‘å¼‚å¸¸ï¼Œåˆ™åœ¨è”æ¥ç‚¹è¿”å›ä¹‹åè°ƒç”¨å¼•å‘é€šçŸ¥ã€‚ Spring æä¾›ç±»å‹åŒ–çš„æŠ›å‡ºå»ºè®®ã€‚è¯·æ³¨æ„ï¼Œè¿™æ„å‘³ç€<code>org.springframework.aop.ThrowsAdvice</code>æ¥å£ä¸åŒ…å«ä»»ä½•æ–¹æ³•ã€‚å®ƒæ˜¯ä¸€ä¸ªæ ‡ç­¾æ¥å£ï¼Œç”¨äºæ ‡è¯†ç»™å®šå¯¹è±¡å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹åŒ–çš„ throws é€šçŸ¥æ–¹æ³•ã€‚è¿™äº›åº”é‡‡ç”¨ä»¥ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afterThrowing(<span class="selector-attr">[Method, args, target]</span>, subclassOfThrowable)</span><br></pre></td></tr></table></figure>

<p>ä»…æœ€åä¸€ä¸ªå‚æ•°æ˜¯å¿…éœ€çš„ã€‚æ–¹æ³•ç­¾åå¯ä»¥å…·æœ‰ä¸€ä¸ªæˆ–å››ä¸ªå‚æ•°ï¼Œå…·ä½“å–å†³äºå»ºè®®æ–¹æ³•æ˜¯å¦å¯¹è¯¥æ–¹æ³•å’Œå‚æ•°æ„Ÿå…´è¶£ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ¸…å•æ˜¾ç¤ºäº†ç±»ï¼Œå®ƒä»¬æ˜¯å¼•å‘å»ºè®®çš„ç¤ºä¾‹ã€‚</p>
<p>å¦‚æœæŠ›å‡º<code>RemoteException</code>(åŒ…æ‹¬æ¥è‡ªå­ç±»)ï¼Œåˆ™è°ƒç”¨ä»¥ä¸‹å»ºè®®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteThrowsAdvice</span> <span class="keyword">implements</span> <span class="title">ThrowsAdvice</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(RemoteException ex)</span> <span class="keyword">throws</span> Throwable </span>&#123;        <span class="comment">// Do something with remote exception    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸å‰é¢çš„å»ºè®®ä¸åŒï¼Œä¸‹ä¸€ä¸ªç¤ºä¾‹å£°æ˜å››ä¸ªå‚æ•°ï¼Œä»¥ä¾¿å¯ä»¥è®¿é—®è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°å’Œç›®æ ‡å¯¹è±¡ã€‚å¦‚æœæŠ›å‡º<code>ServletException</code>ï¼Œåˆ™è°ƒç”¨ä»¥ä¸‹å»ºè®®ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletThrowsAdviceWithArguments</span> <span class="title">implements</span> <span class="title">ThrowsAdvice</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">afterThrowing</span>(<span class="params">Method m, <span class="built_in">Object</span>[] args, <span class="built_in">Object</span> target, ServletException ex</span>)</span> &#123;        <span class="comment">// Do something with all arguments    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªç¤ºä¾‹è¯´æ˜å¦‚ä½•åœ¨å¤„ç†<code>RemoteException</code>å’Œ<code>ServletException</code>çš„å•ä¸ªç±»ä¸­ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ã€‚å¯ä»¥å°†ä»»æ„æ•°é‡çš„å¼•å‘å»ºè®®æ–¹æ³•ç»„åˆåˆ°ä¸€ä¸ªç±»ä¸­ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†æœ€åä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CombinedThrowsAdvice</span> <span class="title">implements</span> <span class="title">ThrowsAdvice</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">void</span> afterThrowing(RemoteException ex) throws Throwable &#123;        <span class="comment">// Do something with remote exception    &#125;    public void afterThrowing(Method m, Object[] args, Object target, ServletException ex) &#123;        // Do something with all arguments    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>å¦‚æœ throws-advice æ–¹æ³•æœ¬èº«å¼•å‘å¼‚å¸¸ï¼Œåˆ™å®ƒå°†è¦†ç›–åŸå§‹å¼‚å¸¸(ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå°†æ›´æ”¹å¼•å‘ç»™ç”¨æˆ·çš„å¼‚å¸¸)ã€‚é‡å†™å¼‚å¸¸é€šå¸¸æ˜¯ RuntimeExceptionï¼Œå®ƒä¸ä»»ä½•æ–¹æ³•ç­¾åéƒ½å…¼å®¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœ throws-advice æ–¹æ³•æŠ›å‡ºä¸€ä¸ªå·²æ£€æŸ¥çš„å¼‚å¸¸ï¼Œåˆ™å®ƒå¿…é¡»ä¸ç›®æ ‡æ–¹æ³•çš„å·²å£°æ˜å¼‚å¸¸åŒ¹é…ï¼Œå› æ­¤åœ¨æŸç§ç¨‹åº¦ä¸Šä¸ç‰¹å®šçš„ç›®æ ‡æ–¹æ³•ç­¾åè€¦åˆã€‚ <em>è¯·å‹¿æŠ›å‡ºä¸ç›®æ ‡æ–¹æ³•ç­¾åä¸å…¼å®¹çš„æœªå£°æ˜æ£€æŸ¥å¼‚å¸¸ï¼</em></p>
<p>Tip</p>
<p>æŠ›å‡ºå»ºè®®å¯ä»¥ä¸ä»»ä½•åˆ‡å…¥ç‚¹ä¸€èµ·ä½¿ç”¨ã€‚</p>
<h5 id="è¿”å›å»ºè®®å-1"><a href="#è¿”å›å»ºè®®å-1" class="headerlink" title="è¿”å›å»ºè®®å"></a>è¿”å›å»ºè®®å</h5><p>åœ¨ Spring ä¸­è¿”å›é€šçŸ¥åï¼Œå¿…é¡»å®ç°<code>org.springframework.aop.AfterReturningAdvice</code>æ¥å£ï¼Œä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†è¯¥æ¥å£ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AfterReturningAdvice</span> <span class="keyword">extends</span> <span class="title">Advice</span> </span>&#123;    <span class="keyword">void</span> afterReturning(<span class="keyword">Object</span> returnValue, Method m, <span class="keyword">Object</span>[] args, <span class="keyword">Object</span> target)            throws <span class="built_in">Throwable</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>After After Returning å»ºè®®å¯ä»¥è®¿é—®è¿”å›å€¼(å®ƒä¸èƒ½ä¿®æ”¹)ï¼Œè°ƒç”¨çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„å‚æ•°å’Œç›®æ ‡ã€‚</p>
<p>è¿”å›å»ºè®®åçš„ä»¥ä¸‹å†…å®¹å°†è®¡æ•°æ‰€æœ‰æœªå¼•å‘å¼‚å¸¸çš„æˆåŠŸæ–¹æ³•è°ƒç”¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountingAfterReturningAdvice</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span> </span>&#123;    <span class="keyword">private</span> <span class="keyword">int</span> count;    <span class="keyword">public</span> <span class="keyword">void</span> afterReturning(<span class="keyword">Object</span> returnValue, Method m, <span class="keyword">Object</span>[] args, <span class="keyword">Object</span> target)            throws <span class="built_in">Throwable</span> &#123;        ++count;    &#125;    <span class="keyword">public</span> <span class="keyword">int</span> getCount() &#123;        <span class="keyword">return</span> count;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å»ºè®®ä¸ä¼šæ›´æ”¹æ‰§è¡Œè·¯å¾„ã€‚å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä¼šå°†å…¶æŠ›å‡ºæ‹¦æˆªå™¨é“¾ï¼Œè€Œä¸æ˜¯è¿”å›å€¼ã€‚</p>
<p>Tip</p>
<p>è¿”å›åï¼Œå»ºè®®å¯ä»¥ä¸ä»»ä½•åˆ‡å…¥ç‚¹ä¸€èµ·ä½¿ç”¨ã€‚</p>
<h5 id="Introduction-Advice"><a href="#Introduction-Advice" class="headerlink" title="Introduction Advice"></a>Introduction Advice</h5><p>Spring å°†ä»‹ç»å»ºè®®è§†ä¸ºä¸€ç§ç‰¹æ®Šçš„æ‹¦æˆªå»ºè®®ã€‚</p>
<p>ç®€ä»‹éœ€è¦<code>IntroductionAdvisor</code>å’Œ<code>IntroductionInterceptor</code>æ¥å®ç°ä»¥ä¸‹æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntroductionInterceptor</span> <span class="keyword">extends</span> <span class="title">MethodInterceptor</span> </span>&#123;    <span class="function"><span class="keyword">boolean</span> <span class="title">implementsInterface</span><span class="params">(Class intf)</span></span>;&#125;</span><br></pre></td></tr></table></figure>

<p>ä» AOP Alliance <code>MethodInterceptor</code>æ¥å£ç»§æ‰¿çš„<code>invoke()</code>æ–¹æ³•å¿…é¡»å®ç°ä»‹ç»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨å¼•å…¥çš„æ¥å£ä¸Šï¼Œåˆ™å¼•å…¥æ‹¦æˆªå™¨è´Ÿè´£å¤„ç†æ–¹æ³•è°ƒç”¨-å®ƒä¸èƒ½è°ƒç”¨<code>proceed()</code>ã€‚</p>
<p>ç®€ä»‹å»ºè®®ä¸èƒ½ä¸ä»»ä½•åˆ‡å…¥ç‚¹ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»…é€‚ç”¨äºç±»ï¼Œè€Œä¸é€‚ç”¨äºæ–¹æ³•çº§åˆ«ã€‚æ‚¨åªèƒ½é€šè¿‡<code>IntroductionAdvisor</code>ä½¿ç”¨ä»‹ç»å»ºè®®ï¼Œè¯¥å»ºè®®å…·æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntroductionAdvisor</span> <span class="keyword">extends</span> <span class="title">Advisor</span>, <span class="title">IntroductionInfo</span> </span>&#123;    <span class="function">ClassFilter <span class="title">getClassFilter</span><span class="params">()</span></span>;    <span class="function"><span class="keyword">void</span> <span class="title">validateInterfaces</span><span class="params">()</span> <span class="keyword">throws</span> IllegalArgumentException</span>;&#125;<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntroductionInfo</span> </span>&#123;    Class[] getInterfaces();&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰<code>MethodMatcher</code>ï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰<code>Pointcut</code>ä¸ä»‹ç»å»ºè®®ç›¸å…³è”ã€‚åªæœ‰ç±»è¿‡æ»¤æ˜¯åˆä¹é€»è¾‘çš„ã€‚</p>
<p><code>getInterfaces()</code>æ–¹æ³•è¿”å›æ­¤é¡¾é—®ç¨‹åºå¼•å…¥çš„æ¥å£ã€‚</p>
<p>åœ¨å†…éƒ¨ä½¿ç”¨<code>validateInterfaces()</code>æ–¹æ³•æ¥æŸ¥çœ‹å¼•å…¥çš„æ¥å£æ˜¯å¦å¯ä»¥ç”±é…ç½®çš„<code>IntroductionInterceptor</code>å®ç°ã€‚</p>
<p>è€ƒè™‘ä¸€ä¸‹ Spring æµ‹è¯•å¥—ä»¶ä¸­çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œå¹¶å‡è®¾æˆ‘ä»¬æƒ³ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å¼•å…¥ä»¥ä¸‹æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lockable</span> </span>&#123;    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;    <span class="function"><span class="keyword">boolean</span> <span class="title">locked</span><span class="params">()</span></span>;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™è¯´æ˜äº†æ··åˆã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå°†å»ºè®®å¯¹è±¡å¼ºåˆ¶è½¬æ¢ä¸º<code>Lockable</code>ï¼Œæ— è®ºå®ƒä»¬çš„ç±»å‹å¦‚ä½•ï¼Œå¹¶è°ƒç”¨é”å®šå’Œè§£é”æ–¹æ³•ã€‚å¦‚æœè°ƒç”¨<code>lock()</code>æ–¹æ³•ï¼Œåˆ™å¸Œæœ›æ‰€æœ‰çš„ setter æ–¹æ³•éƒ½æŠ›å‡º<code>LockedException</code>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªåˆ‡é¢ï¼Œä½¿å¯¹è±¡åœ¨ä¸äº†è§£å¯¹è±¡çš„æƒ…å†µä¸‹ä¸å¯å˜ï¼šAOP çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<code>IntroductionInterceptor</code>æ¥å®Œæˆç¹é‡çš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰©å±•äº†<code>org.springframework.aop.support.DelegatingIntroductionInterceptor</code>ä¾¿åˆ©ç±»ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç°<code>IntroductionInterceptor</code>ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æœ€å¥½ä½¿ç”¨<code>DelegatingIntroductionInterceptor</code>ã€‚</p>
<p><code>DelegatingIntroductionInterceptor</code>çš„è®¾è®¡å®—æ—¨æ˜¯å°†å¼•å…¥çš„æ¥å£å§”æ´¾ç»™å¼•å…¥æ¥å£çš„å®é™…å®ç°ï¼Œä»è€Œéšè—ä½¿ç”¨æ‹¦æˆªçš„æ–¹å¼ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ„é€ å‡½æ•°å‚æ•°å°†å§”æ‰˜è®¾ç½®ä¸ºä»»ä½•å¯¹è±¡ã€‚é»˜è®¤å§”æ‰˜(ä½¿ç”¨æ— å‚æ•°æ„é€ å‡½æ•°æ—¶)ä¸º<code>this</code>ã€‚å› æ­¤ï¼Œåœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œå§”æ‰˜æ˜¯<code>DelegatingIntroductionInterceptor</code>çš„<code>LockMixin</code>å­ç±»ã€‚ç»™å®šä¸€ä¸ªå§”æ‰˜(é»˜è®¤æƒ…å†µä¸‹ä¸ºè‡ªèº«)ï¼Œ<code>DelegatingIntroductionInterceptor</code>å®ä¾‹å°†æŸ¥æ‰¾ç”±å§”æ‰˜å®ç°çš„æ‰€æœ‰æ¥å£(<code>IntroductionInterceptor</code>é™¤å¤–)ï¼Œå¹¶æ”¯æŒé’ˆå¯¹å…¶ä¸­ä»»ä½•æ¥å£çš„ä»‹ç»ã€‚è¯¸å¦‚<code>LockMixin</code>ä¹‹ç±»çš„å­ç±»å¯ä»¥è°ƒç”¨<code>suppressInterface(Class intf)</code>æ–¹æ³•æ¥ç¦æ­¢ä¸åº”å…¬å¼€çš„æ¥å£ã€‚ä½†æ˜¯ï¼Œæ— è®º<code>IntroductionInterceptor</code>å‡†å¤‡æ”¯æŒå¤šå°‘ä¸ªæ¥å£ï¼Œ<code>IntroductionAdvisor</code>ä½¿ç”¨çš„æ§ä»¶éƒ½ä¼šæ§åˆ¶å®é™…å…¬å¼€å“ªäº›æ¥å£ã€‚å¼•å…¥çš„æ¥å£éšè—äº†ç›®æ ‡å¯¹åŒä¸€æ¥å£çš„ä»»ä½•å®ç°ã€‚</p>
<p>å› æ­¤ï¼Œ<code>LockMixin</code>æ‰©å±•äº†<code>DelegatingIntroductionInterceptor</code>å¹¶å®ç°äº†<code>Lockable</code>æœ¬èº«ã€‚è¶…ç±»ä¼šè‡ªåŠ¨é€‰æ‹©æ”¯æŒ<code>Lockable</code>è¿›è¡Œä»‹ç»ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€æŒ‡å®šã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¼•å…¥ä»»æ„æ•°é‡çš„æ¥å£ã€‚</p>
<p>è¯·æ³¨æ„<code>locked</code>å®ä¾‹å˜é‡çš„ä½¿ç”¨ã€‚è¿™æœ‰æ•ˆåœ°å°†é™„åŠ çŠ¶æ€æ·»åŠ åˆ°ç›®æ ‡å¯¹è±¡ä¸­ä¿å­˜çš„çŠ¶æ€ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºç¤ºä¾‹<code>LockMixin</code>ç±»ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockMixin</span> <span class="keyword">extends</span> <span class="title">DelegatingIntroductionInterceptor</span> <span class="title">implements</span> <span class="title">Lockable</span> </span>&#123;    <span class="keyword">private</span> <span class="built_in">boolean</span> locked;    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">lock</span>(<span class="params"></span>)</span> &#123;        <span class="built_in">this</span>.locked = <span class="literal">true</span>;    &#125;    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">unlock</span>(<span class="params"></span>)</span> &#123;        <span class="built_in">this</span>.locked = <span class="literal">false</span>;    &#125;    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="function"><span class="title">locked</span>(<span class="params"></span>)</span> &#123;        <span class="keyword">return</span> <span class="built_in">this</span>.locked;    &#125;    <span class="keyword">public</span> <span class="built_in">Object</span> invoke(MethodInvocation invocation) throws Throwable &#123;        <span class="keyword">if</span> (locked() &amp;&amp; invocation.getMethod().getName().indexOf(<span class="string">&quot;set&quot;</span>) == <span class="number">0</span>) &#123;            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException();        &#125;        <span class="keyword">return</span> <span class="built_in">super</span>.invoke(invocation);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸ï¼Œæ‚¨æ— éœ€è¦†ç›–<code>invoke()</code>æ–¹æ³•ã€‚é€šå¸¸ï¼Œ<code>DelegatingIntroductionInterceptor</code>å®ç°(å¦‚æœå¼•å…¥äº†<code>delegate</code>æ–¹æ³•ï¼Œåˆ™è°ƒç”¨<code>delegate</code>æ–¹æ³•ï¼Œå¦åˆ™ continue å‘è¿æ¥ç‚¹å‰è¿›)ã€‚åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªæ£€æŸ¥ï¼šå¦‚æœå¤„äºé”å®šæ¨¡å¼ï¼Œåˆ™ä¸èƒ½è°ƒç”¨ä»»ä½• setter æ–¹æ³•ã€‚</p>
<p>æ‰€éœ€çš„ç®€ä»‹ä»…éœ€è¦ä¿å­˜ä¸€ä¸ªä¸åŒçš„<code>LockMixin</code>å®ä¾‹å¹¶æŒ‡å®šæ‰€å¼•å…¥çš„æ¥å£(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªéœ€<code>Lockable</code>)ã€‚ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹å¯èƒ½å¼•ç”¨äº†å¼•å…¥æ‹¦æˆªå™¨(å°†è¢«å®šä¹‰ä¸ºåŸå‹)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ä¸<code>LockMixin</code>ç›¸å…³çš„é…ç½®ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨<code>new</code>åˆ›å»ºå®ƒã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†<code>LockMixinAdvisor</code>ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockMixinAdvisor</span> <span class="keyword">extends</span> <span class="title">DefaultIntroductionAdvisor</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="title">LockMixinAdvisor</span><span class="params">()</span> </span>&#123;        <span class="keyword">super</span>(<span class="keyword">new</span> LockMixin(), Lockable.class);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥éå¸¸ç®€å•åœ°åº”ç”¨æ­¤é¡¾é—®ç¨‹åºï¼Œå› ä¸ºå®ƒä¸éœ€è¦é…ç½®ã€‚ (ä½†æ˜¯ï¼Œå¦‚æœæ²¡æœ‰<code>IntroductionAdvisor</code>ï¼Œå°±ä¸å¯èƒ½ä½¿ç”¨<code>IntroductionInterceptor</code>.)åƒé€šå¸¸çš„ä»‹ç»ä¸€æ ·ï¼Œé¡¾é—®ç¨‹åºå¿…é¡»æ˜¯æŒ‰å®ä¾‹çš„ï¼Œå› ä¸ºå®ƒæ˜¯æœ‰çŠ¶æ€çš„ã€‚å¯¹äºæ¯ä¸ªå»ºè®®å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦<code>LockMixinAdvisor</code>çš„ä¸åŒå®ä¾‹ï¼Œå› æ­¤éœ€è¦<code>LockMixin</code>ã€‚é¡¾é—®ç¨‹åºåŒ…å«å»ºè®®å¯¹è±¡çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åƒå…¶ä»–ä»»ä½•é¡¾é—®ä¸€æ ·ï¼Œé€šè¿‡ä½¿ç”¨<code>Advised.addAdvisor()</code>æ–¹æ³•æˆ– XML é…ç½®ä¸­çš„(æ¨èæ–¹å¼)ä»¥ç¼–ç¨‹æ–¹å¼åº”ç”¨æ­¤é¡¾é—®ã€‚ä¸‹é¢è®¨è®ºçš„æ‰€æœ‰ä»£ç†åˆ›å»ºé€‰æ‹©ï¼ŒåŒ…æ‹¬â€œè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨â€ï¼Œéƒ½å¯ä»¥æ­£ç¡®å¤„ç†ä»‹ç»å’Œæœ‰çŠ¶æ€çš„æ··åˆã€‚</p>
<h3 id="6-3-Spring-çš„-Advisor-API"><a href="#6-3-Spring-çš„-Advisor-API" class="headerlink" title="6.3. Spring çš„ Advisor API"></a>6.3. Spring çš„ Advisor API</h3><p>åœ¨ Spring ä¸­ï¼Œé¡¾é—®ç¨‹åºæ˜¯ä¸€ä¸ªåˆ‡é¢ï¼Œå…¶ä¸­ä»…åŒ…å«ä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å…³è”çš„å•ä¸ªå»ºè®®å¯¹è±¡ã€‚</p>
<p>é™¤äº†ä»‹ç»çš„ç‰¹æ®Šæƒ…å†µå¤–ï¼Œä»»ä½•é¡¾é—®éƒ½å¯ä»¥ä¸ä»»ä½•å»ºè®®ä¸€èµ·ä½¿ç”¨ã€‚ <code>org.springframework.aop.support.DefaultPointcutAdvisor</code>æ˜¯æœ€å¸¸ç”¨çš„é¡¾é—®ç±»ã€‚å¯ä»¥ä¸<code>MethodInterceptor</code>ï¼Œ<code>BeforeAdvice</code>æˆ–<code>ThrowsAdvice</code>ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>å¯ä»¥åœ¨åŒä¸€ AOP ä»£ç†ä¸­çš„ Spring ä¸­æ··åˆä½¿ç”¨é¡¾é—®å’Œå»ºè®®ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ä¸€ä¸ªä»£ç†é…ç½®ä¸­ä½¿ç”¨å›´ç»•å»ºè®®çš„æ‹¦æˆªï¼ŒæŠ›å‡ºå»ºè®®ä»¥åŠåœ¨å»ºè®®ä¹‹å‰ã€‚ Spring è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„æ‹¦æˆªå™¨é“¾ã€‚</p>
<h3 id="6-4-ä½¿ç”¨-ProxyFactoryBean-åˆ›å»º-AOP-ä»£ç†"><a href="#6-4-ä½¿ç”¨-ProxyFactoryBean-åˆ›å»º-AOP-ä»£ç†" class="headerlink" title="6.4. ä½¿ç”¨ ProxyFactoryBean åˆ›å»º AOP ä»£ç†"></a>6.4. ä½¿ç”¨ ProxyFactoryBean åˆ›å»º AOP ä»£ç†</h3><p>å¦‚æœå°† Spring IoC å®¹å™¨(<code>ApplicationContext</code>æˆ–<code>BeanFactory</code>)ç”¨äºä¸šåŠ¡å¯¹è±¡(åº”è¯¥æ˜¯ï¼)ï¼Œåˆ™è¦ä½¿ç”¨ Spring çš„ AOP <code>FactoryBean</code>å®ç°ä¹‹ä¸€ã€‚ (è¯·è®°ä½ï¼Œå·¥å‚ bean å¼•å…¥äº†ä¸€ä¸ªé—´æ¥å±‚ï¼Œå…è®¸å®ƒåˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡.)</p>
<p>Note</p>
<p>Spring AOP æ”¯æŒè¿˜åœ¨åå°ä½¿ç”¨äº†å·¥å‚ beanã€‚</p>
<p>åœ¨ Spring ä¸­åˆ›å»º AOP ä»£ç†çš„åŸºæœ¬æ–¹æ³•æ˜¯ä½¿ç”¨<code>org.springframework.aop.framework.ProxyFactoryBean</code>ã€‚è¿™æ ·å¯ä»¥å®Œå…¨æ§åˆ¶åˆ‡å…¥ç‚¹ï¼Œä»»ä½•é€‚ç”¨çš„å»ºè®®åŠå…¶ Sequencesã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä¸éœ€è¦è¿™æ ·çš„æ§åˆ¶ï¼Œåˆ™æœ‰ä¸€äº›æ›´ç®€å•çš„é€‰é¡¹æ˜¯å¯å–çš„ã€‚</p>
<h4 id="6-4-1-Basics"><a href="#6-4-1-Basics" class="headerlink" title="6.4.1. Basics"></a>6.4.1. Basics</h4><p>åƒå…¶ä»– Spring <code>FactoryBean</code>å®ç°ä¸€æ ·ï¼Œ<code>ProxyFactoryBean</code>å¼•å…¥äº†ä¸€ä¸ªé—´æ¥çº§åˆ«ã€‚å¦‚æœå®šä¹‰ä¸€ä¸ªåä¸º<code>foo</code>çš„<code>ProxyFactoryBean</code>ï¼Œåˆ™å¼•ç”¨<code>foo</code>çš„å¯¹è±¡çœ‹ä¸åˆ°<code>ProxyFactoryBean</code>å®ä¾‹æœ¬èº«ï¼Œè€Œæ˜¯çœ‹åˆ°é€šè¿‡<code>ProxyFactoryBean</code>ä¸­çš„<code>getObject()</code>æ–¹æ³•çš„å®ç°åˆ›å»ºçš„å¯¹è±¡ã€‚æ­¤æ–¹æ³•åˆ›å»ºä¸€ä¸ªåŒ…è£…ç›®æ ‡å¯¹è±¡çš„ AOP ä»£ç†ã€‚</p>
<p>ä½¿ç”¨<code>ProxyFactoryBean</code>æˆ–å¦ä¸€ä¸ª IoC æ„ŸçŸ¥ç±»åˆ›å»º AOP ä»£ç†çš„æœ€é‡è¦å¥½å¤„ä¹‹ä¸€æ˜¯ï¼ŒIoC ä¹Ÿå¯ä»¥ Management å»ºè®®å’Œåˆ‡å…¥ç‚¹ã€‚è¿™æ˜¯ä¸€é¡¹å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯å®ç°æŸäº›å…¶ä»– AOP æ¡†æ¶éš¾ä»¥å®ç°çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå—ç›Šäºä¾èµ–æ³¨å…¥æä¾›çš„æ‰€æœ‰å¯æ’å…¥æ€§ï¼Œå»ºè®®æœ¬èº«å¯ä»¥å¼•ç”¨åº”ç”¨ç¨‹åºå¯¹è±¡(ç›®æ ‡ä¹‹å¤–ï¼Œç›®æ ‡åº”è¯¥åœ¨ä»»ä½• AOP æ¡†æ¶ä¸­å¯ç”¨)ã€‚</p>
<h4 id="6-4-2-JavaBean-å±æ€§"><a href="#6-4-2-JavaBean-å±æ€§" class="headerlink" title="6.4.2. JavaBean å±æ€§"></a>6.4.2. JavaBean å±æ€§</h4><p>ä¸ Spring æä¾›çš„å¤§å¤šæ•°<code>FactoryBean</code>å®ç°ä¸€æ ·ï¼Œ<code>ProxyFactoryBean</code>ç±»æœ¬èº«å°±æ˜¯ JavaBeanã€‚å…¶å±æ€§ç”¨äºï¼š</p>
<ul>
<li>æŒ‡å®šæ‚¨è¦ä»£ç†çš„ç›®æ ‡ã€‚</li>
<li>æŒ‡å®šæ˜¯å¦ä½¿ç”¨ CGLIB(ç¨åä»‹ç»ï¼Œå¦è¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-pfb-proxy-types">åŸºäº JDK å’Œ CGLIB çš„ä»£ç†</a>)ã€‚</li>
</ul>
<p>ä¸€äº›å…³é”®å±æ€§æ˜¯ä»<code>org.springframework.aop.framework.ProxyConfig</code>(Spring ä¸­æ‰€æœ‰ AOP ä»£ç†å·¥å‚çš„è¶…ç±»)ç»§æ‰¿çš„ã€‚è¿™äº›å…³é”®å±æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>proxyTargetClass</code>ï¼š<code>true</code>(å¦‚æœè¦ä»£ç†ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯ç›®æ ‡ç±»çš„æ¥å£)ã€‚å¦‚æœæ­¤å±æ€§å€¼è®¾ç½®ä¸º<code>true</code>ï¼Œé‚£ä¹ˆå°†åˆ›å»º CGLIB ä»£ç†(ä½†ä¹Ÿè¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-pfb-proxy-types">åŸºäº JDK å’Œ CGLIB çš„ä»£ç†</a>)ã€‚</li>
<li><code>optimize</code>ï¼šæ§åˆ¶æ˜¯å¦å°†ç§¯æçš„ä¼˜åŒ–åº”ç”¨äºé€šè¿‡ CGLIB åˆ›å»ºçš„ä»£ç†ã€‚é™¤éæ‚¨å®Œå…¨äº†è§£ç›¸å…³çš„ AOP ä»£ç†å¦‚ä½•å¤„ç†ä¼˜åŒ–ï¼Œå¦åˆ™ä¸è¦éšæ„ä½¿ç”¨æ­¤è®¾ç½®ã€‚å½“å‰ä»…ç”¨äº CGLIB ä»£ç†ã€‚å®ƒå¯¹ JDK åŠ¨æ€ä»£ç†æ— æ•ˆã€‚</li>
<li><code>frozen</code>ï¼šå¦‚æœä»£ç†é…ç½®ä¸º<code>frozen</code>ï¼Œåˆ™ä¸å†å…è®¸æ›´æ”¹é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªè½»å¾®çš„ä¼˜åŒ–ï¼Œå¯¹äºåœ¨æ‚¨ä¸å¸Œæœ›è°ƒç”¨è€…åœ¨åˆ›å»ºä»£ç†åèƒ½å¤Ÿ(é€šè¿‡<code>Advised</code>æ¥å£)æ“çºµä»£ç†çš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚æ­¤å±æ€§çš„é»˜è®¤å€¼ä¸º<code>false</code>ï¼Œå› æ­¤å…è®¸è¿›è¡Œæ›´æ”¹(ä¾‹å¦‚æ·»åŠ å…¶ä»–å»ºè®®)ã€‚</li>
<li><code>exposeProxy</code>ï¼šç¡®å®šæ˜¯å¦åº”åœ¨<code>ThreadLocal</code>ä¸­å…¬å¼€å½“å‰ä»£ç†ï¼Œä»¥ä¾¿ç›®æ ‡å¯ä»¥è®¿é—®å®ƒã€‚å¦‚æœç›®æ ‡éœ€è¦è·å–ä»£ç†å¹¶ä¸”<code>exposeProxy</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ï¼Œåˆ™ç›®æ ‡å¯ä»¥ä½¿ç”¨<code>AopContext.currentProxy()</code>æ–¹æ³•ã€‚</li>
</ul>
<p><code>ProxyFactoryBean</code>ç‰¹æœ‰çš„å…¶ä»–å±æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>proxyInterfaces</code>ï¼š<code>String</code>æ¥å£åç§°çš„æ•°ç»„ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™ä½¿ç”¨ç›®æ ‡ç±»çš„ CGLIB ä»£ç†(å¦è¯·å‚è§<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-pfb-proxy-types">åŸºäº JDK å’Œ CGLIB çš„ä»£ç†</a>)ã€‚</li>
<li><code>interceptorNames</code>ï¼šè¦åº”ç”¨çš„<code>Advisor</code>ï¼Œæ‹¦æˆªå™¨æˆ–å…¶ä»–å»ºè®®åç§°çš„<code>String</code>æ•°ç»„ã€‚Sequences å¾ˆé‡è¦ï¼Œå…ˆåˆ°å…ˆå¾—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æ˜¯ç¬¬ä¸€ä¸ªèƒ½å¤Ÿæ‹¦æˆªè°ƒç”¨çš„æ‹¦æˆªå™¨ã€‚</li>
</ul>
<p>åç§°æ˜¯å½“å‰å·¥å‚ä¸­çš„ bean åç§°ï¼ŒåŒ…æ‹¬ç¥–å…ˆå·¥å‚ä¸­çš„ bean åç§°ã€‚æ‚¨ä¸èƒ½åœ¨è¿™é‡ŒæåŠ bean å¼•ç”¨ï¼Œå› ä¸ºè¿™æ ·åšä¼šå¯¼è‡´<code>ProxyFactoryBean</code>å¿½ç•¥å»ºè®®çš„å•ä¾‹è®¾ç½®ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨æ‹¦æˆªå™¨åç§°ååŠ ä¸Šæ˜Ÿå·(<code>*</code>)ã€‚è¿™æ ·åšä¼šå¯¼è‡´åº”ç”¨æ‰€æœ‰é¡¾é—® Beanï¼Œå…¶åç§°ä»¥è¦åº”ç”¨æ˜Ÿå·çš„éƒ¨åˆ†å¼€å¤´ã€‚æ‚¨å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#aop-global-advisors">ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®</a>ä¸­æ‰¾åˆ°ä½¿ç”¨æ­¤åŠŸèƒ½çš„ç¤ºä¾‹ã€‚</p>
<ul>
<li>å•ä¾‹ï¼šæ— è®ºè°ƒç”¨<code>getObject()</code>æ–¹æ³•çš„é¢‘ç‡å¦‚ä½•ï¼Œå·¥å‚æ˜¯å¦åº”è¿”å›å•ä¸ªå¯¹è±¡ã€‚å‡ ç§<code>FactoryBean</code>å®ç°æä¾›äº†è¿™ç§æ–¹æ³•ã€‚é»˜è®¤å€¼ä¸º<code>true</code>ã€‚å¦‚æœè¦ä½¿ç”¨çŠ¶æ€é€šçŸ¥(ä¾‹å¦‚ï¼Œå¯¹äºçŠ¶æ€æ··åˆ)ï¼Œè¯·ä½¿ç”¨åŸå‹å»ºè®®ä»¥åŠ<code>false</code>çš„å•ä¾‹å€¼ã€‚</li>
</ul>
<h4 id="6-4-3-åŸºäº-JDK-å’Œ-CGLIB-çš„ä»£ç†"><a href="#6-4-3-åŸºäº-JDK-å’Œ-CGLIB-çš„ä»£ç†" class="headerlink" title="6.4.3. åŸºäº JDK å’Œ CGLIB çš„ä»£ç†"></a>6.4.3. åŸºäº JDK å’Œ CGLIB çš„ä»£ç†</h4><p>æœ¬éƒ¨åˆ†æ˜¯æœ‰å…³<code>ProxyFactoryBean</code>å¦‚ä½•é€‰æ‹©ä¸ºç‰¹å®šç›®æ ‡å¯¹è±¡(å°†è¢«ä»£ç†)åˆ›å»ºåŸºäº JDK çš„ä»£ç†æˆ–åŸºäº CGLIB çš„ä»£ç†çš„ Authority æ€§æ–‡æ¡£ã€‚</p>
<p>Note</p>
<p>åœ¨ Spring çš„ 1.2.x ç‰ˆå’Œ 2.0 ç‰ˆä¹‹é—´ï¼Œ<code>ProxyFactoryBean</code>åˆ›å»ºåŸºäº JDK æˆ– CGLIB çš„ä»£ç†çš„è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ã€‚ <code>ProxyFactoryBean</code>ç°åœ¨åœ¨è‡ªåŠ¨æ£€æµ‹æ¥å£åˆ‡é¢è¡¨ç°å‡ºä¸<code>TransactionProxyFactoryBean</code>ç±»ç±»ä¼¼çš„è¯­ä¹‰ã€‚</p>
<p>å¦‚æœè¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡çš„ç±»(ä»¥ä¸‹ç®€ç§°ä¸ºç›®æ ‡ç±»)æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œåˆ™å°†åˆ›å»ºåŸºäº CGLIB çš„ä»£ç†ã€‚è¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œå› ä¸º JDK ä»£ç†æ˜¯åŸºäºæ¥å£çš„ï¼Œå¹¶ä¸”æ²¡æœ‰æ¥å£æ„å‘³ç€ç”šè‡³æ— æ³•è¿›è¡Œ JDK ä»£ç†ã€‚æ‚¨å¯ä»¥æ’å…¥ç›®æ ‡ bean å¹¶é€šè¿‡è®¾ç½®<code>interceptorNames</code>å±æ€§æ¥æŒ‡å®šæ‹¦æˆªå™¨åˆ—è¡¨ã€‚è¯·æ³¨æ„ï¼Œå³ä½¿<code>ProxyFactoryBean</code>çš„<code>proxyTargetClass</code>å±æ€§å·²è®¾ç½®ä¸º<code>false</code>ï¼Œä¹Ÿä¼šåˆ›å»ºåŸºäº CGLIB çš„ä»£ç†ã€‚ (è¿™æ ·åšæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œæœ€å¥½å°†å…¶ä» Bean å®šä¹‰ä¸­åˆ é™¤ï¼Œå› ä¸ºå®ƒå……å…¶é‡æ˜¯å¤šä½™çš„ï¼Œå¹¶ä¸”åœ¨æœ€ç³Ÿçš„æƒ…å†µä¸‹ä¼šé€ æˆæ··æ·†.)</p>
<p>å¦‚æœç›®æ ‡ç±»å®ç°ä¸€ä¸ª(æˆ–å¤šä¸ª)æ¥å£ï¼Œåˆ™åˆ›å»ºçš„ä»£ç†ç±»å‹å–å†³äº<code>ProxyFactoryBean</code>çš„é…ç½®ã€‚</p>
<p>å¦‚æœ<code>ProxyFactoryBean</code>çš„<code>proxyTargetClass</code>å±æ€§å·²è®¾ç½®ä¸º<code>true</code>ï¼Œåˆ™ä¼šåˆ›å»ºåŸºäº CGLIB çš„ä»£ç†ã€‚è¿™æ˜¯æœ‰é“ç†çš„ï¼Œå¹¶ä¸”ç¬¦åˆæœ€å°æƒŠè®¶åŸåˆ™ã€‚å³ä½¿å·²å°†<code>ProxyFactoryBean</code>çš„<code>proxyInterfaces</code>å±æ€§è®¾ç½®ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå®Œå…¨é™å®šçš„æ¥å£åç§°ï¼Œä½†<code>proxyTargetClass</code>å±æ€§è®¾ç½®ä¸º<code>true</code>çš„äº‹å®ä¹Ÿä¼šå¯¼è‡´åŸºäº CGLIB çš„ä»£ç†ç”Ÿæ•ˆã€‚</p>
<p>å¦‚æœ<code>ProxyFactoryBean</code>çš„<code>proxyInterfaces</code>å±æ€§å·²è®¾ç½®ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå®Œå…¨é™å®šçš„æ¥å£åç§°ï¼Œåˆ™å°†åˆ›å»ºåŸºäº JDK çš„ä»£ç†ã€‚åˆ›å»ºçš„ä»£ç†å®ç°<code>proxyInterfaces</code>å±æ€§ä¸­æŒ‡å®šçš„æ‰€æœ‰æ¥å£ã€‚å¦‚æœç›®æ ‡ç±»æ°å¥½å®ç°äº†æ¯”<code>proxyInterfaces</code>å±æ€§ä¸­æŒ‡å®šçš„æ¥å£æ›´å¤šçš„æ¥å£ï¼Œé‚£å°±å¾ˆå¥½äº†ï¼Œä½†æ˜¯è¿™äº›é™„åŠ æ¥å£ä¸ä¼šç”±è¿”å›çš„ä»£ç†å®ç°ã€‚</p>
<p>å¦‚æœå°šæœªè®¾ç½®<code>ProxyFactoryBean</code>çš„<code>proxyInterfaces</code>å±æ€§ï¼Œä½†æ˜¯ç›®æ ‡ç±»ç¡®å®å®ç°äº†ä¸€ä¸ª(æˆ–å¤šä¸ª)æ¥å£ï¼Œåˆ™<code>ProxyFactoryBean</code>è‡ªåŠ¨æ£€æµ‹åˆ°ç›®æ ‡ç±»å®é™…ä¸Šç¡®å®å®ç°äº†è‡³å°‘ä¸€ä¸ªæ¥å£ä»¥åŠåŸºäº JDK çš„ä»£ç†è¢«æ„å»ºã€‚å®é™…ä»£ç†çš„æ¥å£æ˜¯ç›®æ ‡ç±»å®ç°çš„æ‰€æœ‰æ¥å£ã€‚å®é™…ä¸Šï¼Œè¿™ä¸å‘<code>proxyInterfaces</code>å±æ€§æä¾›ç›®æ ‡ç±»å®ç°çš„æ¯ä¸ªæ¥å£çš„åˆ—è¡¨ç›¸åŒã€‚ä½†æ˜¯ï¼Œå®ƒçš„å·¥ä½œé‡å¤§å¤§å‡å°‘ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºç°å°åˆ·é”™è¯¯ã€‚</p>
<h4 id="6-4-4-ä»£ç†æ¥å£"><a href="#6-4-4-ä»£ç†æ¥å£" class="headerlink" title="6.4.4. ä»£ç†æ¥å£"></a>6.4.4. ä»£ç†æ¥å£</h4><p>è€ƒè™‘ä¸€ä¸ªå®é™…çš„<code>ProxyFactoryBean</code>çš„ç®€å•ç¤ºä¾‹ã€‚æ­¤ç¤ºä¾‹æ¶‰åŠï¼š</p>
<ul>
<li>ä»£ç†çš„ç›®æ ‡ beanã€‚è¿™æ˜¯ç¤ºä¾‹ä¸­çš„<code>personTarget</code> bean å®šä¹‰ã€‚</li>
<li><code>Advisor</code>å’Œ<code>Interceptor</code>ç”¨äºæä¾›å»ºè®®ã€‚</li>
<li>ä¸€ä¸ª AOP ä»£ç† bean å®šä¹‰ï¼Œç”¨äºæŒ‡å®šç›®æ ‡å¯¹è±¡(<code>personTarget</code> bean)ï¼Œä»£ç†æ¥å£ä»¥åŠè¦åº”ç”¨çš„å»ºè®®ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†ç¤ºä¾‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personTarget&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.PersonImpl&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tony&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;51&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myAdvisor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.MyAdvisor&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;someProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Custom string property value&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;debugInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.interceptor.DebugInterceptor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span>    <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;proxyInterfaces&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mycompany.Person&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;personTarget&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptorNames&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>myAdvisor<span class="tag">&lt;/<span class="name">value</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>debugInterceptor<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œ<code>interceptorNames</code>å±æ€§å…·æœ‰<code>String</code>åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«å½“å‰å·¥å‚ä¸­çš„æ‹¦æˆªå™¨æˆ–é¡¾é—®ç¨‹åºçš„ Bean åç§°ã€‚æ‚¨å¯ä»¥åœ¨è¿”å›ä¹‹å‰ï¼Œä¹‹åä½¿ç”¨é¡¾é—®ç¨‹åºï¼Œæ‹¦æˆªå™¨å¹¶å¼•å‘å»ºè®®å¯¹è±¡ã€‚é¡¾é—®çš„ Sequences å¾ˆé‡è¦ã€‚</p>
<p>Note</p>
<p>æ‚¨å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆåˆ—è¡¨ä¸åŒ…å« bean å¼•ç”¨ã€‚è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œå¦‚æœ<code>ProxyFactoryBean</code>çš„ singleton å±æ€§è®¾ç½®ä¸º<code>false</code>ï¼Œåˆ™å®ƒå¿…é¡»èƒ½å¤Ÿè¿”å›ç‹¬ç«‹çš„ä»£ç†å®ä¾‹ã€‚å¦‚æœä»»ä½•é¡¾é—®æœ¬èº«å°±æ˜¯åŸå‹ï¼Œåˆ™éœ€è¦è¿”å›ä¸€ä¸ªç‹¬ç«‹çš„å®ä¾‹ï¼Œå› æ­¤å¿…é¡»èƒ½å¤Ÿä»å·¥å‚è·å¾—åŸå‹çš„å®ä¾‹ã€‚ä¿æŒå¼•ç”¨æ˜¯ä¸å¤Ÿçš„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨å‰é¢æ˜¾ç¤ºçš„<code>person</code> bean å®šä¹‰ä»£æ›¿<code>Person</code>å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person person = (Person) factory.getBean(<span class="string">&quot;person&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸æ™®é€š Java å¯¹è±¡ä¸€æ ·ï¼Œåœ¨åŒä¸€ IoC ä¸Šä¸‹æ–‡ä¸­çš„å…¶ä»– bean å¯ä»¥è¡¨è¾¾å¯¹æ­¤çš„å¼ºç±»å‹ä¾èµ–æ€§ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personUser&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.PersonUser&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;person&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;person&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>PersonUser</code>ç±»å…¬å¼€äº†<code>Person</code>ç±»å‹çš„å±æ€§ã€‚å°±å…¶è€Œè¨€ï¼Œå¯ä»¥é€æ˜åœ°ä½¿ç”¨ AOP ä»£ç†ä»£æ›¿â€œçœŸå®çš„â€äººå®ç°ã€‚ä½†æ˜¯ï¼Œå…¶ç±»å°†æ˜¯åŠ¨æ€ä»£ç†ç±»ã€‚å¯ä»¥å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º<code>Advised</code>æ¥å£(ç¨åè®¨è®º)ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨åŒ¿åå†…éƒ¨ bean éšè—ç›®æ ‡å’Œä»£ç†ä¹‹é—´çš„åŒºåˆ«ã€‚åªæœ‰<code>ProxyFactoryBean</code>å®šä¹‰ä¸åŒã€‚è¯¥å»ºè®®ä»…å‡ºäºå®Œæ•´æ€§è€ƒè™‘ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨åŒ¿åå†…éƒ¨ beanï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myAdvisor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.MyAdvisor&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;someProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Custom string property value&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;debugInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.interceptor.DebugInterceptor&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;proxyInterfaces&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mycompany.Person&quot;</span>/&gt;</span>    <span class="comment">&lt;!-- Use inner bean, not local reference to target --&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.PersonImpl&quot;</span>&gt;</span>            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tony&quot;</span>/&gt;</span>            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;51&quot;</span>/&gt;</span>        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptorNames&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>myAdvisor<span class="tag">&lt;/<span class="name">value</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>debugInterceptor<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨åŒ¿åå†…éƒ¨ bean çš„ä¼˜ç‚¹æ˜¯åªæœ‰ä¸€ä¸ªç±»å‹ä¸º<code>Person</code>çš„å¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›é˜²æ­¢åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„ç”¨æˆ·è·å–å¯¹æœªå»ºè®®å¯¹è±¡çš„å¼•ç”¨ï¼Œæˆ–è€…éœ€è¦é¿å…ä½¿ç”¨ Spring IoC è‡ªåŠ¨è£…é…çš„ä»»ä½•æ­§ä¹‰ï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚å¯ä»¥è¯´ï¼Œè¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹æ˜¯<code>ProxyFactoryBean</code>å®šä¹‰æ˜¯ç‹¬ç«‹çš„ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶èƒ½å¤Ÿä»å·¥å‚è·å¾—æœªç»å»ºè®®çš„ç›®æ ‡å®é™…ä¸Šå¯èƒ½æ˜¯ä¸€ä¸ªä¼˜åŠ¿(ä¾‹å¦‚ï¼Œåœ¨æŸäº›æµ‹è¯•æ–¹æ¡ˆä¸­)ã€‚</p>
<h4 id="6-4-5-ä»£ç†ç±»"><a href="#6-4-5-ä»£ç†ç±»" class="headerlink" title="6.4.5. ä»£ç†ç±»"></a>6.4.5. ä»£ç†ç±»</h4><p>å¦‚æœæ‚¨éœ€è¦ä»£ç†ä¸€ç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨æˆ‘ä»¬ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæ²¡æœ‰<code>Person</code>æ¥å£ã€‚æˆ‘ä»¬éœ€è¦å»ºè®®ä¸€ä¸ªåä¸º<code>Person</code>çš„ç±»ï¼Œè¯¥ç±»æœªå®ç°ä»»ä½•ä¸šåŠ¡æ¥å£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°† Spring é…ç½®ä¸ºä½¿ç”¨ CGLIB ä»£ç†è€Œä¸æ˜¯åŠ¨æ€ä»£ç†ã€‚ä¸ºæ­¤ï¼Œè¯·å°†å‰é¢æ˜¾ç¤ºçš„<code>ProxyFactoryBean</code>çš„<code>proxyTargetClass</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ã€‚å°½ç®¡æœ€å¥½å¯¹æ¥å£è€Œä¸æ˜¯å¯¹ç±»è¿›è¡Œç¼–ç¨‹ï¼Œä½†æ˜¯åœ¨å¤„ç†é—ç•™ä»£ç æ—¶ï¼Œå»ºè®®æœªå®ç°æ¥å£çš„ç±»çš„åŠŸèƒ½å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚ (é€šå¸¸ï¼ŒSpring å¹¶ä¸æ˜¯è§„å®šæ€§çš„.è™½ç„¶å¯ä»¥è½»æ¾åœ°åº”ç”¨è‰¯å¥½å®è·µï¼Œä½†å¯ä»¥é¿å…å¼ºåˆ¶é‡‡ç”¨ç‰¹å®šæ–¹æ³•.)</p>
<p>å¦‚æœéœ€è¦ï¼Œå³ä½¿æ‚¨æœ‰æ¥å£ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»ä½•æƒ…å†µä¸‹å¼ºåˆ¶ä½¿ç”¨ CGLIBã€‚</p>
<p>CGLIB ä»£ç†é€šè¿‡åœ¨è¿è¡Œæ—¶ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»æ¥å·¥ä½œã€‚ Spring é…ç½®æ­¤ç”Ÿæˆçš„å­ç±»ä»¥å°†æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™åŸå§‹ç›®æ ‡ã€‚å­ç±»ç”¨äºå®ç° Decorator æ¨¡å¼ï¼Œå¹¶ç¼–ç»‡åœ¨å»ºè®®ä¸­ã€‚</p>
<p>CGLIB ä»£ç†é€šå¸¸åº”å¯¹ç”¨æˆ·é€æ˜ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€äº›é—®é¢˜è¦è€ƒè™‘ï¼š</p>
<ul>
<li>ä¸èƒ½å»ºè®®<code>Final</code>æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬ä¸èƒ½è¢«è¦†ç›–ã€‚</li>
<li>æ— éœ€å°† CGLIB æ·»åŠ åˆ°æ‚¨çš„ Classpath ä¸­ã€‚ä» Spring 3.2 å¼€å§‹ï¼ŒCGLIB è¢«é‡æ–°æ‰“åŒ…å¹¶åŒ…å«åœ¨ spring-core JAR ä¸­ã€‚æ¢å¥è¯è¯´ï¼ŒåŸºäº CGLIB çš„ AOP å°±åƒ JDK åŠ¨æ€ä»£ç†ä¸€æ ·â€œå¼€ç®±å³ç”¨â€ã€‚</li>
</ul>
<p>CGLIB ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¹‹é—´å‡ ä¹æ²¡æœ‰æ€§èƒ½å·®å¼‚ã€‚ä» Spring 1.0 å¼€å§‹ï¼ŒåŠ¨æ€ä»£ç†è¦å¿«ä¸€äº›ã€‚ä½†æ˜¯ï¼Œå°†æ¥å¯èƒ½ä¼šæ”¹å˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¸åº”ä½œä¸ºå†³å®šæ€§çš„è€ƒè™‘å› ç´ ã€‚</p>
<h4 id="6-4-6-ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®"><a href="#6-4-6-ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®" class="headerlink" title="6.4.6. ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®"></a>6.4.6. ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®</h4><p>é€šè¿‡åœ¨æ‹¦æˆªå™¨åç§°åé™„åŠ ä¸€ä¸ªæ˜Ÿå·ï¼Œæ‰€æœ‰å…·æœ‰ä¸è¯¥æ˜Ÿå·ä¹‹å‰çš„éƒ¨åˆ†åŒ¹é…çš„ Bean åç§°çš„é¡¾é—®ç¨‹åºéƒ½å°†æ·»åŠ åˆ°é¡¾é—®ç¨‹åºé“¾ä¸­ã€‚å¦‚æœæ‚¨éœ€è¦æ·»åŠ æ ‡å‡†çš„â€œå…¨å±€â€é¡¾é—®ç¨‹åºé›†ï¼Œè¿™å¯èƒ½ä¼šæ´¾ä¸Šç”¨åœºã€‚ä»¥ä¸‹ç¤ºä¾‹å®šä¹‰äº†ä¸¤ä¸ªå…¨å±€é¡¾é—®ç¨‹åºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;service&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptorNames&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>global*<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;global_debug&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.interceptor.DebugInterceptor&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;global_performance&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.interceptor.PerformanceMonitorInterceptor&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-ç®€æ´çš„ä»£ç†å®šä¹‰"><a href="#6-5-ç®€æ´çš„ä»£ç†å®šä¹‰" class="headerlink" title="6.5. ç®€æ´çš„ä»£ç†å®šä¹‰"></a>6.5. ç®€æ´çš„ä»£ç†å®šä¹‰</h3><p>ç‰¹åˆ«æ˜¯åœ¨å®šä¹‰äº‹åŠ¡ä»£ç†æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå¾—åˆ°è®¸å¤šç±»ä¼¼çš„ä»£ç†å®šä¹‰ã€‚ä½¿ç”¨çˆ¶å­ bean å®šä¹‰å’Œå­ bean å®šä¹‰ä»¥åŠå†…éƒ¨ bean å®šä¹‰å¯ä»¥ä½¿ä»£ç†å®šä¹‰æ›´åŠ ç®€æ´æ˜äº†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ºä»£ç†åˆ›å»ºçˆ¶æ¨¡æ¿ï¼Œbean å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;txProxyTemplate&quot;</span> <span class="attr">abstract</span>=<span class="string">&quot;true&quot;</span>        <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.interceptor.TransactionProxyFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionAttributes&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">props</span>&gt;</span>            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;*&quot;</span>&gt;</span>PROPAGATION_REQUIRED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>        <span class="tag">&lt;/<span class="name">props</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å®ƒæœ¬èº«ä»æœªå®ä¾‹åŒ–ï¼Œå› æ­¤å®é™…ä¸Šå¯èƒ½æ˜¯ä¸å®Œæ•´çš„ã€‚ç„¶åï¼Œæ¯ä¸ªéœ€è¦åˆ›å»ºçš„ä»£ç†éƒ½æ˜¯ä¸€ä¸ªå­ bean å®šä¹‰ï¼Œå®ƒå°†ä»£ç†çš„ç›®æ ‡åŒ…è£…ä¸ºå†…éƒ¨ bean å®šä¹‰ï¼Œå› ä¸ºæ— è®ºå¦‚ä½•è¯¥ç›®æ ‡éƒ½ä¸ä¼šå•ç‹¬ä½¿ç”¨ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†è¿™æ ·çš„å­ beanï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myService&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;txProxyTemplate&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.samples.MyServiceImpl&quot;</span>&gt;</span>        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥ä»çˆ¶æ¨¡æ¿è¦†ç›–å±æ€§ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è¦†ç›–äº‹åŠ¡ä¼ æ’­è®¾ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mySpecialService&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;txProxyTemplate&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.samples.MySpecialServiceImpl&quot;</span>&gt;</span>        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionAttributes&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">props</span>&gt;</span>            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;get*&quot;</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;find*&quot;</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;load*&quot;</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;store*&quot;</span>&gt;</span>PROPAGATION_REQUIRED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>        <span class="tag">&lt;/<span class="name">props</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œåœ¨çˆ¶ bean çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å°†<code>abstract</code>å±æ€§è®¾ç½®ä¸º<code>true</code>æ¥æ˜ç¡®æ ‡è®°çˆ¶ bean å®šä¹‰ä¸ºæŠ½è±¡ï¼Œå¦‚<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/core.html#beans-child-bean-definitions">previously</a>æ‰€è¿°ï¼Œå› æ­¤å®ƒå®é™…ä¸Šå¯èƒ½æ²¡æœ‰å®ä¾‹åŒ–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡(ä½†ä¸æ˜¯ç®€å•çš„ bean å·¥å‚)ä¼šé¢„å…ˆå®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹ã€‚å› æ­¤ï¼Œé‡è¦çš„æ˜¯(è‡³å°‘å¯¹äºå•ä¾‹ bean)ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ª(çˆ¶)bean å®šä¹‰ä»…æ‰“ç®—ç”¨ä½œæ¨¡æ¿ï¼Œå¹¶ä¸”æ­¤å®šä¹‰æŒ‡å®šäº†ä¸€ä¸ªç±»ï¼Œåˆ™å¿…é¡»ç¡®ä¿å°†<code>abstract</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ã€‚å¦åˆ™ï¼Œåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡å®é™…ä¸Šä¼šå°è¯•å¯¹å…¶è¿›è¡Œå®ä¾‹åŒ–ã€‚</p>
<h3 id="6-6-ä½¿ç”¨-ProxyFactory-ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º-AOP-ä»£ç†"><a href="#6-6-ä½¿ç”¨-ProxyFactory-ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º-AOP-ä»£ç†" class="headerlink" title="6.6. ä½¿ç”¨ ProxyFactory ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º AOP ä»£ç†"></a>6.6. ä½¿ç”¨ ProxyFactory ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º AOP ä»£ç†</h3><p>ä½¿ç”¨ Spring ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º AOP ä»£ç†å¾ˆå®¹æ˜“ã€‚è¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨ Spring AOPï¼Œè€Œæ— éœ€ä¾èµ– Spring IoCã€‚</p>
<p>ç”±ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£å°†è¢«è‡ªåŠ¨ä»£ç†ã€‚ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†ä½¿ç”¨ä¸€ä¸ªæ‹¦æˆªå™¨å’Œä¸€ä¸ªé¡¾é—®ç¨‹åºä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç†çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyFactory factory = <span class="keyword">new</span> ProxyFactory(myBusinessInterfaceImpl);factory.addAdvice(myMethodInterceptor);factory.addAdvisor(myAdvisor);MyBusinessInterface tb = (MyBusinessInterface) factory.getProxy();</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ­¥æ˜¯æ„é€ ç±»å‹ä¸º<code>org.springframework.aop.framework.ProxyFactory</code>çš„å¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç›®æ ‡å¯¹è±¡åˆ›å»ºæ­¤å¯¹è±¡ï¼Œå¦‚å‰é¢çš„ç¤ºä¾‹ä¸­æ‰€ç¤ºï¼Œæˆ–æŒ‡å®šè¦åœ¨å¤‡ç”¨æ„é€ å‡½æ•°ä¸­ä»£ç†çš„æ¥å£ã€‚</p>
<p>æ‚¨å¯ä»¥æ·»åŠ å»ºè®®(ä½¿ç”¨æ‹¦æˆªå™¨ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„å»ºè®®)ï¼Œå»ºè®®ç¨‹åºï¼Œæˆ–åŒæ—¶æ·»åŠ ä¸¤è€…ï¼Œå¹¶åœ¨<code>ProxyFactory</code>çš„ç”Ÿå‘½å‘¨æœŸå†…å¯¹å…¶è¿›è¡Œæ“ä½œã€‚å¦‚æœæ·»åŠ <code>IntroductionInterceptionAroundAdvisor</code>ï¼Œåˆ™å¯ä»¥ä½¿ä»£ç†å®ç°å…¶ä»–æ¥å£ã€‚</p>
<p><code>ProxyFactory</code>(ä»<code>AdvisedSupport</code>ç»§æ‰¿)ä¸Šè¿˜æœ‰ä¾¿æ·çš„æ–¹æ³•ï¼Œå¯è®©æ‚¨æ·»åŠ å…¶ä»–å»ºè®®ç±»å‹ï¼Œä¾‹å¦‚ before å¹¶å¼•å‘å»ºè®®ã€‚ <code>AdvisedSupport</code>æ˜¯<code>ProxyFactory</code>å’Œ<code>ProxyFactoryBean</code>çš„è¶…ç±»ã€‚</p>
<p>Tip</p>
<p>åœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ï¼Œå°† AOP ä»£ç†åˆ›å»ºä¸ IoC æ¡†æ¶é›†æˆåœ¨ä¸€èµ·æ˜¯æœ€ä½³å®è·µã€‚é€šå¸¸ï¼Œå»ºè®®æ‚¨ä½¿ç”¨ AOP ä» Java ä»£ç å¤–éƒ¨åŒ–é…ç½®ã€‚</p>
<h3 id="6-7-æ“ä½œå»ºè®®å¯¹è±¡"><a href="#6-7-æ“ä½œå»ºè®®å¯¹è±¡" class="headerlink" title="6.7. æ“ä½œå»ºè®®å¯¹è±¡"></a>6.7. æ“ä½œå»ºè®®å¯¹è±¡</h3><p>æ— è®ºåˆ›å»º AOP ä»£ç†ï¼Œéƒ½å¯ä»¥ä½¿ç”¨<code>org.springframework.aop.framework.Advised</code>ç•Œé¢å¯¹å…¶è¿›è¡Œæ“ä½œã€‚ä»»ä½• AOP ä»£ç†éƒ½å¯ä»¥å¼ºåˆ¶è½¬æ¢ä¸ºè¯¥æ¥å£ï¼Œæ— è®ºå®ƒå®ç°äº†å“ªä¸ªå…¶ä»–æ¥å£ã€‚è¯¥ç•Œé¢åŒ…æ‹¬ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Advisor[] getAdvisors();<span class="function"><span class="keyword">void</span> <span class="title">addAdvice</span><span class="params">(Advice advice)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">void</span> <span class="title">addAdvice</span><span class="params">(<span class="keyword">int</span> pos, Advice advice)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">void</span> <span class="title">addAdvisor</span><span class="params">(Advisor advisor)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">void</span> <span class="title">addAdvisor</span><span class="params">(<span class="keyword">int</span> pos, Advisor advisor)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(Advisor advisor)</span></span>;<span class="function"><span class="keyword">boolean</span> <span class="title">removeAdvisor</span><span class="params">(Advisor advisor)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">void</span> <span class="title">removeAdvisor</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">boolean</span> <span class="title">replaceAdvisor</span><span class="params">(Advisor a, Advisor b)</span> <span class="keyword">throws</span> AopConfigException</span>;<span class="function"><span class="keyword">boolean</span> <span class="title">isFrozen</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>getAdvisors()</code>æ–¹æ³•é’ˆå¯¹å·²æ·»åŠ åˆ°å·¥å‚çš„æ¯ä¸ªé¡¾é—®ç¨‹åºï¼Œæ‹¦æˆªå™¨æˆ–å…¶ä»–å»ºè®®ç±»å‹è¿”å›<code>Advisor</code>ã€‚å¦‚æœæ·»åŠ äº†<code>Advisor</code>ï¼Œåˆ™åœ¨æ­¤ç´¢å¼•å¤„è¿”å›çš„é¡¾é—®ç¨‹åºå°±æ˜¯æ‚¨æ·»åŠ çš„å¯¹è±¡ã€‚å¦‚æœæ·»åŠ äº†æ‹¦æˆªå™¨æˆ–å…¶ä»–å»ºè®®ç±»å‹ï¼ŒSpring ä¼šå°†å…¶åŒ…è£…åœ¨å¸¦æœ‰æŒ‡å‘å§‹ç»ˆè¿”å›<code>true</code>çš„åˆ‡å…¥ç‚¹çš„é¡¾é—®ç¨‹åºä¸­ã€‚å› æ­¤ï¼Œå¦‚æœæ·»åŠ äº†<code>MethodInterceptor</code>ï¼Œåˆ™ä¸ºæ­¤ç´¢å¼•è¿”å›çš„é¡¾é—®ç¨‹åºæ˜¯<code>DefaultPointcutAdvisor</code>ï¼Œå®ƒè¿”å›<code>MethodInterceptor</code>ä»¥åŠä¸æ‰€æœ‰ç±»å’Œæ–¹æ³•åŒ¹é…çš„åˆ‡å…¥ç‚¹ã€‚</p>
<p><code>addAdvisor()</code>æ–¹æ³•å¯ç”¨äºæ·»åŠ ä»»ä½•<code>Advisor</code>ã€‚é€šå¸¸ï¼Œæ‹¥æœ‰åˆ‡å…¥ç‚¹å’Œå»ºè®®çš„é¡¾é—®æ˜¯é€šç”¨çš„<code>DefaultPointcutAdvisor</code>ï¼Œæ‚¨å¯ä»¥å°†å…¶ä¸ä»»ä½•å»ºè®®æˆ–åˆ‡å…¥ç‚¹ä¸€èµ·ä½¿ç”¨(ä½†ä¸èƒ½ç”¨äºä»‹ç»)ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿å·²åˆ›å»ºä»£ç†ï¼Œä¹Ÿå¯ä»¥æ·»åŠ æˆ–åˆ é™¤é¡¾é—®ç¨‹åºæˆ–æ‹¦æˆªå™¨ã€‚å”¯ä¸€çš„é™åˆ¶æ˜¯ä¸å¯èƒ½æ·»åŠ æˆ–åˆ é™¤ä»‹ç»é¡¾é—®ï¼Œå› ä¸ºå·¥å‚ä¸­çš„ç°æœ‰ä»£ç†ä¸ä¼šæ˜¾ç¤ºç•Œé¢æ›´æ”¹ã€‚ (æ‚¨å¯ä»¥ä»å·¥å‚è·å–æ–°çš„ä»£ç†æ¥é¿å…æ­¤é—®é¢˜.)</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å°† AOP ä»£ç†æŠ•å°„åˆ°<code>Advised</code>æ¥å£å¹¶æ£€æŸ¥å’Œå¤„ç†å…¶å»ºè®®ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Advised advised = (Advised) myObject;Advisor[] advisors = advised.getAdvisors();<span class="built_in">int</span> oldAdvisorCount = advisors.length;System.<span class="keyword">out</span>.println(oldAdvisorCount + <span class="string">&quot; advisors&quot;</span>);<span class="comment">// Add an advice like an interceptor without a pointcut// Will match all proxied methods// Can use for interceptors, before, after returning or throws adviceadvised.addAdvice(new DebugInterceptor());// Add selective advice using a pointcutadvised.addAdvisor(new DefaultPointcutAdvisor(mySpecialPointcut, myAdvice));assertEquals(&quot;Added two advisors&quot;, oldAdvisorCount + 2, advised.getAdvisors().length);</span></span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>å°½ç®¡æ— ç–‘å­˜åœ¨åˆæ³•çš„ä½¿ç”¨æ¡ˆä¾‹ï¼Œä½†æ˜¯å¦å»ºè®®(æ— åŒå…³è¯­)ä¿®æ”¹ Producing çš„ä¸šåŠ¡å¯¹è±¡çš„å»ºè®®å€¼å¾—æ€€ç–‘ã€‚ä½†æ˜¯ï¼Œå®ƒåœ¨å¼€å‘ä¸­(ä¾‹å¦‚åœ¨æµ‹è¯•ä¸­)éå¸¸æœ‰ç”¨ã€‚æœ‰æ—¶æˆ‘ä»¬å‘ç°ä»¥æ‹¦æˆªå™¨æˆ–å…¶ä»–å»ºè®®çš„å½¢å¼æ·»åŠ æµ‹è¯•ä»£ç ï¼Œå¹¶è¿›å…¥æˆ‘ä»¬è¦æµ‹è¯•çš„æ–¹æ³•è°ƒç”¨ä¸­éå¸¸æœ‰ç”¨ã€‚ (ä¾‹å¦‚ï¼Œå»ºè®®å¯ä»¥è¿›å…¥ä¸ºè¯¥æ–¹æ³•åˆ›å»ºçš„äº‹åŠ¡å†…éƒ¨ï¼Œä¹Ÿè®¸å¯ä»¥åœ¨å°†äº‹åŠ¡æ ‡è®°ä¸ºå›æ»šä¹‹å‰è¿è¡Œ SQL ä»¥æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æ­£ç¡®æ›´æ–°.)</p>
<p>æ ¹æ®åˆ›å»ºä»£ç†çš„æ–¹å¼ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®<code>frozen</code>æ ‡å¿—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>Advised</code> <code>isFrozen()</code>æ–¹æ³•è¿”å›<code>true</code>ï¼Œè€Œé€šè¿‡æ·»åŠ æˆ–åˆ é™¤æ¥ä¿®æ”¹å»ºè®®çš„ä»»ä½•å°è¯•éƒ½å°†å¯¼è‡´<code>AopConfigException</code>ã€‚å†»ç»“å»ºè®®å¯¹è±¡çŠ¶æ€çš„åŠŸèƒ½åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨(ä¾‹å¦‚ï¼Œé˜²æ­¢è°ƒç”¨ä»£ç åˆ é™¤å®‰å…¨æ‹¦æˆªå™¨)ã€‚å¦‚æœå·²çŸ¥ä¸éœ€è¦ä¿®æ”¹è¿è¡Œæ—¶å»ºè®®ï¼Œåˆ™åœ¨ Spring 1.1 ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡Œç§¯æçš„ä¼˜åŒ–ã€‚</p>
<h3 id="6-8-ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€åŠŸèƒ½"><a href="#6-8-ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€åŠŸèƒ½" class="headerlink" title="6.8. ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€åŠŸèƒ½"></a>6.8. ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€åŠŸèƒ½</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è€ƒè™‘è¿‡ä½¿ç”¨<code>ProxyFactoryBean</code>æˆ–ç±»ä¼¼çš„å·¥å‚ bean æ¥æ˜¾å¼åˆ›å»º AOP ä»£ç†ã€‚</p>
<p>Spring è¿˜å…è®¸æˆ‘ä»¬ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€ Bean å®šä¹‰ï¼Œè¯¥å®šä¹‰å¯ä»¥è‡ªåŠ¨ä»£ç†é€‰å®šçš„ Bean å®šä¹‰ã€‚è¿™æ˜¯åœ¨ Spring çš„â€œ bean åå¤„ç†å™¨â€åŸºç¡€ç»“æ„ä¸Šæ„å»ºçš„ï¼Œè¯¥åŸºç¡€ç»“æ„å…è®¸åœ¨å®¹å™¨åŠ è½½æ—¶ä¿®æ”¹ä»»ä½• bean å®šä¹‰ã€‚</p>
<p>åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œæ‚¨åœ¨ XML bean å®šä¹‰æ–‡ä»¶ä¸­è®¾ç½®äº†ä¸€äº›ç‰¹æ®Šçš„ bean å®šä¹‰ï¼Œä»¥é…ç½®è‡ªåŠ¨ä»£ç†åŸºç¡€ç»“æ„ã€‚è¿™ä½¿æ‚¨å¯ä»¥å£°æ˜æœ‰èµ„æ ¼è¿›è¡Œè‡ªåŠ¨ä»£ç†çš„ç›®æ ‡ã€‚æ‚¨æ— éœ€ä½¿ç”¨<code>ProxyFactoryBean</code>ã€‚</p>
<p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š</p>
<ul>
<li>é€šè¿‡ä½¿ç”¨åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­å¼•ç”¨ç‰¹å®š bean çš„è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ã€‚</li>
<li>è‡ªåŠ¨ä»£ç†åˆ›å»ºçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå€¼å¾—å•ç‹¬è€ƒè™‘ï¼šç”±æºçº§å…ƒæ•°æ®å±æ€§é©±åŠ¨çš„è‡ªåŠ¨ä»£ç†åˆ›å»ºã€‚</li>
</ul>
<h4 id="6-8-1-è‡ªåŠ¨ä»£ç†-Bean-å®šä¹‰"><a href="#6-8-1-è‡ªåŠ¨ä»£ç†-Bean-å®šä¹‰" class="headerlink" title="6.8.1. è‡ªåŠ¨ä»£ç† Bean å®šä¹‰"></a>6.8.1. è‡ªåŠ¨ä»£ç† Bean å®šä¹‰</h4><p>æœ¬èŠ‚ä»‹ç»äº†<code>org.springframework.aop.framework.autoproxy</code>è½¯ä»¶åŒ…æä¾›çš„è‡ªåŠ¨ä»£ç†åˆ›å»ºè€…ã€‚</p>
<h5 id="BeanNameAutoProxyCreator"><a href="#BeanNameAutoProxyCreator" class="headerlink" title="BeanNameAutoProxyCreator"></a>BeanNameAutoProxyCreator</h5><p><code>BeanNameAutoProxyCreator</code>ç±»æ˜¯<code>BeanPostProcessor</code>ï¼Œå®ƒä¼šè‡ªåŠ¨ä¸ºåç§°ä¸ Literals å€¼æˆ–é€šé…ç¬¦åŒ¹é…çš„ bean åˆ›å»º AOP ä»£ç†ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•åˆ›å»º<code>BeanNameAutoProxyCreator</code> beanï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beanNames&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdk*,onlyJdk&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptorNames&quot;</span>&gt;</span>        <span class="tag">&lt;<span class="name">list</span>&gt;</span>            <span class="tag">&lt;<span class="name">value</span>&gt;</span>myInterceptor<span class="tag">&lt;/<span class="name">value</span>&gt;</span>        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>    <span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸<code>ProxyFactoryBean</code>ä¸€æ ·ï¼Œæœ‰<code>interceptorNames</code>å±æ€§è€Œä¸æ˜¯æ‹¦æˆªå™¨åˆ—è¡¨ï¼Œä»¥å…è®¸åŸå‹é¡¾é—®ç¨‹åºå…·æœ‰æ­£ç¡®çš„è¡Œä¸ºã€‚å‘½åä¸ºâ€œæ‹¦æˆªå™¨â€çš„å¯ä»¥æ˜¯é¡¾é—®æˆ–ä»»ä½•å»ºè®®ç±»å‹ã€‚</p>
<p>é€šå¸¸ï¼Œä¸è‡ªåŠ¨ä»£ç†ä¸€æ ·ï¼Œä½¿ç”¨<code>BeanNameAutoProxyCreator</code>çš„è¦ç‚¹æ˜¯å°†ç›¸åŒçš„é…ç½®ä¸€è‡´åœ°åº”ç”¨äºå¤šä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”é…ç½®é‡æœ€å°‘ã€‚å°†å£°æ˜å¼äº‹åŠ¡åº”ç”¨äºå¤šä¸ªå¯¹è±¡æ˜¯ä¸€ç§æµè¡Œçš„é€‰æ‹©ã€‚</p>
<p>åç§°åŒ¹é…çš„ Bean å®šä¹‰(ä¾‹å¦‚ä¸Šä¾‹ä¸­çš„<code>jdkMyBean</code>å’Œ<code>onlyJdk</code>)æ˜¯å¸¦æœ‰ç›®æ ‡ç±»çš„æ™®é€šæ—§ Bean å®šä¹‰ã€‚ <code>BeanNameAutoProxyCreator</code>è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª AOP ä»£ç†ã€‚ç›¸åŒçš„å»ºè®®é€‚ç”¨äºæ‰€æœ‰åŒ¹é…çš„ beanã€‚æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨äº†é¡¾é—®ç¨‹åº(è€Œä¸æ˜¯å‰é¢ç¤ºä¾‹ä¸­çš„æ‹¦æˆªå™¨)ï¼Œåˆ™åˆ‡å…¥ç‚¹å¯èƒ½ä¼šä¸åŒåœ°åº”ç”¨äºä¸åŒçš„ beanã€‚</p>
<h5 id="DefaultAdvisorAutoProxyCreator"><a href="#DefaultAdvisorAutoProxyCreator" class="headerlink" title="DefaultAdvisorAutoProxyCreator"></a>DefaultAdvisorAutoProxyCreator</h5><p>ä¸€ä¸ªæ›´é€šç”¨ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§çš„è‡ªåŠ¨ä»£ç†åˆ›å»ºè€…æ˜¯<code>DefaultAdvisorAutoProxyCreator</code>ã€‚è¿™å¯ä»¥åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­è‡ªåŠ¨åº”ç”¨åˆæ ¼çš„é¡¾é—®ç¨‹åºï¼Œè€Œæ— éœ€åœ¨è‡ªåŠ¨ä»£ç†é¡¾é—®ç¨‹åºçš„ Bean å®šä¹‰ä¸­åŒ…æ‹¬ç‰¹å®šçš„ Bean åç§°ã€‚å®ƒå…·æœ‰ä¸<code>BeanNameAutoProxyCreator</code>ç›¸åŒçš„ä¸€è‡´é…ç½®å’Œé¿å…é‡å¤çš„ä¼˜ç‚¹ã€‚</p>
<p>ä½¿ç”¨æ­¤æœºåˆ¶æ¶‰åŠï¼š</p>
<ul>
<li>æŒ‡å®š<code>DefaultAdvisorAutoProxyCreator</code> bean å®šä¹‰ã€‚</li>
<li>åœ¨ç›¸åŒæˆ–ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¸­æŒ‡å®šä»»æ„æ•°é‡çš„é¡¾é—®ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›å¿…é¡»æ˜¯é¡¾é—®ï¼Œè€Œä¸æ˜¯æ‹¦æˆªå™¨æˆ–å…¶ä»–å»ºè®®ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¿…é¡»æœ‰ä¸€ä¸ªè¯„ä¼°çš„åˆ‡å…¥ç‚¹ï¼Œä»¥æ£€æŸ¥æ¯ä¸ªå»ºè®®æ˜¯å¦ç¬¦åˆå€™é€‰ bean å®šä¹‰ã€‚</li>
</ul>
<p><code>DefaultAdvisorAutoProxyCreator</code>è‡ªåŠ¨è¯„ä¼°æ¯ä¸ªé¡¾é—®ä¸­åŒ…å«çš„åˆ‡å…¥ç‚¹ï¼Œä»¥æŸ¥çœ‹å®ƒåº”åº”ç”¨äºæ¯ä¸ªä¸šåŠ¡å¯¹è±¡çš„å»ºè®®(å¦‚æœæœ‰)(ä¾‹å¦‚ç¤ºä¾‹ä¸­çš„<code>businessObject1</code>å’Œ<code>businessObject2</code>)ã€‚</p>
<p>è¿™æ„å‘³ç€å¯ä»¥å°†ä»»æ„æ•°é‡çš„é¡¾é—®ç¨‹åºè‡ªåŠ¨åº”ç”¨äºæ¯ä¸ªä¸šåŠ¡å¯¹è±¡ã€‚å¦‚æœåœ¨ä»»ä½•é¡¾é—®ç¨‹åºä¸­æ²¡æœ‰åˆ‡å…¥ç‚¹ä¸ä¸šåŠ¡å¯¹è±¡ä¸­çš„ä»»ä½•æ–¹æ³•åŒ¹é…ï¼Œåˆ™è¯¥å¯¹è±¡ä¸ä¼šè¢«ä»£ç†ã€‚å½“ä¸ºæ–°çš„ä¸šåŠ¡å¯¹è±¡æ·»åŠ  Bean å®šä¹‰æ—¶ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨è¢«ä»£ç†ã€‚</p>
<p>é€šå¸¸ï¼Œè‡ªåŠ¨ä»£ç†çš„ä¼˜ç‚¹æ˜¯ä½¿è°ƒç”¨è€…æˆ–ä¾èµ–è€…æ— æ³•è·å¾—ä¸å»ºè®®çš„å¯¹è±¡ã€‚åœ¨æ­¤<code>ApplicationContext</code>ä¸Šè°ƒç”¨<code>getBean(&quot;businessObject1&quot;)</code>å°†è¿”å› AOP ä»£ç†ï¼Œè€Œä¸æ˜¯ç›®æ ‡ä¸šåŠ¡å¯¹è±¡ã€‚ (å‰é¢æ˜¾ç¤ºçš„â€œ inner beanâ€æƒ¯ç”¨è¯­ä¹Ÿæä¾›äº†è¿™ä¸€å¥½å¤„.)</p>
<p>ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºä¸€ä¸ª<code>DefaultAdvisorAutoProxyCreator</code> bean å’Œæœ¬èŠ‚ä¸­è®¨è®ºçš„å…¶ä»–å…ƒç´ ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span>/&gt;<span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionInterceptor&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionInterceptor&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;customAdvisor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.MyAdvisor&quot;</span>/&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;businessObject1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.BusinessObject1&quot;</span>&gt;</span>    <span class="comment">&lt;!-- Properties omitted --&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;businessObject2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.BusinessObject2&quot;</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦å°†ç›¸åŒçš„å»ºè®®ä¸€è‡´åœ°åº”ç”¨äºè®¸å¤šä¸šåŠ¡å¯¹è±¡ï¼Œåˆ™<code>DefaultAdvisorAutoProxyCreator</code>éå¸¸æœ‰ç”¨ã€‚åŸºç¡€ç»“æ„å®šä¹‰åˆ°ä½åï¼Œæ‚¨å¯ä»¥æ·»åŠ æ–°çš„ä¸šåŠ¡å¯¹è±¡ï¼Œè€Œæ— éœ€åŒ…æ‹¬ç‰¹å®šçš„ä»£ç†é…ç½®ã€‚æ‚¨è¿˜å¯ä»¥è½»æ¾åœ°æ·»åŠ å…¶ä»–åˆ‡é¢(ä¾‹å¦‚ï¼Œè·Ÿè¸ªæˆ–æ€§èƒ½ç›‘è§†åˆ‡é¢)ï¼Œè€Œå¯¹é…ç½®çš„æ›´æ”¹æœ€å°‘ã€‚</p>
<p><code>DefaultAdvisorAutoProxyCreator</code>æ”¯æŒè¿‡æ»¤(é€šè¿‡ä½¿ç”¨å‘½åçº¦å®šï¼Œä»¥ä¾¿ä»…è¯„ä¼°æŸäº›é¡¾é—®ç¨‹åºï¼Œä»è€Œå…è®¸åœ¨åŒä¸€å·¥å‚ä¸­ä½¿ç”¨å¤šä¸ªä¸åŒé…ç½®çš„ AdvisorAutoProxyCreators)å’Œæ’åºã€‚å¦‚æœå­˜åœ¨é—®é¢˜ï¼Œé¡¾é—®å¯ä»¥å®ç°<code>org.springframework.core.Ordered</code>æ¥å£ä»¥ç¡®ä¿æ­£ç¡®çš„æ’åºã€‚å‰é¢ç¤ºä¾‹ä¸­ä½¿ç”¨çš„<code>TransactionAttributeSourceAdvisor</code>å…·æœ‰å¯é…ç½®çš„ Sequences å€¼ã€‚é»˜è®¤è®¾ç½®ä¸ºæ— åºã€‚</p>
<h3 id="6-9-ä½¿ç”¨-TargetSource-å®ç°"><a href="#6-9-ä½¿ç”¨-TargetSource-å®ç°" class="headerlink" title="6.9. ä½¿ç”¨ TargetSource å®ç°"></a>6.9. ä½¿ç”¨ TargetSource å®ç°</h3><p>Spring æä¾›äº†<code>org.springframework.aop.TargetSource</code>æ¥å£ä¸­è¡¨ç¤ºçš„<code>TargetSource</code>çš„æ¦‚å¿µã€‚è¯¥æ¥å£è´Ÿè´£è¿”å›å®ç°è¿æ¥ç‚¹çš„â€œç›®æ ‡å¯¹è±¡â€ã€‚æ¯æ¬¡ AOP ä»£ç†å¤„ç†æ–¹æ³•è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šå‘<code>TargetSource</code>å®ç°è¯·æ±‚ç›®æ ‡å®ä¾‹ã€‚</p>
<p>ä½¿ç”¨ Spring AOP çš„å¼€å‘äººå‘˜é€šå¸¸ä¸éœ€è¦ç›´æ¥ä½¿ç”¨<code>TargetSource</code>å®ç°ï¼Œä½†è¿™æä¾›äº†æ”¯æŒæ± åŒ–ï¼Œçƒ­æ’æ‹”å’Œå…¶ä»–å¤æ‚ç›®æ ‡çš„å¼ºå¤§æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæ± <code>TargetSource</code>å¯ä»¥é€šè¿‡ä½¿ç”¨æ± æ¥ Management å®ä¾‹ï¼Œä»è€Œä¸ºæ¯æ¬¡è°ƒç”¨è¿”å›ä¸åŒçš„ç›®æ ‡å®ä¾‹ã€‚</p>
<p>å¦‚æœæœªæŒ‡å®š<code>TargetSource</code>ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å®ç°åŒ…è£…æœ¬åœ°å¯¹è±¡ã€‚æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ç›¸åŒçš„ç›®æ ‡(ä¸æ‚¨æœŸæœ›çš„ä¸€æ ·)ã€‚</p>
<p>æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†æè¿°äº† Spring éšé™„çš„æ ‡å‡†ç›®æ ‡æºä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚</p>
<p>Tip</p>
<p>ä½¿ç”¨è‡ªå®šä¹‰ç›®æ ‡æºæ—¶ï¼Œç›®æ ‡é€šå¸¸éœ€è¦æ˜¯åŸå‹è€Œä¸æ˜¯å•ä¾‹ bean å®šä¹‰ã€‚è¿™æ ·ï¼ŒSpring å¯ä»¥åœ¨éœ€è¦æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®æ ‡å®ä¾‹ã€‚</p>
<h4 id="6-9-1-å¯çƒ­äº¤æ¢çš„ç›®æ ‡æº"><a href="#6-9-1-å¯çƒ­äº¤æ¢çš„ç›®æ ‡æº" class="headerlink" title="6.9.1. å¯çƒ­äº¤æ¢çš„ç›®æ ‡æº"></a>6.9.1. å¯çƒ­äº¤æ¢çš„ç›®æ ‡æº</h4><p><code>org.springframework.aop.target.HotSwappableTargetSource</code>çš„å­˜åœ¨æ˜¯ä¸ºäº†å…è®¸ AOP ä»£ç†æœåŠ¡å™¨çš„ç›®æ ‡åˆ‡æ¢ï¼ŒåŒæ—¶å…è®¸å‘¼å«è€…ä¿ç•™å¯¹å…¶çš„å¼•ç”¨ã€‚</p>
<p>æ›´æ”¹ç›®æ ‡æºçš„ç›®æ ‡ä¼šç«‹å³ç”Ÿæ•ˆã€‚ <code>HotSwappableTargetSource</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ HotSwappableTargetSource ä¸Šçš„<code>swap()</code>æ–¹æ³•æ›´æ”¹ç›®æ ‡ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HotSwappableTargetSource swapper = (HotSwappableTargetSource) beanFactory.getBean(<span class="string">&quot;swapper&quot;</span>);</span><br><span class="line">Object oldTarget = swapper.swap(newTarget);</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¿…éœ€çš„ XML å®šä¹‰ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;initialTarget&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;mycompany.OldTarget&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;swapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.target.HotSwappableTargetSource&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;initialTarget&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;swappable&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;swapper&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„<code>swap()</code>è°ƒç”¨æ›´æ”¹äº†å¯äº¤æ¢ bean çš„ç›®æ ‡ã€‚æ‹¥æœ‰å¯¹è¯¥ bean çš„å¼•ç”¨çš„ Client ç«¯ä¸çŸ¥é“æ›´æ”¹ï¼Œä½†ç«‹å³å¼€å§‹è¾¾åˆ°æ–°ç›®æ ‡ã€‚</p>
<p>å°½ç®¡æ­¤ç¤ºä¾‹æœªæ·»åŠ ä»»ä½•å»ºè®®(ä½¿ç”¨<code>TargetSource</code>æ— éœ€æ·»åŠ å»ºè®®)ï¼Œä½†ä»»ä½•<code>TargetSource</code>å‡å¯ä¸ä»»æ„å»ºè®®ç»“åˆä½¿ç”¨ã€‚</p>
<h4 id="6-9-2-æ±‡é›†ç›®æ ‡æº"><a href="#6-9-2-æ±‡é›†ç›®æ ‡æº" class="headerlink" title="6.9.2. æ±‡é›†ç›®æ ‡æº"></a>6.9.2. æ±‡é›†ç›®æ ‡æº</h4><p>ä½¿ç”¨æ± ç›®æ ‡æºæä¾›äº†ä¸ Stateless ä¼šè¯ EJB ç›¸ä¼¼çš„ç¼–ç¨‹æ¨¡å‹ï¼Œåœ¨ Stateless ä¼šè¯ EJB ä¸­ï¼Œç»´æŠ¤äº†ç›¸åŒå®ä¾‹çš„æ± ï¼Œæ–¹æ³•è°ƒç”¨å°†é‡Šæ”¾æ± ä¸­çš„å¯¹è±¡ã€‚</p>
<p>Spring æ± å’Œ SLSB æ± ä¹‹é—´çš„å…³é”®åŒºåˆ«åœ¨äºï¼ŒSpring æ± å¯ä»¥åº”ç”¨äºä»»ä½• POJOã€‚é€šå¸¸ï¼Œä¸ Spring ä¸€æ ·ï¼Œå¯ä»¥ä»¥éä¾µå…¥æ€§æ–¹å¼åº”ç”¨æ­¤æœåŠ¡ã€‚</p>
<p>Spring æä¾›äº†å¯¹ Commons Pool 2.2 çš„æ”¯æŒï¼Œè¯¥æ± æä¾›äº†ç›¸å½“æœ‰æ•ˆçš„æ± å®ç°ã€‚æ‚¨éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„ Classpath ä¸Šä½¿ç”¨<code>commons-pool</code> Jar æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚æ‚¨è¿˜å¯ä»¥å°†<code>org.springframework.aop.target.AbstractPoolingTargetSource</code>å­ç±»åŒ–ä»¥æ”¯æŒä»»ä½•å…¶ä»–æ± åŒ– APIã€‚</p>
<p>Note</p>
<p>è¿˜æ”¯æŒ Commons Pool 1.5ï¼Œä½†ä» Spring Framework 4.2 å¼€å§‹ä¸æ¨èä½¿ç”¨ã€‚</p>
<p>ä»¥ä¸‹æ¸…å•æ˜¾ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;businessObjectTarget&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.MyBusinessObject&quot;</span>        <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span>    ... properties omitted<span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;poolTargetSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.target.CommonsPool2TargetSource&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;businessObjectTarget&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;25&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;businessObject&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;poolTargetSource&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptorNames&quot;</span> <span class="attr">value</span>=<span class="string">&quot;myInterceptor&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œç›®æ ‡å¯¹è±¡(ä¸Šä¾‹ä¸­ä¸º<code>businessObjectTarget</code>)å¿…é¡»æ˜¯åŸå‹ã€‚è¿™ä½¿<code>PoolingTargetSource</code>å®ç°å¯ä»¥åˆ›å»ºç›®æ ‡çš„æ–°å®ä¾‹ä»¥æ ¹æ®éœ€è¦æ‰©å±•æ± ã€‚æœ‰å…³å…¶å±æ€§çš„ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.1.3.RELEASE/javadoc-api/org/springframeworkaop/target/AbstractPoolingTargetSource.html">AbstractPoolingTargetSource çš„ javadoc</a>å’Œæ‚¨å¸Œæœ›ä½¿ç”¨çš„å…·ä½“å­ç±»ã€‚ <code>maxSize</code>æ˜¯æœ€åŸºæœ¬çš„ï¼Œå¹¶ä¸”å§‹ç»ˆä¿è¯å­˜åœ¨ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>myInterceptor</code>æ˜¯éœ€è¦åœ¨åŒä¸€ IoC ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„æ‹¦æˆªå™¨çš„åç§°ã€‚ä½†æ˜¯ï¼Œæ‚¨æ— éœ€æŒ‡å®šæ‹¦æˆªå™¨å³å¯ä½¿ç”¨æ± ã€‚å¦‚æœåªå¸Œæœ›æ± åŒ–è€Œæ²¡æœ‰å…¶ä»–å»ºè®®ï¼Œåˆ™æ ¹æœ¬ä¸è¦è®¾ç½®<code>interceptorNames</code>å±æ€§ã€‚</p>
<p>æ‚¨å¯ä»¥å°† Spring é…ç½®ä¸ºèƒ½å¤Ÿå°†ä»»ä½•æ± åŒ–å¯¹è±¡æŠ•å°„åˆ°<code>org.springframework.aop.target.PoolingConfig</code>æ¥å£ï¼Œè¯¥æ¥å£é€šè¿‡ä»‹ç»æ¥å…¬å¼€æœ‰å…³æ± çš„é…ç½®å’Œå½“å‰å¤§å°çš„ä¿¡æ¯ã€‚æ‚¨éœ€è¦å®šä¹‰ç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„é¡¾é—®ç¨‹åºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;poolConfigAdvisor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetObject&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;poolTargetSource&quot;</span>/&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;getPoolingConfigMixin&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åœ¨<code>AbstractPoolingTargetSource</code>ç±»ä¸Šè°ƒç”¨ä¾¿æ·æ–¹æ³•(å› æ­¤ä½¿ç”¨<code>MethodInvokingFactoryBean</code>)å¯è·å¾—æ­¤é¡¾é—®ç¨‹åºã€‚è¯¥é¡¾é—®çš„åç§°(æ­¤å¤„ä¸º<code>poolConfigAdvisor</code>)å¿…é¡»ä½äºå…¬å¼€æ± å¯¹è±¡çš„<code>ProxyFactoryBean</code>ä¸­çš„æ‹¦æˆªå™¨åç§°åˆ—è¡¨ä¸­ã€‚</p>
<p>æ¼”å‘˜è¡¨çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PoolingConfig conf = (PoolingConfig) beanFactory.getBean(<span class="string">&quot;businessObject&quot;</span>);System.<span class="keyword">out</span>.println(<span class="string">&quot;Max pool size is &quot;</span> + conf.getMaxSize());</span><br></pre></td></tr></table></figure>

<p>Note</p>
<p>é€šå¸¸ä¸éœ€è¦åˆå¹¶ Stateless æœåŠ¡å¯¹è±¡ã€‚æˆ‘ä»¬ä¸è®¤ä¸ºå®ƒåº”è¯¥æ˜¯é»˜è®¤é€‰æ‹©ï¼Œå› ä¸ºå¤§å¤šæ•° Stateless å¯¹è±¡è‡ªç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”å¦‚æœç¼“å­˜äº†èµ„æºï¼Œå®ä¾‹æ± ä¼šæˆé—®é¢˜ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨è‡ªåŠ¨ä»£ç†ï¼Œå¯ä»¥ç®€åŒ–æ± ã€‚æ‚¨å¯ä»¥è®¾ç½®ä»»ä½•è‡ªåŠ¨ä»£ç†åˆ›å»ºè€…ä½¿ç”¨çš„<code>TargetSource</code>å®ç°ã€‚</p>
<h4 id="6-9-3-åŸå‹ç›®æ ‡æº"><a href="#6-9-3-åŸå‹ç›®æ ‡æº" class="headerlink" title="6.9.3. åŸå‹ç›®æ ‡æº"></a>6.9.3. åŸå‹ç›®æ ‡æº</h4><p>è®¾ç½®â€œåŸå‹â€ç›®æ ‡æºç±»ä¼¼äºè®¾ç½®æ± <code>TargetSource</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½ä¼šåˆ›å»ºç›®æ ‡çš„æ–°å®ä¾‹ã€‚å°½ç®¡åœ¨ç°ä»£ JVM ä¸­åˆ›å»ºæ–°å¯¹è±¡çš„æˆæœ¬å¹¶ä¸é«˜ï¼Œä½†æ˜¯è¿æ¥æ–°å¯¹è±¡(æ»¡è¶³å…¶ IoC ä¾èµ–å…³ç³»)çš„æˆæœ¬å¯èƒ½ä¼šæ›´é«˜ã€‚å› æ­¤ï¼Œæ²¡æœ‰å……åˆ†çš„ç†ç”±å°±ä¸åº”ä½¿ç”¨æ­¤æ–¹æ³•ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ‰€ç¤ºä¿®æ”¹<code>poolTargetSource</code>å®šä¹‰(ä¸ºæ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬ä¹Ÿæ›´æ”¹äº†åç§°)ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;prototypeTargetSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.target.PrototypeTargetSource&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetBeanName&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;businessObjectTarget&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å”¯ä¸€çš„å±æ€§æ˜¯ç›®æ ‡ Bean çš„åç§°ã€‚ <code>TargetSource</code>å®ç°ä¸­ä½¿ç”¨ç»§æ‰¿æ¥ç¡®ä¿å‘½åçš„ä¸€è‡´æ€§ã€‚ä¸æ± åŒ–ç›®æ ‡æºä¸€æ ·ï¼Œç›®æ ‡ Bean å¿…é¡»æ˜¯åŸå‹ Bean å®šä¹‰ã€‚</p>
<h4 id="6-9-4-ThreadLocal-ç›®æ ‡æº"><a href="#6-9-4-ThreadLocal-ç›®æ ‡æº" class="headerlink" title="6.9.4. ThreadLocal ç›®æ ‡æº"></a>6.9.4. ThreadLocal ç›®æ ‡æº</h4><p>å¦‚æœæ‚¨éœ€è¦ä¸ºæ¯ä¸ªä¼ å…¥è¯·æ±‚(æ¯ä¸ªçº¿ç¨‹)åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™<code>ThreadLocal</code>ç›®æ ‡æºå¾ˆæœ‰ç”¨ã€‚ <code>ThreadLocal</code>çš„æ¦‚å¿µæä¾›äº† JDK èŒƒå›´çš„åŠŸèƒ½ï¼Œå¯ä»¥é€æ˜åœ°å°†èµ„æºä¸çº¿ç¨‹ä¸€èµ·å­˜å‚¨ã€‚è®¾ç½®<code>ThreadLocalTargetSource</code>ä¸å…¶ä»–ç±»å‹çš„ç›®æ ‡æºæ‰€è¯´æ˜çš„å‡ ä¹ç›¸åŒï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;threadlocalTargetSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.target.ThreadLocalTargetSource&quot;</span>&gt;</span>    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;businessObjectTarget&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Note</p>
<p><code>ThreadLocal</code>å®ä¾‹åœ¨å¤šçº¿ç¨‹å’Œå¤šç±»åŠ è½½å™¨ç¯å¢ƒä¸­ä½¿ç”¨ä¸æ­£ç¡®æ—¶ä¼šé‡åˆ°ä¸¥é‡é—®é¢˜(å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼)ã€‚æ‚¨åº”è¯¥å§‹ç»ˆè€ƒè™‘å°† threadlocal åŒ…è£…åœ¨å…¶ä»–ä¸€äº›ç±»ä¸­ï¼Œå¹¶ä¸”åˆ‡å‹¿ç›´æ¥ä½¿ç”¨<code>ThreadLocal</code>æœ¬èº«(åŒ…è£…ç±»ä¸­é™¤å¤–)ã€‚å¦å¤–ï¼Œæ‚¨åº”å§‹ç»ˆè®°ä½æ­£ç¡®è®¾ç½®å’Œå–æ¶ˆè®¾ç½®çº¿ç¨‹æœ¬åœ°èµ„æº(åœ¨åè€…ä¸­ä»…æ¶‰åŠå¯¹<code>ThreadLocal.set(null)</code>çš„è°ƒç”¨)ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½åº”è¿›è¡Œå–æ¶ˆè®¾ç½®ï¼Œå› ä¸ºä¸å–æ¶ˆè®¾ç½®å¯èƒ½ä¼šå¯¼è‡´å‡ºç°é—®é¢˜ã€‚ Spring çš„<code>ThreadLocal</code>æ”¯æŒä¸ºæ‚¨åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œåº”è¯¥å§‹ç»ˆè€ƒè™‘ä½¿ç”¨<code>ThreadLocal</code>å®ä¾‹ï¼Œè€Œæ— éœ€å…¶ä»–é€‚å½“çš„å¤„ç†ä»£ç ã€‚</p>
<h3 id="6-10-å®šä¹‰æ–°çš„å»ºè®®ç±»å‹"><a href="#6-10-å®šä¹‰æ–°çš„å»ºè®®ç±»å‹" class="headerlink" title="6.10. å®šä¹‰æ–°çš„å»ºè®®ç±»å‹"></a>6.10. å®šä¹‰æ–°çš„å»ºè®®ç±»å‹</h3><p>Spring AOP è¢«è®¾è®¡ä¸ºå¯æ‰©å±•çš„ã€‚å°½ç®¡ç›®å‰åœ¨å†…éƒ¨ä½¿ç”¨æ‹¦æˆªå®ç°ç­–ç•¥ï¼Œä½†æ˜¯é™¤äº†åœ¨å»ºè®®å‘¨å›´ï¼Œåœ¨å»ºè®®ä¹‹å‰ï¼ŒæŠ›å‡ºå»ºè®®å’Œè¿”å›å»ºè®®ä¹‹åè¿›è¡Œæ‹¦æˆªä¹‹å¤–ï¼Œè¿˜å¯ä»¥æ”¯æŒä»»æ„å»ºè®®ç±»å‹ã€‚</p>
<p><code>org.springframework.aop.framework.adapter</code>è½¯ä»¶åŒ…æ˜¯ SPI è½¯ä»¶åŒ…ï¼Œå¯åœ¨ä¸æ›´æ”¹æ ¸å¿ƒæ¡†æ¶çš„æƒ…å†µä¸‹æ·»åŠ å¯¹æ–°çš„è‡ªå®šä¹‰å»ºè®®ç±»å‹çš„æ”¯æŒã€‚è‡ªå®šä¹‰<code>Advice</code>ç±»å‹çš„å”¯ä¸€é™åˆ¶æ˜¯å®ƒå¿…é¡»å®ç°<code>org.aopalliance.aop.Advice</code>æ ‡è®°æ¥å£ã€‚</p>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.1.3.RELEASE/javadoc-api/org/springframework/aop/framework/adapter/package-frame.html">org.springframework.aop.framework.adapter</a> javadocã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/spring/" rel="tag"># spring</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/22/blog/%E5%A4%9A%E7%BB%88%E7%AB%AF%E7%BC%96%E8%BE%91/" rel="prev" title="å¤šç»ˆç«¯ç¼–è¾‘">
      <i class="fa fa-chevron-left"></i> å¤šç»ˆç«¯ç¼–è¾‘
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/22/Java/spring/Spring-overview/" rel="next" title="spring-overview">
      spring-overview <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP-%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">AOP æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringAOP-%E8%83%BD%E5%8A%9B%E5%92%8C%E7%9B%AE%E6%A0%87"><span class="nav-number">2.</span> <span class="nav-text">SpringAOP èƒ½åŠ›å’Œç›®æ ‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP-%E4%BB%A3%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">AOP ä»£ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AspectJ-%E6%94%AF%E6%8C%81"><span class="nav-number">4.</span> <span class="nav-text">@AspectJ æ”¯æŒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8-AspectJ-%E6%94%AF%E6%8C%81"><span class="nav-number">4.1.</span> <span class="nav-text">å¯ç”¨@AspectJ æ”¯æŒ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-Java-%E9%85%8D%E7%BD%AE%E5%90%AF%E7%94%A8-AspectJ-%E6%94%AF%E6%8C%81"><span class="nav-number">4.1.1.</span> <span class="nav-text">é€šè¿‡ Java é…ç½®å¯ç”¨@AspectJ æ”¯æŒ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-XML-%E9%85%8D%E7%BD%AE%E5%90%AF%E7%94%A8-AspectJ-%E6%94%AF%E6%8C%81"><span class="nav-number">4.1.2.</span> <span class="nav-text">é€šè¿‡ XML é…ç½®å¯ç”¨@AspectJ æ”¯æŒ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%E5%88%87%E9%9D%A2"><span class="nav-number">4.2.</span> <span class="nav-text">å£°æ˜ä¸€ä¸ªåˆ‡é¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">4.3.</span> <span class="nav-text">å£°æ˜åˆ‡å…¥ç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E7%9A%84%E5%88%87%E5%85%A5%E7%82%B9%E6%8C%87%E7%A4%BA%E7%AC%A6"><span class="nav-number">4.3.1.</span> <span class="nav-text">æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">4.3.2.</span> <span class="nav-text">ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E9%80%9A%E7%94%A8%E5%88%87%E5%85%A5%E7%82%B9%E5%AE%9A%E4%B9%89"><span class="nav-number">4.3.3.</span> <span class="nav-text">å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Examples"><span class="nav-number">4.3.4.</span> <span class="nav-text">Examples</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E5%A5%BD%E7%9A%84%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">4.3.5.</span> <span class="nav-text">ç¼–å†™å¥½çš„åˆ‡å…¥ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E9%80%9A%E7%9F%A5"><span class="nav-number">4.4.</span> <span class="nav-text">å£°æ˜é€šçŸ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Before-Advice"><span class="nav-number">4.4.1.</span> <span class="nav-text">Before Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#After-Returning-Advice"><span class="nav-number">4.4.2.</span> <span class="nav-text">After Returning Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#After-Throwing-Advice"><span class="nav-number">4.4.3.</span> <span class="nav-text">After Throwing Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#After-Finally-Advice"><span class="nav-number">4.4.4.</span> <span class="nav-text">After (Finally) Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Around-Advice"><span class="nav-number">4.4.5.</span> <span class="nav-text">Around Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advice-Parameters"><span class="nav-number">4.4.6.</span> <span class="nav-text">Advice Parameters</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%BD%93%E5%89%8D%E7%9A%84-JoinPoint"><span class="nav-number">4.4.6.1.</span> <span class="nav-text">è®¿é—®å½“å‰çš„ JoinPoint</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%86%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E7%BB%99Advice"><span class="nav-number">4.4.6.2.</span> <span class="nav-text">å°†å‚æ•°ä¼ é€’ç»™Advice</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%AE%AE%E5%8F%82%E6%95%B0%E5%92%8C%E6%B3%9B%E5%9E%8B"><span class="nav-number">4.4.6.3.</span> <span class="nav-text">å»ºè®®å‚æ•°å’Œæ³›å‹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A1%AE%E5%AE%9A%E5%8F%82%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="nav-number">4.4.6.4.</span> <span class="nav-text">ç¡®å®šå‚æ•°åç§°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E5%8F%82%E6%95%B0"><span class="nav-number">4.4.6.5.</span> <span class="nav-text">å¤„ç†å‚æ•°</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advice-Ordering"><span class="nav-number">4.4.7.</span> <span class="nav-text">Advice Ordering</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Introductions"><span class="nav-number">4.5.</span> <span class="nav-text">Introductions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%87%E9%9D%A2%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.5.1.</span> <span class="nav-text">åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP-%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.5.2.</span> <span class="nav-text">AOP ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%9E%B6%E6%9E%84%E7%9A%84-AOP-%E6%94%AF%E6%8C%81"><span class="nav-number">5.</span> <span class="nav-text">åŸºäºæ¶æ„çš„ AOP æ”¯æŒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%E5%88%87%E9%9D%A2-1"><span class="nav-number">5.1.</span> <span class="nav-text">å£°æ˜ä¸€ä¸ªåˆ‡é¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%88%87%E5%85%A5%E7%82%B9-1"><span class="nav-number">5.2.</span> <span class="nav-text">å£°æ˜åˆ‡å…¥ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8EAdvice"><span class="nav-number">5.3.</span> <span class="nav-text">å£°æ˜Advice</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Before-Advice-1"><span class="nav-number">5.3.1.</span> <span class="nav-text">Before Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%BB%BA%E8%AE%AE%E5%90%8E"><span class="nav-number">5.3.2.</span> <span class="nav-text">è¿”å›å»ºè®®å</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E5%87%BA%E5%BB%BA%E8%AE%AE%E5%90%8E"><span class="nav-number">5.3.3.</span> <span class="nav-text">æå‡ºå»ºè®®å</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%90%8E-%E5%BB%BA%E8%AE%AE%E5%90%8E"><span class="nav-number">5.3.4.</span> <span class="nav-text">(æœ€å)å»ºè®®å</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Around-Advice-1"><span class="nav-number">5.3.5.</span> <span class="nav-text">Around Advice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advice-Parameters-1"><span class="nav-number">5.3.6.</span> <span class="nav-text">Advice Parameters</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advice-Ordering-1"><span class="nav-number">5.3.7.</span> <span class="nav-text">Advice Ordering</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Introductions-1"><span class="nav-number">5.4.</span> <span class="nav-text">Introductions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-5-%E5%88%87%E9%9D%A2%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.4.1.</span> <span class="nav-text">5.5.5. åˆ‡é¢å®ä¾‹åŒ–æ¨¡å‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-6-Advisors"><span class="nav-number">5.4.2.</span> <span class="nav-text">5.5.6. Advisors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-7-AOP-%E6%A8%A1%E5%BC%8F%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.4.3.</span> <span class="nav-text">5.5.7. AOP æ¨¡å¼ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E8%A6%81%E4%BD%BF%E7%94%A8%E7%9A%84-AOP-%E5%A3%B0%E6%98%8E%E6%A0%B7%E5%BC%8F"><span class="nav-number">6.</span> <span class="nav-text">é€‰æ‹©è¦ä½¿ç”¨çš„ AOP å£°æ˜æ ·å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-1-Spring-AOP-%E8%BF%98%E6%98%AF-Full-AspectJ%EF%BC%9F"><span class="nav-number">6.1.</span> <span class="nav-text">5.6.1. Spring AOP è¿˜æ˜¯ Full AspectJï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-2-AspectJ-%E6%88%96-Spring-AOP-%E7%9A%84-XML%EF%BC%9F"><span class="nav-number">6.2.</span> <span class="nav-text">5.6.2. @AspectJ æˆ– Spring AOP çš„ XMLï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-%E6%B7%B7%E5%90%88%E5%88%87%E9%9D%A2%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.</span> <span class="nav-text">5.7. æ··åˆåˆ‡é¢ç±»å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-8-%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">5.8. ä»£ç†æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-1-%E4%BA%86%E8%A7%A3-AOP-%E4%BB%A3%E7%90%86"><span class="nav-number">8.1.</span> <span class="nav-text">5.8.1. äº†è§£ AOP ä»£ç†</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-9-%E4%BB%A5%E7%BC%96%E7%A8%8B%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA-AspectJ-%E4%BB%A3%E7%90%86"><span class="nav-number">9.</span> <span class="nav-text">5.9. ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º@AspectJ ä»£ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-10-%E5%9C%A8-Spring-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E4%BD%BF%E7%94%A8-AspectJ"><span class="nav-number">10.</span> <span class="nav-text">5.10. åœ¨ Spring åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ AspectJ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-1-%E4%BD%BF%E7%94%A8-AspectJ-%E9%80%9A%E8%BF%87-Spring-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%9F%9F%E5%AF%B9%E8%B1%A1"><span class="nav-number">10.1.</span> <span class="nav-text">5.10.1. ä½¿ç”¨ AspectJ é€šè¿‡ Spring ä¾èµ–æ³¨å…¥åŸŸå¯¹è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-Configurable-%E5%AF%B9%E8%B1%A1"><span class="nav-number">10.1.1.</span> <span class="nav-text">å•å…ƒæµ‹è¯•@Configurable å¯¹è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">10.1.2.</span> <span class="nav-text">å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-2-AspectJ-%E7%9A%84%E5%85%B6%E4%BB%96-Spring-%E5%88%87%E9%9D%A2"><span class="nav-number">10.2.</span> <span class="nav-text">5.10.2. AspectJ çš„å…¶ä»– Spring åˆ‡é¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-3-%E4%BD%BF%E7%94%A8-Spring-IoC-%E9%85%8D%E7%BD%AE-AspectJ-Aspects"><span class="nav-number">10.3.</span> <span class="nav-text">5.10.3. ä½¿ç”¨ Spring IoC é…ç½® AspectJ Aspects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-4-%E5%9C%A8-Spring-Framework-%E4%B8%AD%E4%BD%BF%E7%94%A8-AspectJ-%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%BC%96%E7%BB%87"><span class="nav-number">10.4.</span> <span class="nav-text">5.10.4. åœ¨ Spring Framework ä¸­ä½¿ç”¨ AspectJ è¿›è¡ŒåŠ è½½æ—¶ç¼–ç»‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="nav-number">10.4.1.</span> <span class="nav-text">ç¬¬ä¸€ä¸ªä¾‹å­</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Aspects"><span class="nav-number">10.4.2.</span> <span class="nav-text">Aspects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%80%98META-INF-aop-xml%E2%80%99"><span class="nav-number">10.4.3.</span> <span class="nav-text">â€˜META-INF&#x2F;aop.xmlâ€™</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%85%E9%9C%80%E7%9A%84%E5%BA%93-JARS"><span class="nav-number">10.4.4.</span> <span class="nav-text">å¿…éœ€çš„åº“(JARS)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Configuration"><span class="nav-number">10.4.5.</span> <span class="nav-text">Spring Configuration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Environment-specific-Configuration"><span class="nav-number">10.4.6.</span> <span class="nav-text">Environment-specific Configuration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tomcat"><span class="nav-number">10.4.7.</span> <span class="nav-text">Tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#WebLogic%EF%BC%8CWebSphere%EF%BC%8CResin%EF%BC%8CGlassFish-%E5%92%8C-JBoss"><span class="nav-number">10.4.7.0.1.</span> <span class="nav-text">WebLogicï¼ŒWebSphereï¼ŒResinï¼ŒGlassFish å’Œ JBoss</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E7%94%A8-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">10.4.8.</span> <span class="nav-text">é€šç”¨ Java åº”ç”¨ç¨‹åº</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-11-%E6%9B%B4%E5%A4%9A%E8%B5%84%E6%BA%90"><span class="nav-number">11.</span> <span class="nav-text">5.11. æ›´å¤šèµ„æº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Spring-AOP-API"><span class="nav-number">12.</span> <span class="nav-text">6. Spring AOP API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-Spring-%E4%B8%AD%E7%9A%84-Pointcut-API"><span class="nav-number">12.1.</span> <span class="nav-text">6.1. Spring ä¸­çš„ Pointcut API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-1-Concepts"><span class="nav-number">12.1.1.</span> <span class="nav-text">6.1.1. Concepts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-2-%E5%88%87%E5%85%A5%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">12.1.2.</span> <span class="nav-text">6.1.2. åˆ‡å…¥ç‚¹çš„æ“ä½œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-AspectJ-%E8%A1%A8%E8%BE%BE%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">12.1.3.</span> <span class="nav-text">6.1.3. AspectJ è¡¨è¾¾åˆ‡å…¥ç‚¹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-4-%E4%BE%BF%E6%8D%B7%E5%88%87%E5%85%A5%E7%82%B9%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.1.4.</span> <span class="nav-text">6.1.4. ä¾¿æ·åˆ‡å…¥ç‚¹å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Static-Pointcuts"><span class="nav-number">12.1.4.1.</span> <span class="nav-text">Static Pointcuts</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">12.1.4.1.1.</span> <span class="nav-text">æ­£åˆ™è¡¨è¾¾å¼åˆ‡å…¥ç‚¹</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Attribute-driven-Pointcuts"><span class="nav-number">12.1.4.1.2.</span> <span class="nav-text">Attribute-driven Pointcuts</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dynamic-pointcuts"><span class="nav-number">12.1.4.2.</span> <span class="nav-text">Dynamic pointcuts</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">12.1.4.2.1.</span> <span class="nav-text">æ§åˆ¶æµåˆ‡å…¥ç‚¹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-5-%E5%88%87%E5%85%A5%E7%82%B9%E8%B6%85%E7%B1%BB"><span class="nav-number">12.1.5.</span> <span class="nav-text">6.1.5. åˆ‡å…¥ç‚¹è¶…ç±»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-6-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">12.1.6.</span> <span class="nav-text">6.1.6. è‡ªå®šä¹‰åˆ‡å…¥ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-Spring-%E5%92%A8%E8%AF%A2-API"><span class="nav-number">12.2.</span> <span class="nav-text">6.2. Spring å’¨è¯¢ API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-%E5%92%A8%E8%AF%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">12.2.1.</span> <span class="nav-text">6.2.1. å’¨è¯¢ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-Spring-%E7%9A%84%E5%BB%BA%E8%AE%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">12.2.2.</span> <span class="nav-text">6.2.2. Spring çš„å»ºè®®ç±»å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%B4%E7%BB%95%E5%BB%BA%E8%AE%AE%E8%BF%9B%E8%A1%8C%E6%8B%A6%E6%88%AA"><span class="nav-number">12.2.2.1.</span> <span class="nav-text">å›´ç»•å»ºè®®è¿›è¡Œæ‹¦æˆª</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Before-Advice-2"><span class="nav-number">12.2.2.2.</span> <span class="nav-text">Before Advice</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Throws-Advice"><span class="nav-number">12.2.2.3.</span> <span class="nav-text">Throws Advice</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%BB%BA%E8%AE%AE%E5%90%8E-1"><span class="nav-number">12.2.2.4.</span> <span class="nav-text">è¿”å›å»ºè®®å</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Introduction-Advice"><span class="nav-number">12.2.2.5.</span> <span class="nav-text">Introduction Advice</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-Spring-%E7%9A%84-Advisor-API"><span class="nav-number">12.3.</span> <span class="nav-text">6.3. Spring çš„ Advisor API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-%E4%BD%BF%E7%94%A8-ProxyFactoryBean-%E5%88%9B%E5%BB%BA-AOP-%E4%BB%A3%E7%90%86"><span class="nav-number">12.4.</span> <span class="nav-text">6.4. ä½¿ç”¨ ProxyFactoryBean åˆ›å»º AOP ä»£ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-Basics"><span class="nav-number">12.4.1.</span> <span class="nav-text">6.4.1. Basics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-JavaBean-%E5%B1%9E%E6%80%A7"><span class="nav-number">12.4.2.</span> <span class="nav-text">6.4.2. JavaBean å±æ€§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-%E5%9F%BA%E4%BA%8E-JDK-%E5%92%8C-CGLIB-%E7%9A%84%E4%BB%A3%E7%90%86"><span class="nav-number">12.4.3.</span> <span class="nav-text">6.4.3. åŸºäº JDK å’Œ CGLIB çš„ä»£ç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-4-%E4%BB%A3%E7%90%86%E6%8E%A5%E5%8F%A3"><span class="nav-number">12.4.4.</span> <span class="nav-text">6.4.4. ä»£ç†æ¥å£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-5-%E4%BB%A3%E7%90%86%E7%B1%BB"><span class="nav-number">12.4.5.</span> <span class="nav-text">6.4.5. ä»£ç†ç±»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-6-%E4%BD%BF%E7%94%A8%E2%80%9C%E5%85%A8%E5%B1%80%E2%80%9D%E9%A1%BE%E9%97%AE"><span class="nav-number">12.4.6.</span> <span class="nav-text">6.4.6. ä½¿ç”¨â€œå…¨å±€â€é¡¾é—®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-%E7%AE%80%E6%B4%81%E7%9A%84%E4%BB%A3%E7%90%86%E5%AE%9A%E4%B9%89"><span class="nav-number">12.5.</span> <span class="nav-text">6.5. ç®€æ´çš„ä»£ç†å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-%E4%BD%BF%E7%94%A8-ProxyFactory-%E4%BB%A5%E7%BC%96%E7%A8%8B%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA-AOP-%E4%BB%A3%E7%90%86"><span class="nav-number">12.6.</span> <span class="nav-text">6.6. ä½¿ç”¨ ProxyFactory ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º AOP ä»£ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-%E6%93%8D%E4%BD%9C%E5%BB%BA%E8%AE%AE%E5%AF%B9%E8%B1%A1"><span class="nav-number">12.7.</span> <span class="nav-text">6.7. æ“ä½œå»ºè®®å¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-8-%E4%BD%BF%E7%94%A8%E2%80%9C%E8%87%AA%E5%8A%A8%E4%BB%A3%E7%90%86%E2%80%9D%E5%8A%9F%E8%83%BD"><span class="nav-number">12.8.</span> <span class="nav-text">6.8. ä½¿ç”¨â€œè‡ªåŠ¨ä»£ç†â€åŠŸèƒ½</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-8-1-%E8%87%AA%E5%8A%A8%E4%BB%A3%E7%90%86-Bean-%E5%AE%9A%E4%B9%89"><span class="nav-number">12.8.1.</span> <span class="nav-text">6.8.1. è‡ªåŠ¨ä»£ç† Bean å®šä¹‰</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BeanNameAutoProxyCreator"><span class="nav-number">12.8.1.1.</span> <span class="nav-text">BeanNameAutoProxyCreator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DefaultAdvisorAutoProxyCreator"><span class="nav-number">12.8.1.2.</span> <span class="nav-text">DefaultAdvisorAutoProxyCreator</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-9-%E4%BD%BF%E7%94%A8-TargetSource-%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.9.</span> <span class="nav-text">6.9. ä½¿ç”¨ TargetSource å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-9-1-%E5%8F%AF%E7%83%AD%E4%BA%A4%E6%8D%A2%E7%9A%84%E7%9B%AE%E6%A0%87%E6%BA%90"><span class="nav-number">12.9.1.</span> <span class="nav-text">6.9.1. å¯çƒ­äº¤æ¢çš„ç›®æ ‡æº</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-9-2-%E6%B1%87%E9%9B%86%E7%9B%AE%E6%A0%87%E6%BA%90"><span class="nav-number">12.9.2.</span> <span class="nav-text">6.9.2. æ±‡é›†ç›®æ ‡æº</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-9-3-%E5%8E%9F%E5%9E%8B%E7%9B%AE%E6%A0%87%E6%BA%90"><span class="nav-number">12.9.3.</span> <span class="nav-text">6.9.3. åŸå‹ç›®æ ‡æº</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-9-4-ThreadLocal-%E7%9B%AE%E6%A0%87%E6%BA%90"><span class="nav-number">12.9.4.</span> <span class="nav-text">6.9.4. ThreadLocal ç›®æ ‡æº</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-10-%E5%AE%9A%E4%B9%89%E6%96%B0%E7%9A%84%E5%BB%BA%E8%AE%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">12.10.</span> <span class="nav-text">6.10. å®šä¹‰æ–°çš„å»ºè®®ç±»å‹</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CHENPENGBLOG"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">CHENPENGBLOG</p>
  <div class="site-description" itemprop="description">å…¨æ ˆæèµ·æ¥ï¼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail â†’ mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/yourname" title="Weibo â†’ https:&#x2F;&#x2F;weibo.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/yourname" title="StackOverflow â†’ https:&#x2F;&#x2F;stackoverflow.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CHENPENGBLOG</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
